<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Tank Iberica - Admin</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Panel de administraci√≥n de Tank Ib√©rica">
    <meta name="theme-color" content="#0f2a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tank Admin">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest-admin.json">
    
    <!-- Favicon e iconos -->
    <link rel="icon" type="image/svg+xml" href="icons/icon-admin-32.svg">
    <link rel="apple-touch-icon" href="icons/icon-admin-152.svg">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f5f5f5; }
        
        /* Login */
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0F2A2E; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-screen.hidden { display: none; }
        .login-box { background: #fff; padding: 48px; border-radius: 12px; max-width: 400px; text-align: center; }
        .login-logo { font-size: 24px; font-weight: 700; color: #0F2A2E; margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 24px; }
        .btn-google { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 14px; background: #fff; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .btn-google:hover { border-color: #0F2A2E; }
        .login-error { color: #dc2626; margin-top: 16px; display: none; padding: 12px; background: #fef2f2; border-radius: 6px; }
        .login-error.show { display: block; }
        
        /* Layout */
        .admin-container { display: none; height: 100vh; }
        .admin-container.active { display: flex; }
        .admin-sidebar { width: 240px; background: #0F2A2E; color: #E6ECEC; flex-shrink: 0; overflow-y: auto; }
        .admin-logo { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-logo h1 { font-size: 16px; margin-bottom: 4px; }
        .admin-logo p { font-size: 12px; color: #9FB1B1; }
        .admin-user { display: flex; align-items: center; gap: 8px; margin: 12px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; }
        .admin-user img { width: 28px; height: 28px; border-radius: 50%; }
        .admin-user span { font-size: 12px; color: #C9D4D4; }
        .btn-logout { width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: none; color: #C9D4D4; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-logout:hover { background: rgba(255,255,255,0.15); }
        
        /* Nav */
        .admin-nav { padding: 16px 0; }
        .nav-item { display: block; width: 100%; padding: 10px 20px; background: none; border: none; color: #C9D4D4; text-align: left; cursor: pointer; font-size: 13px; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-badge { display: none; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; margin-left: 8px; min-width: 18px; text-align: center; }
        .nav-badge.visible { display: inline-block; }
        .nav-cat .nav-badge { margin-left: auto; margin-right: 8px; }
        .nav-item.active { background: rgba(127,209,200,0.15); border-left-color: #7FD1C8; color: #fff; }
        .nav-cat { padding: 10px 20px; font-size: 11px; color: #9FB1B1; text-transform: uppercase; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; }
        .nav-sub { display: none; }
        .nav-sub.active { display: block; }
        .nav-sub .nav-item { padding-left: 32px; font-size: 12px; }
        .badge { background: #7FD1C8; color: #0F2A2E; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: auto; }
        
        /* Main */
        .admin-main { flex: 1; overflow-y: auto; padding: 24px; }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h2 { font-size: 20px; color: #0F2A2E; }
        
        /* Buttons */
        .btn-primary { padding: 10px 16px; background: #0F2A2E; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-primary:hover { background: #1a3d42; }
        .btn-secondary { padding: 10px 16px; background: #fff; color: #0F2A2E; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-danger { padding: 10px 16px; background: #dc2626; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-danger:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: #fff; padding: 14px; border-radius: 10px; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-card.has-pending { background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; }
        .stat-card .stat-icon { font-size: 24px; }
        .stat-card .stat-info h3 { font-size: 20px; margin: 0; }
        .stat-card .stat-info p { font-size: 11px; margin: 0; color: #6b7280; }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        
        /* Banner Status Card */
        .pending-item { padding: 8px 12px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .pending-item:hover { background: #fef9c3; transform: translateX(4px); }
        .pending-item strong { color: #dc2626; }
        
        .banner-status-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .banner-status-card.active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
        }
        .banner-status-card.inactive {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border-color: #ffc107;
        }
        .banner-status-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .banner-status-icon {
            font-size: 24px;
        }
        .banner-status-text {
            font-size: 14px;
            color: #333;
        }
        .banner-status-text strong {
            color: #0F2A2E;
        }
        .btn-banner-toggle {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .banner-status-card.active .btn-banner-toggle {
            background: #dc3545;
            color: white;
        }
        .banner-status-card.active .btn-banner-toggle:hover {
            background: #c82333;
        }
        .banner-status-card.inactive .btn-banner-toggle {
            background: #28a745;
            color: white;
        }
        .banner-status-card.inactive .btn-banner-toggle:hover {
            background: #218838;
        }
        .stat-icon { font-size: 28px; }
        .stat-info h3 { font-size: 24px; font-weight: 700; color: #0F2A2E; }
        .stat-info p { font-size: 12px; color: #888; }
        
        /* Tables */
        .table-container { background: #fff; border-radius: 10px; overflow: hidden; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .admin-table th { background: #f8f9fa; font-size: 11px; color: #888; text-transform: uppercase; }
        .admin-table td { font-size: 13px; }
        .admin-table tr:hover { background: #f8f9fa; }
        .badge-estado { padding: 4px 8px; border-radius: 12px; font-size: 11px; }
        .badge-estado.publicado { background: #d1fae5; color: #065f46; }
        .badge-estado.oculto { background: #f3f4f6; color: #6b7280; }
        .badge-estado.nuevo { background: #fef3c7; color: #92400e; }
        .table-actions { display: flex; gap: 6px; }
        .table-actions button { padding: 4px 8px; background: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; min-width: 32px; min-height: 28px; }
        .highlight-row { background: #fef9c3 !important; }
        .empty { text-align: center; color: #888; padding: 40px !important; }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #0F2A2E; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox-label input { width: auto; }
        .filters-bar { display: flex; gap: 12px; margin-bottom: 16px; }
        .filters-bar input { flex: 1; max-width: 300px; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; }
        .filters-bar select { padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        .modal.active { display: flex !important; }
        .modal-content { background: #fff; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        .modal-body { padding: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 20px; border-top: 1px solid #e0e0e0; }
        
        /* Images */
        .image-upload { border: 2px dashed #ccc; padding: 24px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 12px; }
        .image-upload:hover { border-color: #0F2A2E; }
        .images-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
        .img-preview { position: relative; aspect-ratio: 16/10; border-radius: 8px; overflow: hidden; background: #e5e7eb; cursor: pointer; transition: transform 0.2s; }
        .img-preview:hover { transform: scale(1.02); }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .img-preview .remove { position: absolute; top: 6px; right: 6px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .img-preview .remove:hover { background: #b91c1c; }
        .img-preview.portada { border: 3px solid #7FD1C8; box-shadow: 0 0 0 2px #0F2A2E; }
        .img-preview .portada-label { position: absolute; bottom: 6px; left: 6px; background: #0F2A2E; color: #fff; font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: 600; }
        
        /* Preview de documentos */
        .doc-preview { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f3f4f6; border-radius: 6px; margin-bottom: 6px; }
        .doc-preview span { font-size: 13px; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 80px); }
        .doc-preview .remove { background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .doc-preview .remove:hover { background: #b91c1c; }
        .doc-preview .edit-name { background: #3b82f6; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 5px; }
        .doc-preview .edit-name:hover { background: #2563eb; }
        .doc-preview input.doc-name-edit { flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 12px; margin-right: 5px; }
        #docsPreview { margin-top: 10px; }
        
        /* Selector de Estado con Sem√°foro */
        .estado-selector { display: flex; gap: 10px; flex-wrap: wrap; }
        .estado-option { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 10px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s;
            background: #fff;
        }
        .estado-option:hover { border-color: #9ca3af; }
        .estado-option input { display: none; }
        .estado-option.selected { border-width: 2px; }
        .estado-option .estado-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            flex-shrink: 0;
        }
        .estado-option .estado-label { font-size: 13px; font-weight: 500; }
        
        /* Colores de estado */
        .estado-option.publicado .estado-dot { background: #22c55e; }
        .estado-option.publicado.selected { border-color: #22c55e; background: #f0fdf4; }
        .estado-option.oculto .estado-dot { background: #9ca3af; }
        .estado-option.oculto.selected { border-color: #9ca3af; background: #f9fafb; }
        .estado-option.alquilado .estado-dot { background: #3b82f6; }
        .estado-option.alquilado.selected { border-color: #3b82f6; background: #eff6ff; }
        .estado-option.taller .estado-dot { background: #ef4444; }
        .estado-option.taller.selected { border-color: #ef4444; background: #fef2f2; }
        .estado-option.disponible .estado-dot { background: #22c55e; }
        .estado-option.disponible.selected { border-color: #22c55e; background: #f0fdf4; }
        .estado-option.reservado .estado-dot { background: #f59e0b; }
        .estado-option.reservado.selected { border-color: #f59e0b; background: #fffbeb; }
        .estado-option.vendido .estado-dot { background: #166534; }
        .estado-option.vendido.selected { border-color: #166534; background: #dcfce7; }
        
        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; color: #fff; font-size: 13px; z-index: 10001; animation: slideIn 0.3s; }
        .toast.success { background: #059669; }
        .toast.error { background: #dc2626; }
        .toast.info { background: #0F2A2E; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .dashboard-card { background: #fff; padding: 20px; border-radius: 10px; }
        .dashboard-card h3 { font-size: 14px; margin-bottom: 12px; color: #0F2A2E; }
        .dashboard-card .info { color: #888; font-size: 13px; }
        
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 12px; }
        .filtro-item { padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; }
        .filtro-item label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
        .filtro-item input { width: 100%; padding: 6px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; }
        
        .btn-add-caract { background: #0F2A2E; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 8px; }
        .btn-add-caract:hover { background: #1a3d42; }
        #caracteristicasContainer { margin-top: 10px; }
        .caract-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .caract-row input { flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px; }
        .caract-row input:first-child { max-width: 40%; }
        .caract-row .btn-remove-caract { background: #dc2626; color: #fff; border: none; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
        .caract-row .btn-remove-caract:hover { background: #b91c1c; }
        
        /* Filtros avanzados tabla veh√≠culos */
        .filters-bar-advanced { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; align-items: center; }
        .filters-bar-advanced input[type="text"] { flex: 1; min-width: 200px; max-width: 300px; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; }
        .filter-group-inline { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8f9fa; border-radius: 6px; }
        .filter-group-inline label { font-size: 12px; color: #555; white-space: nowrap; display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .filter-group-inline input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        .filter-group-inline select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .filter-separator { width: 1px; height: 24px; background: #ddd; }
        
        /* Bot√≥n configurar tabla */
        .btn-config-tabla { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            padding: 6px 10px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: all 0.2s;
            margin-left: 8px;
        }
        .btn-config-tabla:hover { background: #e9ecef; border-color: #adb5bd; }
        
        /* Modal configuraci√≥n tabla */
        .config-tabla-content { display: flex; gap: 20px; min-height: 400px; }
        .config-tabla-sidebar { width: 200px; border-right: 1px solid #eee; padding-right: 15px; }
        .config-tabla-sidebar button { 
            display: block; 
            width: 100%; 
            text-align: left; 
            padding: 10px 12px; 
            margin-bottom: 5px; 
            border: none; 
            background: #f8f9fa; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 13px;
        }
        .config-tabla-sidebar button:hover { background: #e9ecef; }
        .config-tabla-sidebar button.active { background: #0F2A2E; color: #fff; }
        .config-tabla-main { flex: 1; padding-left: 15px; }
        
        /* Lista de columnas/grupos arrastrables */
        .sortable-list { list-style: none; padding: 0; margin: 0; }
        .sortable-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px 12px; 
            margin-bottom: 6px; 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 6px; 
            cursor: grab;
        }
        .sortable-item:hover { background: #e9ecef; }
        .sortable-item.dragging { opacity: 0.5; background: #d1ecf1; }
        .sortable-item .drag-handle { 
            color: #adb5bd; 
            font-size: 16px; 
            cursor: grab;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .sortable-item .drag-handle:hover {
            background: #dee2e6;
            color: #495057;
        }
        .sortable-item:active .drag-handle {
            cursor: grabbing;
        }
        .sortable-item .item-name { flex: 1; font-size: 13px; }
        .sortable-item .item-actions { display: flex; gap: 5px; }
        .sortable-item .item-actions button { 
            padding: 4px 8px; 
            font-size: 11px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        
        /* Grupo editable */
        .grupo-edit-form { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .grupo-edit-form .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .grupo-edit-form .form-row > div { flex: 1; }
        .grupo-edit-form label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .grupo-edit-form input, .grupo-edit-form select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .grupo-elementos-list { 
            max-height: 250px; 
            overflow-y: auto; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            padding: 12px; 
            margin-top: 10px; 
            background: #fff;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        .grupo-elementos-list label { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px; 
            font-size: 12px; 
            cursor: pointer; 
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            transition: all 0.15s ease;
        }
        .grupo-elementos-list label:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        .grupo-elementos-list label:has(input:checked) {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .grupo-elementos-list input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #10b981;
        }
        
        /* Columna con fallback */
        .fallback-list { background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 11px; }
        .fallback-list span { display: block; padding: 2px 0; color: #856404; }
        
        /* Tabla ordenable */
        .admin-table th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
        .admin-table th.sortable:hover { background: #eef1f4; }
        .admin-table th.sortable::after { content: '‚áÖ'; position: absolute; right: 6px; opacity: 0.3; font-size: 10px; }
        .admin-table th.sortable.asc::after { content: '‚Üë'; opacity: 1; }
        .admin-table th.sortable.desc::after { content: '‚Üì'; opacity: 1; }
        .admin-table td.num { text-align: right; font-family: monospace; }
        .admin-table td.center { text-align: center; }
        .admin-table .tick-ok { color: #059669; }
        .admin-table .tick-no { color: #ccc; }
        .admin-table .fecha-prox { color: #f59e0b; font-weight: 500; }
        .admin-table .fecha-venc { color: #dc2626; font-weight: 500; }
        .admin-table a.doc-link { color: #0F2A2E; text-decoration: none; }
        .admin-table a.doc-link:hover { text-decoration: underline; }
        .admin-table .mant-link { color: #0F2A2E; cursor: pointer; }
        .admin-table .mant-link:hover { text-decoration: underline; }
        .table-container { overflow-x: auto; }
        .admin-table.compact th, .admin-table.compact td { padding: 8px 10px; font-size: 12px; }
        .admin-table .img-thumb { width: 50px; height: 32px; object-fit: cover; border-radius: 4px; }
        
        /* Opciones avanzadas en modal */
        .opciones-avanzadas { margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 16px; }
        .opciones-avanzadas-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 12px; }
        .opciones-avanzadas-header h4 { font-size: 14px; color: #0F2A2E; margin: 0; }
        .opciones-avanzadas-header .toggle-icon { font-size: 18px; transition: transform 0.3s; }
        .opciones-avanzadas-header.open .toggle-icon { transform: rotate(180deg); }
        .opciones-avanzadas-content { display: none; padding: 16px; background: #fafafa; border-radius: 6px; }
        .opciones-avanzadas-content.open { display: block; }
        .opciones-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0; }
        .opciones-section:last-child { border-bottom: none; margin-bottom: 0; }
        .opciones-section h5 { font-size: 13px; color: #555; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Mini tabla mantenimiento */
        .mant-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .mant-table th, .mant-table td { padding: 8px; border: 1px solid #e0e0e0; font-size: 12px; }
        .mant-table th { background: #f0f0f0; font-weight: 500; }
        .mant-table input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .mant-table input[type="file"] { padding: 4px; font-size: 11px; }
        .mant-table .btn-remove-row { background: #dc2626; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .mant-table .btn-view-file { background: #2563eb; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; text-decoration: none; }
        
        /* Modal Transacci√≥n */
        .trans-info { background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .trans-info strong { color: var(--petrol-blue); }
        .trans-tipo-btns { display: flex; gap: 12px; margin-bottom: 20px; }
        .trans-tipo-btn { flex: 1; padding: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; }
        .trans-tipo-btn:hover { border-color: var(--petrol-blue); background: #f0f9ff; }
        .trans-tipo-btn.active { border-color: var(--petrol-blue); background: var(--petrol-blue); color: #fff; }
        .trans-form { padding: 16px; background: #f8fafc; border-radius: 8px; }
        .trans-form .form-row { display: flex; gap: 12px; }
        .trans-form .form-row .form-group { flex: 1; }
        .trans-form .form-group { margin-bottom: 12px; }
        .trans-form label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #555; }
        .trans-form input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .trans-form input[type="file"] { padding: 8px; }
        .alert-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 6px; font-size: 13px; }
        
        /* Balance Styles */
        .balance-summary { margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; }
        .balance-totals { display: flex; gap: 20px; flex-wrap: wrap; }
        .balance-total { flex: 1; min-width: 150px; padding: 16px; border-radius: 8px; text-align: center; }
        .balance-total.ingreso { background: #dcfce7; border: 1px solid #86efac; }
        .balance-total.gasto { background: #fee2e2; border: 1px solid #fca5a5; }
        .balance-total.neto { background: #dbeafe; border: 1px solid #93c5fd; }
        .balance-total .label { display: block; font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .balance-total .value { display: block; font-size: 24px; font-weight: 700; }
        .balance-total.ingreso .value { color: #16a34a; }
        .balance-total.gasto .value { color: #dc2626; }
        .balance-total.neto .value { color: #2563eb; }
        .balance-desglose-toggle { margin-top: 16px; display: flex; align-items: center; justify-content: space-between; }
        .balance-desglose-toggle label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .balance-desglose { margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .desglose-item { padding: 12px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; }
        .desglose-item .razon { font-weight: 500; font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .desglose-item .valores { display: flex; justify-content: space-between; font-size: 12px; }
        .desglose-item .ingresos { color: #16a34a; }
        .desglose-item .gastos { color: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Tipo badges en Balance */
        .tipo-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .tipo-badge.ingreso { background: #dcfce7; color: #16a34a; }
        .tipo-badge.gasto { background: #fee2e2; color: #dc2626; }
        
        /* Estado badges */
        .estado-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .estado-badge.pendiente { background: #fef3c7; color: #92400e; }
        .estado-badge.pagado, .estado-badge.cobrado { background: #dcfce7; color: #16a34a; }
        .mant-total { margin-top: 8px; text-align: right; font-weight: 600; font-size: 14px; }
        .btn-add-mant { margin-top: 8px; padding: 6px 12px; background: #0F2A2E; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
        
        /* Categor√≠as checkboxes */
        .categorias-checks { display: flex; gap: 16px; margin-top: 6px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        
        /* Equipamiento grid */
        .equipamiento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; padding: 12px; background: #f8f9fa; border-radius: 6px; }
        .equip-item { padding: 8px 12px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; transition: all 0.2s; }
        .equip-item:hover { border-color: #0F2A2E; }
        .equip-item input:checked + span { color: #0F2A2E; font-weight: 500; }
        
        /* Coste total box */
        .coste-total-box { margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #0F2A2E 0%, #1a3d42 100%); border-radius: 8px; color: #fff; text-align: center; }
        .coste-total-box strong { font-size: 18px; }
        .coste-total-box small { display: block; margin-top: 4px; opacity: 0.8; }
        
        /* Sidebar colapsable */
        .admin-sidebar { transition: width 0.3s ease; position: relative; }
        .nav-icon { font-size: 16px; margin-right: 8px; }
        .nav-text { transition: opacity 0.2s; }
        .nav-arrow { margin-left: auto; font-size: 10px; }
        .admin-sidebar.collapsed { width: 60px; }
        .admin-sidebar.collapsed .admin-logo h1, 
        .admin-sidebar.collapsed .admin-logo p, 
        .admin-sidebar.collapsed .admin-user span, 
        .admin-sidebar.collapsed .nav-text,
        .admin-sidebar.collapsed .nav-arrow,
        .admin-sidebar.collapsed .badge,
        .admin-sidebar.collapsed .btn-logout { display: none; }
        .admin-sidebar.collapsed .nav-item { padding: 14px 0; text-align: center; justify-content: center; }
        .admin-sidebar.collapsed .nav-item .nav-icon { margin-right: 0; font-size: 20px; }
        .admin-sidebar.collapsed .admin-logo { padding: 15px 10px; text-align: center; }
        .admin-sidebar.collapsed .admin-user { justify-content: center; padding: 8px 0; }
        .admin-sidebar.collapsed .admin-user img { width: 36px; height: 36px; }
        .admin-sidebar.collapsed .nav-cat { padding: 14px 0; justify-content: center; }
        .admin-sidebar.collapsed .nav-cat .nav-icon { font-size: 20px; margin-right: 0; display: inline-block; }
        .admin-sidebar.collapsed .nav-sub { display: none; }
        .admin-sidebar.collapsed .nav-sub.active { display: block; }
        .admin-sidebar.collapsed .nav-sub .nav-item { padding: 12px 0; }
        .admin-sidebar.collapsed .nav-sub .nav-item .nav-icon { font-size: 18px; }
        .admin-sidebar.collapsed .btn-toggle-sidebar { padding: 10px 0; }
        .admin-sidebar.collapsed .btn-toggle-sidebar .toggle-text { display: none; }
        .btn-toggle-sidebar { width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: #C9D4D4; cursor: pointer; font-size: 14px; margin-top: 10px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-toggle-sidebar:hover { background: rgba(255,255,255,0.2); }
        
        /* Fullscreen table */
        .table-fullscreen { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: #fff; padding: 20px; overflow: auto; }
        .table-fullscreen .table-container { max-height: calc(100vh - 100px); }
        .btn-fullscreen { padding: 6px 12px; background: #6b7280; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 10px; }
        .btn-fullscreen:hover { background: #4b5563; }
        .btn-export { padding: 6px 12px; background: #059669; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 10px; }
        .btn-export:hover { background: #047857; }
        
        /* Modal Exportar */
        .export-section { margin-bottom: 20px; }
        .export-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #0F2A2E; }
        .export-options { display: flex; gap: 20px; }
        .export-excludes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .radio-label input[type="radio"] { accent-color: #0F2A2E; }
        
        /* Badges de categor√≠as m√∫ltiples */
        .cat-badges { display: flex; gap: 4px; flex-wrap: wrap; }
        .cat-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500; }
        .cat-badge.venta { background: #dbeafe; color: #1e40af; }
        .cat-badge.alquiler { background: #fef3c7; color: #92400e; }
        .cat-badge.terceros { background: #f3e8ff; color: #7c3aed; }
        .cat-badge.exportacion { background: #d1fae5; color: #047857; }
        .mini-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .mini-table th, .mini-table td { padding: 4px 8px; border: 1px solid #ddd; font-size: 11px; text-align: left; }
        /* Chat Admin */
        .chat-admin-container { display: flex; gap: 20px; height: 500px; }
        .chat-list { width: 300px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; overflow-y: auto; }
        .chat-list-item { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; }
        .chat-list-item:hover { background: #f9fafb; }
        .chat-list-item.active { background: #ecfdf5; border-left: 3px solid #10b981; }
        .chat-list-item.unread { background: #fef3c7; }
        .chat-list-item h4 { margin: 0 0 4px 0; font-size: 14px; color: #1f2937; }
        .chat-list-item p { margin: 0; font-size: 12px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item .time { font-size: 11px; color: #9ca3af; }
        .chat-list-item .badge-unread { background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
        .chat-detail { flex: 1; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; flex-direction: column; }
        .chat-detail-header { padding: 16px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #1f2937; }
        .chat-detail-messages { flex: 1; padding: 16px; overflow-y: auto; background: #f9fafb; }
        .chat-detail-input { padding: 16px; border-top: 1px solid #e5e7eb; }
        .chat-detail-input textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; resize: none; }
        .chat-msg { margin-bottom: 12px; max-width: 80%; }
        .chat-msg.user { margin-left: auto; }
        .chat-msg.admin { margin-right: auto; }
        .chat-msg .bubble { padding: 10px 14px; border-radius: 12px; }
        .chat-msg.user .bubble { background: #0A4D68; color: white; border-bottom-right-radius: 4px; }
        .chat-msg.admin .bubble { background: #e5e7eb; color: #1f2937; border-bottom-left-radius: 4px; }
        .chat-msg .meta { font-size: 11px; color: #9ca3af; margin-top: 4px; }
    </style>
    <!-- Librer√≠as para exportaci√≥n -->
    <script src="sanitize.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">TANK IBERICA</div>
            <p class="login-subtitle">Panel de Administraci√≥n</p>
            <button class="btn-google" onclick="iniciarLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Acceder con Google
            </button>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <div class="admin-container" id="adminContainer">
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-logo">
                <h1>TANK IBERICA</h1>
                <p>Panel Admin</p>
                <div class="admin-user">
                    <img id="userPhoto" src="" alt="">
                    <span id="userName">Usuario</span>
                </div>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                <button class="btn-toggle-sidebar" onclick="toggleSidebar()"><span class="toggle-icon">‚óÄ</span><span class="toggle-text">Contraer</span></button>
            </div>
            <nav class="admin-nav">
                <button class="nav-item active" data-section="dashboard"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></button>
                
                <div class="nav-cat" onclick="toggleNav(this)"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Configuracion</span><span class="nav-badge" id="badgeConfig"></span> <span class="nav-arrow">‚ñ∂</span></div>
                <div class="nav-sub">
                    <button class="nav-item" data-section="subcategorias"><span class="nav-icon">üìã</span><span class="nav-text">Subcategorias</span></button>
                    <button class="nav-item" data-section="filtros"><span class="nav-icon">üîç</span><span class="nav-text">Filtros</span></button>
                    <button class="nav-item" data-section="banner"><span class="nav-icon">üîî</span><span class="nav-text">Banner</span></button>
                </div>
                
                <div class="nav-cat" onclick="toggleNav(this)"><span class="nav-icon">üöõ</span><span class="nav-text">Catalogo</span><span class="nav-badge" id="badgeCatalogo"></span> <span class="nav-arrow">‚ñº</span></div>
                <div class="nav-sub active">
                    <button class="nav-item" data-section="vehiculos"><span class="nav-icon">üöö</span><span class="nav-text">Vehiculos</span></button>
                    <button class="nav-item" data-section="intermediacion"><span class="nav-icon">ü§ù</span><span class="nav-text">Intermediacion</span></button>
                    <button class="nav-item" data-section="ojeados"><span class="nav-icon">üëÅÔ∏è</span><span class="nav-text">Ojeados</span><span class="nav-badge" id="badgeOjeados"></span></button>
                    <button class="nav-item" data-section="anunciantes"><span class="nav-icon">üì¢</span><span class="nav-text">Anunciantes</span><span class="nav-badge" id="badgeAnunciantes"></span></button>
                    <button class="nav-item" data-section="solicitantes"><span class="nav-icon">üîé</span><span class="nav-text">Solicitantes</span><span class="nav-badge" id="badgeSolicitantes"></span></button>
                </div>
                
                <button class="nav-item" data-section="balance"><span class="nav-icon">üí∞</span><span class="nav-text">Balance</span></button>
                <button class="nav-item" data-section="historico"><span class="nav-icon">üìú</span><span class="nav-text">Historico</span></button>
                
                <div class="nav-cat" onclick="toggleNav(this)"><span class="nav-icon">üì∞</span><span class="nav-text">Comunicacion</span><span class="nav-badge" id="badgeComunicacion"></span> <span class="nav-arrow">‚ñ∂</span></div>
                <div class="nav-sub">
                    <button class="nav-item" data-section="posts"><span class="nav-icon">üìù</span><span class="nav-text">Posts</span></button>
                    <button class="nav-item" data-section="comentarios"><span class="nav-icon">üí¨</span><span class="nav-text">Comentarios</span> <span class="badge" id="badgeCom">0</span></button>
                </div>
                <div class="nav-cat" onclick="toggleNav(this)"><span class="nav-icon">üë•</span><span class="nav-text">Usuarios</span><span class="nav-badge" id="badgeUsuarios"></span> <span class="nav-arrow">‚ñ∂</span></div>
                <div class="nav-sub">
                    <button class="nav-item" data-section="usuarios"><span class="nav-icon">üë§</span><span class="nav-text">Usuarios</span></button>
                    <button class="nav-item" data-section="chat"><span class="nav-icon">üí¨</span><span class="nav-text">Chat</span><span class="nav-badge" id="badgeChat"></span></button>
                    <button class="nav-item" data-section="suscripciones"><span class="nav-icon">üìß</span><span class="nav-text">Suscripciones</span></button>
                </div>
            </nav>
        </aside>
        <main class="admin-main">
            <!-- Dashboard -->
            <section id="section-dashboard" class="admin-section active">
                <div class="section-header"><h2>üìä Dashboard</h2></div>
                
                <!-- Banner Status Card -->
                <div class="banner-status-card" id="bannerStatusCard" style="margin-bottom:20px">
                    <div class="banner-status-info">
                        <span class="banner-status-icon" id="bannerStatusIcon">üîî</span>
                        <div class="banner-status-text">
                            <strong>Banner:</strong> <span id="bannerStatusText">Cargando...</span>
                        </div>
                    </div>
                    <button class="btn-banner-toggle" id="btnToggleBanner" onclick="toggleBannerRapido()">
                        Activar
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" id="cardVeh" onclick="goSection('vehiculos')" style="cursor:pointer"><div class="stat-icon">üöõ</div><div class="stat-info"><h3 id="sVeh">0</h3><p>Veh√≠culos</p></div></div>
                    <div class="stat-card" id="cardAnu" onclick="goSection('anunciantes')" style="cursor:pointer"><div class="stat-icon">üì¢</div><div class="stat-info"><h3 id="sAnu">0</h3><p>Anunciantes</p></div></div>
                    <div class="stat-card" id="cardSol" onclick="goSection('solicitantes')" style="cursor:pointer"><div class="stat-icon">üîé</div><div class="stat-info"><h3 id="sSol">0</h3><p>Solicitantes</p></div></div>
                    <div class="stat-card" id="cardChat" onclick="goSection('chat')" style="cursor:pointer"><div class="stat-icon">‚úâÔ∏è</div><div class="stat-info"><h3 id="sChat">0</h3><p>Chats</p></div></div>
                    <div class="stat-card" id="cardCom" onclick="goSection('comentarios')" style="cursor:pointer"><div class="stat-icon">üí¨</div><div class="stat-info"><h3 id="sCom">0</h3><p>Comentarios</p></div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card"><h3>‚ö†Ô∏è Pendientes</h3><div id="pendientes"><p class="info">Cargando...</p></div></div>
                    <div class="dashboard-card"><h3>üîó Matches</h3><div id="matches"><p class="info">Cargando...</p></div></div>
                </div>
            </section>
            
            <!-- Vehiculos -->
            <section id="section-vehiculos" class="admin-section">
                <div class="section-header">
                    <div><h2>üöö Veh√≠culos</h2></div>
                    <div>
                        <button class="btn-export" onclick="abrirModalExportar()">üì• Exportar</button>
                        <button class="btn-fullscreen" id="btnFullscreen" onclick="toggleFullscreen()">‚õ∂ Pantalla completa</button>
                        <button class="btn-primary" onclick="abrirModalVehiculo()">+ Nuevo</button>
                    </div>
                </div>
                
                <!-- Filtros avanzados -->
                <div class="filters-bar-advanced">
                    <input type="text" id="buscarVeh" placeholder="üîç Buscar..." oninput="filtrarVeh()">
                    
                    <div class="filter-group-inline">
                        <label><input type="checkbox" id="filtroVenta" checked onchange="filtrarVeh()"> Venta</label>
                        <label><input type="checkbox" id="filtroAlquiler" checked onchange="filtrarVeh()"> Alquiler</label>
                        <label><input type="checkbox" id="filtroTerceros" checked onchange="filtrarVeh()"> Terceros</label>
                    </div>
                    
                    <div class="filter-separator"></div>
                    
                    <div class="filter-group-inline">
                        <select id="filtroSubcat" onchange="filtrarVeh()">
                            <option value="">Todas subcategor√≠as</option>
                        </select>
                    </div>
                    
                    <div class="filter-separator"></div>
                    
                    <div class="filter-group-inline" id="gruposTableContainer">
                        <!-- Los grupos se cargar√°n din√°micamente -->
                        <span style="color:#888;font-size:12px">Cargando grupos...</span>
                    </div>
                    
                    <button type="button" class="btn-config-tabla" onclick="abrirConfigTabla()" title="Configurar tabla">
                        ‚öôÔ∏è
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="admin-table compact" id="tablaVehiculos">
                        <thead id="theadVeh"></thead>
                        <tbody id="tVeh"><tr><td colspan="20" class="empty">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Intermediaci√≥n (Base de datos interna - NO se publica en web) -->
            <section id="section-intermediacion" class="admin-section">
                <div class="section-header">
                    <div>
                        <h2>ü§ù Intermediaci√≥n</h2>
                        <small style="color:#6b7280;font-weight:normal;">Base de datos interna - No se publica en la web</small>
                    </div>
                    <div>
                        <button class="btn-config-tabla" onclick="abrirConfigTablaInter()" title="Configurar tabla">‚öôÔ∏è</button>
                        <button class="btn-secondary" onclick="toggleFullscreen('section-intermediacion')">‚õ∂</button>
                        <button class="btn-export" onclick="abrirModalExportarInter()">üì• Exportar</button>
                        <button class="btn-primary" onclick="abrirModalIntermediacion()">+ Nuevo</button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="filters-bar-advanced">
                    <input type="text" id="buscarInter" placeholder="üîç Buscar..." oninput="filtrarInter()">
                    
                    <div class="filter-group-inline">
                        <select id="filtroInterEstado" onchange="filtrarInter()">
                            <option value="">Todos los estados</option>
                            <option value="disponible">Disponible</option>
                            <option value="reservado">Reservado</option>
                            <option value="vendido">Vendido</option>
                            <option value="alquilado">Alquilado</option>
                        </select>
                    </div>
                    
                    <div class="filter-separator"></div>
                    
                    <div class="filter-group-inline">
                        <select id="filtroInterSubcat" onchange="filtrarInter()">
                            <option value="">Todas las subcategor√≠as</option>
                        </select>
                    </div>
                    
                    <div class="filter-separator"></div>
                    
                    <!-- Checkbox mostrar veh√≠culos -->
                    <div class="filter-group-inline">
                        <label title="Mostrar tambi√©n veh√≠culos propios" style="background:#e0f2fe;padding:4px 8px;border-radius:4px">
                            <input type="checkbox" id="mostrarVehEnInter" onchange="toggleMostrarVehInter()"> + Veh√≠culos
                        </label>
                    </div>
                    
                    <div class="filter-separator"></div>
                    
                    <!-- Grupos din√°micos de columnas -->
                    <div class="filter-group-inline" id="gruposInterContainer">
                        <!-- Se renderiza din√°micamente -->
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="admin-table compact" id="tablaIntermediacion">
                        <thead id="theadInter"></thead>
                        <tbody id="tInter"><tr><td colspan="20" class="empty">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Ojeados (productos vistos en otras plataformas) -->
            <section id="section-ojeados" class="admin-section">
                <div class="section-header">
                    <div>
                        <h2>üëÅÔ∏è Ojeados</h2>
                        <small style="color:#6b7280;font-weight:normal;">Productos vistos en otras plataformas</small>
                    </div>
                    <div>
                        <button class="btn-config-tabla" onclick="abrirConfigPlataformas()" title="Configurar plataformas">‚öôÔ∏è</button>
                        <button class="btn-secondary" onclick="toggleFullscreen('section-ojeados')">‚õ∂</button>
                        <button class="btn-export" onclick="abrirModalExportarOjeados()">üì• Exportar</button>
                        <button class="btn-primary" onclick="abrirModalOjeado()">+ Nuevo</button>
                    </div>
                </div>
                
                <!-- Panel de configuraci√≥n de plataformas (oculto por defecto) -->
                <div id="configPlataformasPanel" style="display:none;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;margin-bottom:15px">
                    <h4 style="margin:0 0 10px 0">‚öôÔ∏è Configurar Plataformas</h4>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px" id="plataformasLista"></div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <input type="text" id="nuevaPlataforma" placeholder="Nueva plataforma..." style="flex:1;padding:8px">
                        <button class="btn-primary" onclick="agregarPlataforma()">+ A√±adir</button>
                        <button class="btn-secondary" onclick="cerrarConfigPlataformas()">Cerrar</button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="filters-bar-advanced">
                    <input type="text" id="buscarOjeado" placeholder="üîç Buscar..." oninput="filtrarOjeados()">
                    
                    <div class="filter-group-inline">
                        <select id="filtroOjeadoEstado" onchange="filtrarOjeados()">
                            <option value="">Todos los estados</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="contactado">Contactado</option>
                            <option value="negociando">Negociando</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-inline">
                        <select id="filtroOjeadoPlataforma" onchange="filtrarOjeados()">
                            <option value="">Todas las plataformas</option>
                            <!-- Se cargan din√°micamente -->
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="admin-table compact" id="tablaOjeados">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>PRODUCTO</th>
                                <th>PLATAFORMA</th>
                                <th>ENLACE</th>
                                <th>PRECIO</th>
                                <th>NEGOCIADO</th>
                                <th>TEL√âFONO</th>
                                <th>EMAIL</th>
                                <th>ESTADO</th>
                                <th>ACC</th>
                            </tr>
                        </thead>
                        <tbody id="tOjeados"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Subcategorias -->
            <section id="section-subcategorias" class="admin-section">
                <div class="section-header"><h2>üìã Subcategor√≠as</h2><button class="btn-primary" onclick="abrirModalSubcat()">+ Nueva</button></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Nombre</th><th>Filtros aplicables</th><th>Stock</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tSub"><tr><td colspan="6" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Filtros -->
            <section id="section-filtros" class="admin-section">
                <div class="section-header"><h2>üîç Filtros</h2><button class="btn-primary" onclick="abrirModalFiltro()">+ Nuevo</button></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Extra ‚úÖ</th><th>Ocultar üö´</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tFil"><tr><td colspan="7" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Anunciantes -->
            <section id="section-anunciantes" class="admin-section">
                <div class="section-header"><h2>üì¢ Anunciantes</h2></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Nombre</th><th>Contacto</th><th>Veh√≠culo</th><th>Precio</th><th>Fecha</th><th>Estado</th><th>Acc</th></tr></thead><tbody id="tAnu"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Solicitantes -->
            <section id="section-solicitantes" class="admin-section">
                <div class="section-header"><h2>üîé Solicitantes</h2></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Nombre</th><th>Contacto</th><th>Requisitos</th><th>Fecha</th><th>Match</th><th>Estado</th><th>Acc</th></tr></thead><tbody id="tSol"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Posts -->
            <section id="section-posts" class="admin-section">
                <div class="section-header"><h2>üìù Posts</h2><button class="btn-primary" onclick="toast('En desarrollo','info')">+ Nuevo</button></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Img</th><th>T√≠tulo</th><th>Cat</th><th>Fecha</th><th>Vistas</th><th>Estado</th><th>Acc</th></tr></thead><tbody id="tPos"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Comentarios -->
            <section id="section-comentarios" class="admin-section">
                <div class="section-header"><h2>üí¨ Comentarios</h2></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Post</th><th>Autor</th><th>Texto</th><th>Fecha</th><th>Estado</th><th>Acc</th></tr></thead><tbody id="tCom"><tr><td colspan="7" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Banner -->
            <section id="section-banner" class="admin-section">
                <div class="section-header"><h2>üîî Banner</h2></div>
                <div class="dashboard-card" style="max-width:700px">
                    <div class="form-group">
                        <label>Texto Espa√±ol</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="text" id="bannerEs" placeholder="Texto del aviso en espa√±ol" style="flex:1">
                            <button type="button" class="btn-secondary" onclick="toggleEmojiPicker('bannerEs')" title="A√±adir emoji" style="padding:8px 12px">üòÄ</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Texto Ingl√©s</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="text" id="bannerEn" placeholder="Banner text in English" style="flex:1">
                            <button type="button" class="btn-secondary" onclick="toggleEmojiPicker('bannerEn')" title="Add emoji" style="padding:8px 12px">üòÄ</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>URL enlace (opcional)</label>
                        <input type="url" id="bannerUrl" placeholder="https://...">
                        <p style="font-size:11px;color:#888;margin-top:4px">Si a√±ades URL, aparecer√° "M√°s informaci√≥n" / "More info" al final del texto</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Publicar desde (opcional)</label>
                            <input type="datetime-local" id="bannerDesde">
                            <p style="font-size:11px;color:#888;margin-top:4px">Vac√≠o = activo inmediatamente</p>
                        </div>
                        <div class="form-group">
                            <label>Publicar hasta (opcional)</label>
                            <input type="datetime-local" id="bannerHasta">
                            <p style="font-size:11px;color:#888;margin-top:4px">Vac√≠o = sin fecha de fin</p>
                        </div>
                    </div>
                    <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="bannerActivo"><span>Banner activo</span></label></div>
                    <div style="display:flex;gap:10px;margin-top:16px"><button class="btn-primary" onclick="guardarBanner()">üíæ Guardar</button><button class="btn-secondary" onclick="previewBanner()">üëÅÔ∏è Preview</button></div>
                </div>
            </section>
            
            <!-- Usuarios -->
            <section id="section-usuarios" class="admin-section">
                <div class="section-header"><h2>üë§ Usuarios</h2></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>ID</th><th>Pseudo</th><th>Nombre</th><th>Email</th><th>Registro</th><th>Estado</th><th>Acc</th></tr></thead><tbody id="tUsu"><tr><td colspan="7" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Chat -->
            <section id="section-chat" class="admin-section">
                <div class="section-header">
                    <h2>üí¨ Chat con Usuarios</h2>
                    <button class="btn-secondary" onclick="cargarChats()">üîÑ Actualizar</button>
                </div>
                <div class="chat-admin-container">
                    <div class="chat-list" id="chatList">
                        <p class="empty-state">No hay conversaciones pendientes</p>
                    </div>
                    <div class="chat-detail" id="chatDetail">
                        <div class="chat-detail-header" id="chatDetailHeader" style="display:flex;justify-content:space-between;align-items:center;">
                            <span id="chatDetailTitle">Selecciona una conversaci√≥n</span>
                            <div class="chat-actions" id="chatActions" style="display:none;gap:8px;">
                                <button class="btn-secondary" onclick="borrarChatAdmin()" title="Borrar solo para admin" style="padding:6px 12px;font-size:12px;">üóëÔ∏è Borrar (admin)</button>
                                <button class="btn-secondary" onclick="borrarChatUsuario()" title="Borrar solo para usuario" style="padding:6px 12px;font-size:12px;">üóëÔ∏è Borrar (usuario)</button>
                                <button class="btn-danger" onclick="borrarChatAmbos()" title="Borrar para ambos" style="padding:6px 12px;font-size:12px;">üóëÔ∏è Borrar todo</button>
                            </div>
                        </div>
                        <div class="chat-detail-messages" id="chatDetailMessages">
                            <p class="empty-state">Selecciona un usuario para ver la conversaci√≥n</p>
                        </div>
                        <div class="chat-detail-input" id="chatDetailInput" style="display:none">
                            <textarea id="chatAdminInput" placeholder="Escribe tu respuesta..." rows="3"></textarea>
                            <button class="btn-primary" onclick="enviarRespuestaChat()">Enviar respuesta</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Suscripciones -->
            <section id="section-suscripciones" class="admin-section">
                <div class="section-header"><h2>üìß Suscripciones</h2></div>
                <div class="table-container"><table class="admin-table"><thead><tr><th>Email</th><th>Web</th><th>Prensa</th><th>Bolet√≠n</th><th>Dest</th><th>Event</th><th>Resp</th><th>Fecha</th></tr></thead><tbody id="tSus"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody></table></div>
            </section>
            
            <!-- Balance -->
            <section id="section-balance" class="admin-section">
                <div class="section-header" style="flex-direction:column;align-items:stretch;gap:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h2 style="margin:0;">üí∞ Balance</h2>
                        <div style="display:flex;gap:8px;">
                            <button class="btn-secondary" onclick="toggleFullscreen('section-balance')">‚õ∂</button>
                            <button class="btn-secondary" onclick="exportarBalance()">üì• Exportar</button>
                            <button class="btn-primary" onclick="abrirModalBalance()">‚ûï Nueva Transacci√≥n</button>
                            <button class="btn-primary" onclick="abrirModalFactura()" style="background:#7c3aed;">üßæ Generar Factura</button>
                        </div>
                    </div>
                    <div class="header-actions" style="flex-wrap:wrap;gap:8px;">
                        <input type="text" id="balanceSearch" placeholder="üîç Buscar..." onkeyup="filterBalance()" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;width:150px;">
                        <select id="balanceYearFilter" onchange="filterBalance()" style="padding:6px;"><option value="">A√±o</option></select>
                        <select id="balanceTipoFilter" onchange="filterBalance()" style="padding:6px;"><option value="">Tipo</option><option value="ingreso">‚Üë Ingresos</option><option value="gasto">‚Üì Gastos</option></select>
                        <select id="balanceRazonFilter" onchange="filterBalance()" style="padding:6px;"><option value="">Raz√≥n</option><option value="Venta">Venta</option><option value="Alquiler">Alquiler</option><option value="Exportacion">Export</option><option value="Compra">Compra</option><option value="Taller">Taller</option><option value="Documentacion">Doc</option><option value="Servicios">Serv</option><option value="Salario">Salario</option><option value="Seguro">Seguro</option><option value="Dividendos">Divid</option><option value="Almacenamiento">Almac</option><option value="Bancario">Banco</option><option value="Efectivo">Efect</option><option value="Otros">Otros</option></select>
                        <select id="balanceEstadoFilter" onchange="filterBalance()" style="padding:6px;"><option value="">Estado</option><option value="pendiente">Pendiente</option><option value="pagado">Pagado</option><option value="cobrado">Cobrado</option></select>
                        <select id="balanceSubcatFilter" onchange="filterBalance()" style="padding:6px;"><option value="">Subcategor√≠a</option></select>
                    </div>
                </div>
                <div class="table-container" id="balanceTableContainer">
                    <table class="admin-table" id="balanceTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortBalance('tipo')">Tipo</th>
                                <th class="sortable" onclick="sortBalance('fecha')">Fecha</th>
                                <th class="sortable" onclick="sortBalance('razon')">Raz√≥n</th>
                                <th>Detalle</th>
                                <th>Subcat</th>
                                <th class="sortable" onclick="sortBalance('importe')">Importe</th>
                                <th>Ben.%</th>
                                <th>Factura</th>
                                <th>Estado</th>
                                <th>ACC</th>
                            </tr>
                        </thead>
                        <tbody id="tBalance"><tr><td colspan="10" class="empty">Cargando...</td></tr></tbody>
                    </table>
                </div>
                
                <!-- Resumen Balance -->
                <div class="balance-summary" id="balanceSummary">
                    <div class="balance-totals">
                        <div class="balance-total ingreso">
                            <span class="label">Total Ingresos</span>
                            <span class="value" id="totalIngresos">0 ‚Ç¨</span>
                        </div>
                        <div class="balance-total gasto">
                            <span class="label">Total Gastos</span>
                            <span class="value" id="totalGastos">0 ‚Ç¨</span>
                        </div>
                        <div class="balance-total neto">
                            <span class="label">Balance Neto</span>
                            <span class="value" id="balanceNeto">0 ‚Ç¨</span>
                        </div>
                    </div>
                    <div class="balance-desglose-toggle">
                        <label><input type="checkbox" id="toggleDesglose" onchange="toggleDesglose()"> Desglose</label>
                        <label style="margin-left:15px;"><input type="checkbox" id="toggleGraficos" onchange="toggleGraficos()"> Gr√°ficos</label>
                        <select id="tipoGrafico" onchange="renderGraficos()" style="padding:4px;font-size:12px;margin-left:10px;"><option value="bar">Barras</option><option value="pie">Circular</option></select>
                        <label style="margin-left:15px;"><input type="checkbox" id="incluirGraficosExport"> Incluir en export</label>
                        <button class="btn-secondary btn-sm" onclick="exportarResumen()">üì• Exportar Resumen</button>
                    </div>
                    <div id="balanceGraficos" style="display:none;margin-top:15px;padding:15px;background:#f9fafb;border-radius:8px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                            <div style="background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
                                <h4 style="margin:0 0 10px;font-size:13px;color:#0F2A2E;">Ingresos vs Gastos por Raz√≥n</h4>
                                <canvas id="chartRazon" height="200"></canvas>
                            </div>
                            <div style="background:white;padding:15px;border-radius:8px;border:1px solid #e5e7eb;">
                                <h4 style="margin:0 0 10px;font-size:13px;color:#0F2A2E;">Beneficio % por Subcategor√≠a</h4>
                                <canvas id="chartSubcat" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="balance-desglose" id="balanceDesglose" style="display:none">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </section>
            
            <!-- Hist√≥rico -->
            <section id="section-historico" class="admin-section">
                <div class="section-header">
                    <h2>üìú Hist√≥rico</h2>
                    <div class="header-actions">
                        <input type="text" id="historicoSearch" placeholder="üîç Buscar..." onkeyup="filterHistorico()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;width:180px;">
                        <select id="historicoYearFilter" onchange="filterHistorico()">
                            <option value="">Todos los a√±os</option>
                        </select>
                        <select id="historicoSubcatFilter" onchange="filterHistorico()">
                            <option value="">Todas subcategor√≠as</option>
                        </select>
                        <select id="historicoMarcaFilter" onchange="filterHistorico()">
                            <option value="">Todas las marcas</option>
                        </select>
                        <button class="btn-secondary" onclick="toggleFullscreen('section-historico')">‚õ∂</button>
                        <button class="btn-secondary" onclick="exportarHistorico()">üì• Exportar</button>
                    </div>
                </div>
                <div class="col-toggles" style="margin-bottom:10px">
                    <span style="font-size:12px;color:#666;margin-right:8px">Categor√≠a:</span>
                    <label><input type="checkbox" id="histCatVenta" checked onchange="filterHistorico()"> Venta</label>
                    <label><input type="checkbox" id="histCatTerceros" checked onchange="filterHistorico()"> Terceros</label>
                    <label><input type="checkbox" id="histCatExportacion" checked onchange="filterHistorico()"> Exportaci√≥n</label>
                    <span style="margin-left:20px;font-size:12px;color:#666;margin-right:8px">Columnas:</span>
                    <label><input type="checkbox" id="histColDocs" onchange="renderHistorico()"> DOCS</label>
                    <label><input type="checkbox" id="histColTecnico" onchange="renderHistorico()"> T√âCNICO</label>
                    <label><input type="checkbox" id="histColAlquiler" onchange="renderHistorico()"> ALQUILER</label>
                </div>
                <div class="table-container" id="historicoTableContainer">
                    <table class="admin-table" id="historicoTable">
                        <thead id="historicoThead">
                            <!-- Se genera din√°micamente -->
                        </thead>
                        <tbody id="tHistorico"><tr><td colspan="20" class="empty">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Vehiculo -->
    <div class="modal" id="modalVehiculo">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header"><h3 id="modalVehTitle">Nuevo Veh√≠culo</h3><button class="modal-close" onclick="cerrarModal('modalVehiculo')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="vehId"><input type="hidden" id="vehRow">
                
                <!-- ESTADO (PRIMERO) -->
                <div class="form-group">
                    <label>Estado</label>
                    <div class="estado-selector" id="estadoSelector">
                        <label class="estado-option publicado" onclick="setEstadoVeh('publicado')">
                            <input type="radio" name="vehEstadoRadio" value="publicado">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Publicado</span>
                        </label>
                        <label class="estado-option oculto" onclick="setEstadoVeh('oculto')">
                            <input type="radio" name="vehEstadoRadio" value="oculto">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Oculto</span>
                        </label>
                        <label class="estado-option alquilado" onclick="setEstadoVeh('alquilado')">
                            <input type="radio" name="vehEstadoRadio" value="alquilado">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Alquilado</span>
                        </label>
                        <label class="estado-option taller" onclick="setEstadoVeh('taller')">
                            <input type="radio" name="vehEstadoRadio" value="taller">
                            <span class="estado-dot"></span>
                            <span class="estado-label">En Taller</span>
                        </label>
                    </div>
                    <input type="hidden" id="vehEstado" value="publicado">
                </div>
                
                <!-- IM√ÅGENES -->
                <div class="form-group">
                    <label>Im√°genes (m√°x 10)</label>
                    <div class="image-upload" onclick="document.getElementById('vehImgInput').click()">üì∑ Click para subir</div>
                    <input type="file" id="vehImgInput" multiple accept="image/*" style="display:none" onchange="handleImages(event)">
                    <div class="images-preview" id="imgPreview"></div>
                </div>
                
                <!-- CATEGOR√çAS Y SUBCATEGOR√çA -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Categor√≠as *</label>
                        <div class="categorias-checks">
                            <label class="checkbox-label"><input type="checkbox" id="vehCatVenta" onchange="updateCategorias()"><span>Venta</span></label>
                            <label class="checkbox-label"><input type="checkbox" id="vehCatAlquiler" onchange="updateCategorias()"><span>Alquiler</span></label>
                            <label class="checkbox-label"><input type="checkbox" id="vehCatTerceros" onchange="updateCategorias()"><span>Terceros</span></label>
                        </div>
                    </div>
                    <div class="form-group"><label>Subcategor√≠a *</label><select id="vehSubcat"><option value="">Seleccionar</option></select></div>
                </div>
                
                <!-- MARCA, MODELO, A√ëO -->
                <div class="form-row">
                    <div class="form-group"><label>Marca *</label><input type="text" id="vehMarca" placeholder="Scania"></div>
                    <div class="form-group"><label>Modelo *</label><input type="text" id="vehModelo" placeholder="R450"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>A√±o *</label><input type="number" id="vehAno" placeholder="2023"></div>
                    <div class="form-group"><label>Matr√≠cula</label><input type="text" id="vehMatricula" placeholder="1234-ABC"></div>
                </div>
                
                <!-- PRECIOS -->
                <div class="form-row">
                    <div class="form-group" id="precioVentaGroup"><label>Precio Venta ‚Ç¨</label><input type="number" id="vehPrecio" placeholder="0 = Consultar"></div>
                    <div class="form-group" id="precioAlquilerGroup" style="display:none"><label>Precio Alquiler ‚Ç¨/mes</label><input type="number" id="vehPrecioAlquiler" placeholder="0 = Consultar"></div>
                </div>
                
                <!-- UBICACI√ìN -->
                <div class="form-row">
                    <div class="form-group"><label>Ubicaci√≥n ES</label><input type="text" id="vehUbic" placeholder="Madrid, Espa√±a"></div>
                    <div class="form-group"><label>Ubicaci√≥n EN</label><input type="text" id="vehUbicEn" placeholder="Madrid, Spain"></div>
                </div>
                
                <!-- DESCRIPCI√ìN -->
                <div class="form-group"><label>Descripci√≥n ES (300 car)</label><textarea id="vehDesc" rows="2" maxlength="300"></textarea></div>
                <div class="form-group"><label>Descripci√≥n EN</label><textarea id="vehDescEn" rows="2" maxlength="300"></textarea></div>
                
                <!-- FILTROS DIN√ÅMICOS -->
                <div class="form-group"><label>Filtros</label><div class="filtros-grid" id="filtrosGrid"></div></div>
                
                <!-- CARACTER√çSTICAS ADICIONALES -->
                <div class="form-group">
                    <label>Caracter√≠sticas adicionales <button type="button" class="btn-add-caract" onclick="addCaracteristica()">+ A√±adir</button></label>
                    <div id="caracteristicasContainer"></div>
                </div>
                
                <!-- DOCUMENTACI√ìN -->
                <div class="form-group">
                    <label>Documentos (subir a Drive)</label>
                    <div class="image-upload" onclick="document.getElementById('vehDocsInput').click()">üìÑ Click para subir documentos</div>
                    <input type="file" id="vehDocsInput" multiple style="display:none" onchange="handleDocs(event)">
                    <div id="docsPreview" style="margin-top:8px;font-size:12px;color:#666"></div>
                    <input type="hidden" id="vehDocumentacion">
                </div>
                
                <hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb">
                
                <!-- CUENTAS -->
                <h4 style="margin:0 0 15px 0;color:#374151">üí∞ Cuentas</h4>
                <div class="form-row">
                    <div class="form-group"><label>Precio m√≠nimo ‚Ç¨</label><input type="number" id="vehPrecioMin" placeholder="Precio m√≠nimo aceptable"></div>
                    <div class="form-group"><label>Coste adquisici√≥n ‚Ç¨</label><input type="number" id="vehCoste" placeholder="Coste de compra"></div>
                </div>
                <div class="form-group"><label>Fecha adquisici√≥n</label><input type="date" id="vehAdquisicion"></div>
                
                <div class="form-group">
                    <label>Mantenimiento (suma) <button type="button" class="btn-add-mant" onclick="addFilaMant()">+ A√±adir</button></label>
                    <table class="mant-table" id="mantTable">
                        <thead><tr><th>Fecha</th><th>Raz√≥n</th><th>Coste ‚Ç¨</th><th>Factura</th><th></th></tr></thead>
                        <tbody id="mantBody"></tbody>
                    </table>
                    <div class="mant-total">Total Mant: <span id="mantTotal">0</span> ‚Ç¨</div>
                </div>
                
                <div class="form-group">
                    <label>Renta (resta) <button type="button" class="btn-add-mant" onclick="addFilaRenta()">+ A√±adir</button></label>
                    <table class="mant-table" id="rentaTable">
                        <thead><tr><th>Desde</th><th>Hasta</th><th>Raz√≥n</th><th>Importe ‚Ç¨</th><th>Factura</th><th></th></tr></thead>
                        <tbody id="rentaBody"></tbody>
                    </table>
                    <div class="mant-total">Total Renta: <span id="rentaTotal">0</span> ‚Ç¨</div>
                </div>
                
                <div class="coste-total-box">
                    <strong>COSTE TOTAL: <span id="costeTotalCalc">0</span> ‚Ç¨</strong>
                    <small>(Coste + Mant - Renta)</small>
                </div>
                
            </div>
            <div class="modal-footer"><button class="btn-secondary" onclick="cerrarModal('modalVehiculo')">Cancelar</button><button class="btn-primary" onclick="guardarVehiculo()">üíæ Guardar</button></div>
        </div>
    </div>

    <!-- Modal Exportar -->
    <div class="modal" id="modalExportar">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>üì• Exportar Veh√≠culos</h3><button class="modal-close" onclick="cerrarModal('modalExportar')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Veh√≠culos</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportDatos" value="todo" checked><span>Todos los veh√≠culos</span></label>
                        <label class="radio-label"><input type="radio" name="exportDatos" value="filtros"><span>Solo activos (filtrados)</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportColumnas" value="todas" checked><span>Todas las columnas</span></label>
                        <label class="radio-label"><input type="radio" name="exportColumnas" value="activas"><span>Solo activas (visibles)</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Excluir de la exportaci√≥n</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="exclId"><span>ID</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclImg"><span>Imagen</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclCat"><span>Categor√≠a</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclSubcat"><span>Subcategor√≠a</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclPrecio"><span>Precio</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclEstado"><span>Estado</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="exclAcc" checked><span>Acciones</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportar')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacion()">üì• Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal Exportar Balance -->
    <div class="modal" id="modalExportarBalance">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>üì• Exportar Balance</h3><button class="modal-close" onclick="cerrarModal('modalExportarBalance')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportBalanceFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportBalanceFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Datos</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportBalanceDatos" value="todo" checked><span>Todas las transacciones</span></label>
                        <label class="radio-label"><input type="radio" name="exportBalanceDatos" value="filtros"><span>Solo filtradas (a√±o/tipo)</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas a incluir</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expBalTipo" checked><span>Tipo</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalFecha" checked><span>Fecha</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalRazon" checked><span>Raz√≥n</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalDetalle" checked><span>Detalle</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalImporte" checked><span>Importe</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalEstado" checked><span>Estado</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expBalNotas"><span>Notas</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportarBalance')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacionBalance()">üì• Exportar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Exportar Resumen Balance -->
    <div class="modal" id="modalExportarResumen">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>üì• Exportar Resumen</h3><button class="modal-close" onclick="cerrarModal('modalExportarResumen')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportResumenFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportResumenFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Per√≠odo</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportResumenPeriodo" value="filtro" checked><span>A√±o seleccionado en filtro</span></label>
                        <label class="radio-label"><input type="radio" name="exportResumenPeriodo" value="todo"><span>Todos los a√±os</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Incluir</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expResTotales" checked><span>Totales (Ingresos/Gastos/Neto)</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expResDesglose" checked><span>Desglose por raz√≥n</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expResMensual"><span>Desglose mensual</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportarResumen')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacionResumen()">üì• Exportar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Exportar Hist√≥rico -->
    <div class="modal" id="modalExportarHistorico">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header"><h3>üì• Exportar Hist√≥rico</h3><button class="modal-close" onclick="cerrarModal('modalExportarHistorico')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportHistoricoFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportHistoricoFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Datos</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportHistoricoDatos" value="todo" checked><span>Todo el hist√≥rico</span></label>
                        <label class="radio-label"><input type="radio" name="exportHistoricoDatos" value="filtros"><span>Solo filtrados (a√±o/categor√≠a)</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas b√°sicas</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expHistId" checked><span>ID</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistMarca" checked><span>Marca</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistMatricula" checked><span>Matr√≠cula</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistAno" checked><span>A√±o</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistCategoria" checked><span>Categor√≠a</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistSubcat"><span>Subcategor√≠a</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistTipo"><span>Tipo</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas DOCS</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expHistImg"><span>Imagen</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistDocs"><span>Documentaci√≥n</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas T√âCNICO</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expHistModelo"><span>Modelo</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistVolCap"><span>Vol/Capacidad</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistComp"><span>Compartimentos</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistEjes"><span>Ejes</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistBC"><span>B/C</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistDD"><span>DD</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistEXO"><span>Exolum</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHist44tn"><span>44tn</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistADR"><span>ADR</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistATP"><span>ATP</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistITV"><span>ITV</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistEtiq"><span>Etiqueta</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas financieras</h4>
                    <div class="export-excludes">
                        <label class="checkbox-label"><input type="checkbox" id="expHistPrecio" checked><span>Precio</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistCoste"><span>Coste</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistMant"><span>Mantenimiento</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistAlquiler"><span>Alquiler</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistCosteTotal"><span>Coste Total</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistAdquis"><span>Adquisici√≥n</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistFechaVenta" checked><span>Fecha Venta</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistPrecioVenta" checked><span>Precio Venta</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistBeneficio" checked><span>Beneficio</span></label>
                        <label class="checkbox-label"><input type="checkbox" id="expHistComprador" checked><span>Comprador</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportarHistorico')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacionHistorico()">üì• Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar -->
    <div class="modal" id="modalConfirm">
        <div class="modal-content" style="max-width:380px">
            <div class="modal-header"><h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3><button class="modal-close" onclick="cerrarModal('modalConfirm')">√ó</button></div>
            <div class="modal-body">
                <p id="confirmMsg">¬øEst√°s seguro de que deseas eliminar este elemento?</p>
                <p id="delInfo" style="margin-top:8px;padding:10px;background:#fef2f2;border-radius:6px;color:#991b1b;font-size:13px;font-weight:500"></p>
                <p style="margin-top:12px">Escribe <strong style="color:#dc2626">Borrar</strong> para confirmar:</p>
                <input type="text" id="confirmInput" placeholder="Escribe Borrar" style="margin-top:8px;width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                <input type="hidden" id="delTipo"><input type="hidden" id="delRow">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalConfirm')">Cancelar</button>
                <button class="btn-danger" id="btnConfirmDel" onclick="confirmarBorrar()" disabled>Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Transacci√≥n (Alquilado/Venta) -->
    <div class="modal" id="modalTransaccion">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header"><h3>üí∂ Registrar Transacci√≥n</h3><button class="modal-close" onclick="cerrarModal('modalTransaccion')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="transVehIdx">
                <div class="trans-info" id="transVehInfo"></div>
                
                <div class="trans-tipo-btns">
                    <button type="button" class="trans-tipo-btn" id="btnTransAlquiler" onclick="setTipoTransaccion('alquiler')">üîë Alquilado</button>
                    <button type="button" class="trans-tipo-btn" id="btnTransVenta" onclick="setTipoTransaccion('venta')">üí∞ Venta</button>
                </div>
                
                <!-- Formulario Alquiler -->
                <div class="trans-form" id="formTransAlquiler" style="display:none">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" id="transAlqDesde">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" id="transAlqHasta">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Raz√≥n / Cliente</label>
                        <input type="text" id="transAlqRazon" placeholder="Ej: Alquiler a Empresa XYZ">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Importe ‚Ç¨</label>
                            <input type="number" id="transAlqPrecio" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Factura</label>
                            <input type="file" id="transAlqFactura" accept="image/*,.pdf">
                        </div>
                    </div>
                </div>
                
                <!-- Formulario Venta -->
                <div class="trans-form" id="formTransVenta" style="display:none">
                    <div class="export-check-box" style="background:#ecfdf5;border:1px solid #10b981;border-radius:8px;padding:12px;margin-bottom:16px">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin:0">
                            <input type="checkbox" id="transVentaExportacion" style="width:18px;height:18px">
                            <span style="font-weight:500">üåç Exportaci√≥n (venta internacional)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Fecha de venta</label>
                        <input type="date" id="transVentaFecha">
                    </div>
                    <div class="form-group">
                        <label>Raz√≥n / Comprador</label>
                        <input type="text" id="transVentaRazon" placeholder="Ej: Vendido a Cliente ABC">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio Venta ‚Ç¨</label>
                            <input type="number" id="transVentaPrecio" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Factura</label>
                            <input type="file" id="transVentaFactura" accept="image/*,.pdf">
                        </div>
                    </div>
                    <div class="alert alert-warning" style="margin-top:15px">
                        ‚ö†Ô∏è Al registrar la venta, el veh√≠culo se mover√° a <strong>Hist√≥rico</strong> y se eliminar√° del cat√°logo activo.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalTransaccion')">Cancelar</button>
                <button class="btn-primary" id="btnGuardarTrans" onclick="guardarTransaccion()" disabled>üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Balance (Nueva Transacci√≥n) -->
    <div class="modal" id="modalBalance">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header"><h3 id="modalBalanceTitle">‚ûï Nueva Transacci√≥n</h3><button class="modal-close" onclick="cerrarModal('modalBalance')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="balanceId">
                <input type="hidden" id="balanceRow">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo *</label>
                        <select id="balanceTipo" onchange="updateBalanceRazonOptions()">
                            <option value="ingreso">‚Üë Ingreso</option>
                            <option value="gasto">‚Üì Gasto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="balanceFecha">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Raz√≥n *</label>
                    <select id="balanceRazon">
                        <option value="Venta">Venta</option>
                        <option value="Alquiler">Alquiler</option>
                        <option value="Exportacion">Exportaci√≥n</option>
                        <option value="Compra">Compra</option>
                        <option value="Taller">Taller</option>
                        <option value="Documentacion">Documentaci√≥n</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Salario">Salario</option><option value="Seguro">Seguro</option>
                        <option value="Dividendos">Dividendos</option>
                        <option value="Almacenamiento">Almacenamiento</option>
                        <option value="Bancario">Bancario</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Detalle</label>
                    <input type="text" id="balanceDetalle" placeholder="Ej: Cisterna MAN 1234ABC (2020)">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Importe ‚Ç¨ *</label>
                        <input type="number" id="balanceImporte" placeholder="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="balanceEstado">
                            <option value="pendiente">Pendiente</option>
                            <option value="pagado">Pagado</option>
                            <option value="cobrado">Cobrado</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Factura/Recibo</label>
                    <input type="file" id="balanceFactura" accept="image/*,.pdf">
                    <input type="hidden" id="balanceFacturaUrl">
                </div>
                
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="balanceNotas" rows="2" placeholder="Notas adicionales..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalBalance')">Cancelar</button>
                <button class="btn-primary" onclick="guardarBalance()">üíæ Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Restaurar Veh√≠culo -->
    <div class="modal" id="modalRestaurar">
        <div class="modal-content" style="max-width:380px">
            <div class="modal-header"><h3>üîÑ Restaurar Veh√≠culo</h3><button class="modal-close" onclick="cerrarModal('modalRestaurar')">√ó</button></div>
            <div class="modal-body">
                <p id="restaurarMsg">¬øDeseas restaurar este veh√≠culo al cat√°logo activo?</p>
                <p style="margin-top:12px">Escribe <strong style="color:#16a34a">Restaurar</strong> para confirmar:</p>
                <input type="text" id="restaurarInput" placeholder="Escribe Restaurar" style="margin-top:8px;width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                <input type="hidden" id="restaurarIdx">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalRestaurar')">Cancelar</button>
                <button class="btn-primary" id="btnConfirmRestaurar" onclick="confirmarRestaurar()" disabled>Restaurar</button>
            </div>
        </div>
    </div>

    <!-- Modal Subcategoria -->
    <div class="modal" id="modalSubcat">
        <div class="modal-content" style="max-width:550px">
            <div class="modal-header"><h3 id="modalSubcatTitle">Nueva Subcategor√≠a</h3><button class="modal-close" onclick="cerrarModal('modalSubcat')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="subId"><input type="hidden" id="subRow">
                <div class="form-row">
                    <div class="form-group"><label>Nombre (ES) *</label><input type="text" id="subNombre" placeholder="Ej: Cisternas"></div>
                    <div class="form-group"><label>Nombre (EN)</label><input type="text" id="subNombreEn" placeholder="Ej: Tankers"></div>
                </div>
                <div class="form-group">
                    <label>Filtros aplicables</label>
                    <p style="font-size:11px;color:#888;margin-bottom:8px">Selecciona qu√© filtros estar√°n activos para esta subcategor√≠a. Precio, Marca, A√±o y Ubicaci√≥n siempre est√°n activos.</p>
                    <div id="subFiltrosCheck" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:200px;overflow-y:auto;padding:8px;border:1px solid #e0e0e0;border-radius:6px"></div>
                </div>
                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="subPublicado" checked><span>Publicar subcategor√≠a</span></label></div>
            </div>
            <div class="modal-footer"><button class="btn-secondary" onclick="cerrarModal('modalSubcat')">Cancelar</button><button class="btn-primary" onclick="guardarSubcat()">üíæ Guardar</button></div>
        </div>
    </div>

    <!-- Modal Exportar Intermediaci√≥n -->
    <div class="modal" id="modalExportarInter">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>üì• Exportar Intermediaci√≥n</h3><button class="modal-close" onclick="cerrarModal('modalExportarInter')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportInterFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportInterFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Datos</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportInterDatos" value="filtros" checked><span>Solo filtrados (actuales)</span></label>
                        <label class="radio-label"><input type="radio" name="exportInterDatos" value="todo"><span>Todos los registros</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Columnas</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportInterColumnas" value="activas" checked><span>Solo visibles</span></label>
                        <label class="radio-label"><input type="radio" name="exportInterColumnas" value="todas"><span>Todas las columnas</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportarInter')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacionInter()">üì• Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal Exportar Ojeados -->
    <div class="modal" id="modalExportarOjeados">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>üì• Exportar Ojeados</h3><button class="modal-close" onclick="cerrarModal('modalExportarOjeados')">√ó</button></div>
            <div class="modal-body">
                <div class="export-section">
                    <h4>Formato</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportOjeadosFormato" value="excel"><span>Excel (.xlsx)</span></label>
                        <label class="radio-label"><input type="radio" name="exportOjeadosFormato" value="pdf" checked><span>PDF</span></label>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>Datos</h4>
                    <div class="export-options">
                        <label class="radio-label"><input type="radio" name="exportOjeadosDatos" value="filtros" checked><span>Solo filtrados (actuales)</span></label>
                        <label class="radio-label"><input type="radio" name="exportOjeadosDatos" value="todo"><span>Todos los registros</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalExportarOjeados')">Cancelar</button>
                <button class="btn-primary" onclick="ejecutarExportacionOjeados()">üì• Exportar</button>
            </div>
        </div>
    </div>


    <!-- Modal Ojeado -->
    <div class="modal" id="modalOjeado">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3 id="modalOjeadoTitle">Nuevo Ojeado</h3>
                <button class="modal-close" onclick="cerrarModal('modalOjeado')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ojeadoId">
                <input type="hidden" id="ojeadoRow">
                
                <div class="form-group">
                    <label>Producto</label>
                    <input type="text" id="ojeadoProducto" placeholder="Descripcion del producto">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Plataforma</label>
                        <select id="ojeadoPlataforma" onchange="onPlataformaChange()">
                            <!-- Se carga din√°micamente -->
                        </select>
                    </div>
                    <div class="form-group" id="otraPlataformaGroup" style="display:none">
                        <label>Especificar plataforma</label>
                        <input type="text" id="ojeadoOtraPlataforma" placeholder="Nombre de la plataforma">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="ojeadoEstado">
                            <option value="inactivo">Inactivo</option>
                            <option value="contactado">Contactado</option>
                            <option value="negociando">Negociando</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Enlace</label>
                    <input type="url" id="ojeadoEnlace" placeholder="https://...">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" id="ojeadoPrecio" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Negociado</label>
                        <input type="number" id="ojeadoNegociado" placeholder="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="ojeadoTelefono" placeholder="+34...">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="ojeadoEmail" placeholder="email@...">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="ojeadoNotas" rows="2" placeholder="Notas adicionales..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalOjeado')">Cancelar</button>
                <button class="btn-primary" onclick="guardarOjeado()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Intermediaci√≥n -->
    <div class="modal" id="modalIntermediacion">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header"><h3 id="modalInterTitle">Nuevo Veh√≠culo (Intermediaci√≥n)</h3><button class="modal-close" onclick="cerrarModal('modalIntermediacion')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="interId"><input type="hidden" id="interRow">
                
                <div class="alert-info" style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin-bottom:16px;border-radius:4px;">
                    <strong>ü§ù Intermediaci√≥n:</strong> Este veh√≠culo NO se publica en la web. Es solo para gesti√≥n interna.
                </div>
                
                <!-- ESTADO (PRIMERO con sem√°foro) -->
                <div class="form-group">
                    <label>Estado</label>
                    <div class="estado-selector" id="estadoSelectorInter">
                        <label class="estado-option disponible" onclick="setEstadoInter('disponible')">
                            <input type="radio" name="interEstadoRadio" value="disponible">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Disponible</span>
                        </label>
                        <label class="estado-option reservado" onclick="setEstadoInter('reservado')">
                            <input type="radio" name="interEstadoRadio" value="reservado">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Reservado</span>
                        </label>
                        <label class="estado-option alquilado" onclick="setEstadoInter('alquilado')">
                            <input type="radio" name="interEstadoRadio" value="alquilado">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Alquilado</span>
                        </label>
                        <label class="estado-option vendido" onclick="setEstadoInter('vendido')">
                            <input type="radio" name="interEstadoRadio" value="vendido">
                            <span class="estado-dot"></span>
                            <span class="estado-label">Vendido</span>
                        </label>
                    </div>
                    <input type="hidden" id="interEstado" value="disponible">
                </div>
                
                <!-- IM√ÅGENES -->
                <div class="form-group">
                    <label>Im√°genes (m√°x 10)</label>
                    <div class="image-upload" onclick="document.getElementById('interImgInput').click()">üì∑ Click para subir</div>
                    <input type="file" id="interImgInput" multiple accept="image/*" style="display:none" onchange="handleImagesInter(event)">
                    <div class="images-preview" id="interImgPreview"></div>
                </div>
                
                <!-- SUBCATEGOR√çA -->
                <div class="form-row">
                    <div class="form-group"><label>Subcategor√≠a *</label><select id="interSubcat"><option value="">Seleccionar</option></select></div>
                    <div class="form-group"><label>Matr√≠cula</label><input type="text" id="interMatricula" placeholder="1234-ABC"></div>
                </div>
                
                <!-- MARCA, MODELO, A√ëO -->
                <div class="form-row">
                    <div class="form-group"><label>Marca *</label><input type="text" id="interMarca" placeholder="Scania"></div>
                    <div class="form-group"><label>Modelo</label><input type="text" id="interModelo" placeholder="R450"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>A√±o</label><input type="number" id="interAno" placeholder="2023"></div>
                    <div class="form-group"><label>Precio Venta ‚Ç¨</label><input type="number" id="interPrecioVenta" placeholder="0 = Consultar"></div>
                </div>
                
                <!-- UBICACI√ìN -->
                <div class="form-row">
                    <div class="form-group"><label>Ubicaci√≥n ES</label><input type="text" id="interUbicacion" placeholder="Madrid, Espa√±a"></div>
                    <div class="form-group"><label>Ubicaci√≥n EN</label><input type="text" id="interUbicacionEn" placeholder="Madrid, Spain"></div>
                </div>
                
                <!-- DESCRIPCI√ìN -->
                <div class="form-group"><label>Descripci√≥n ES</label><textarea id="interDescripcion" rows="2" maxlength="300" placeholder="Descripci√≥n del veh√≠culo..."></textarea></div>
                <div class="form-group"><label>Descripci√≥n EN</label><textarea id="interDescripcionEn" rows="2" maxlength="300"></textarea></div>
                
                <!-- PROPIETARIO (espec√≠fico de intermediaci√≥n) -->
                <div class="form-row" style="background:#f0f9ff;padding:12px;border-radius:8px;margin:15px 0">
                    <div class="form-group" style="margin:0"><label>üë§ Propietario / Contacto</label><input type="text" id="interPropietario" placeholder="Nombre del propietario"></div>
                    <div class="form-group" style="margin:0"><label>üìû Tel√©fono</label><input type="tel" id="interTelefono" placeholder="+34 600 000 000"></div>
                </div>
                
                <!-- FILTROS DIN√ÅMICOS -->
                <div class="form-group"><label>Filtros</label><div class="filtros-grid" id="filtrosGridInter"></div></div>
                
                <!-- CARACTER√çSTICAS ADICIONALES -->
                <div class="form-group">
                    <label>Caracter√≠sticas adicionales <button type="button" class="btn-add-caract" onclick="addCaracteristicaInter()">+ A√±adir</button></label>
                    <div id="caracteristicasContainerInter"></div>
                </div>
                
                <!-- NOTAS (espec√≠fico de intermediaci√≥n) -->
                <div class="form-group"><label>üìù Notas / Observaciones internas</label><textarea id="interNotas" rows="2" placeholder="Informaci√≥n adicional..."></textarea></div>
                
                <!-- DOCUMENTACI√ìN -->
                <div class="form-group">
                    <label>Documentos (subir a Drive)</label>
                    <div class="image-upload" onclick="document.getElementById('interDocsInput').click()">üìÑ Click para subir documentos</div>
                    <input type="file" id="interDocsInput" multiple style="display:none" onchange="handleDocsInter(event)">
                    <div id="docsPreviewInter" style="margin-top:8px;font-size:12px;color:#666"></div>
                </div>
                
                <hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb">
                
                <!-- CUENTAS -->
                <h4 style="margin:0 0 15px 0;color:#374151">üí∞ Cuentas</h4>
                <div class="form-row">
                    <div class="form-group"><label>Precio m√≠nimo ‚Ç¨</label><input type="number" id="interPrecioMin" placeholder="Precio m√≠nimo aceptable"></div>
                    <div class="form-group"><label>Coste adquisici√≥n ‚Ç¨</label><input type="number" id="interCoste" placeholder="Coste de compra"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Comisi√≥n %</label><input type="number" id="interComision" placeholder="10" oninput="calcularBeneficioInter()"></div>
                    <div class="form-group"><label>Fecha adquisici√≥n</label><input type="date" id="interFechaAdq"></div>
                </div>
                
                <!-- GASTOS -->
                <div class="form-group">
                    <label>Gastos (suma) <button type="button" class="btn-add-mant" onclick="addFilaGastoInter()">+ A√±adir</button></label>
                    <table class="mant-table" id="interGastosTable">
                        <thead><tr><th>Fecha</th><th>Concepto</th><th>Importe ‚Ç¨</th><th>Factura</th><th></th></tr></thead>
                        <tbody id="interGastosBody"></tbody>
                    </table>
                    <div class="mant-total">Total Gastos: <span id="interGastosTotal">0</span> ‚Ç¨</div>
                </div>
                
                <!-- INGRESOS -->
                <div class="form-group">
                    <label>Ingresos (resta) <button type="button" class="btn-add-mant" onclick="addFilaIngresoInter()">+ A√±adir</button></label>
                    <table class="mant-table" id="interIngresosTable">
                        <thead><tr><th>Desde</th><th>Hasta</th><th>Concepto</th><th>Importe ‚Ç¨</th><th>Factura</th><th></th></tr></thead>
                        <tbody id="interIngresosBody"></tbody>
                    </table>
                    <div class="mant-total">Total Ingresos: <span id="interIngresosTotal">0</span> ‚Ç¨</div>
                </div>
                
                <div class="coste-total-box">
                    <strong>BENEFICIO: <span id="interBeneficio">0</span> ‚Ç¨</strong>
                    <small id="interBeneficioFormula">(Venta - Coste - Gastos + Ingresos)</small>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalIntermediacion')">Cancelar</button>
                <button class="btn-primary" onclick="guardarIntermediacion()">üíæ Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Vender (compartido) -->
    <div class="modal" id="modalVender">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header"><h3>‚Ç¨ Registrar Venta</h3><button class="modal-close" onclick="cerrarModal('modalVender')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="venderId"><input type="hidden" id="venderTipo"><input type="hidden" id="venderRow">
                <p id="venderInfo" style="background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:15px"></p>
                
                <div class="form-group"><label>Precio venta final ‚Ç¨ *</label><input type="number" id="venderPrecio" placeholder="Precio acordado"></div>
                <div class="form-group"><label>Comprador *</label><input type="text" id="venderComprador" placeholder="Nombre o empresa"></div>
                <div class="form-group"><label>Fecha venta *</label><input type="date" id="venderFecha"></div>
                <div class="form-group" id="venderComisionGroup"><label>Comisi√≥n %</label><input type="number" id="venderComision" placeholder="10"></div>
                <div class="form-group"><label>Notas</label><textarea id="venderNotas" rows="2" placeholder="Observaciones..."></textarea></div>
                
                <div class="coste-total-box" style="margin-top:15px">
                    <strong>BENEFICIO FINAL: <span id="venderBeneficio">0</span> ‚Ç¨</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalVender')">Cancelar</button>
                <button class="btn-primary" onclick="confirmarVenta()">‚úÖ Confirmar Venta</button>
            </div>
        </div>
    </div>

    <!-- Modal Filtro -->
    <div class="modal" id="modalFiltro">
        <div class="modal-content" style="max-width:550px">
            <div class="modal-header"><h3 id="modalFiltroTitle">Nuevo Filtro</h3><button class="modal-close" onclick="cerrarModal('modalFiltro')">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="filId"><input type="hidden" id="filRow">
                <div class="form-row">
                    <div class="form-group"><label>Nombre (ES) *</label><input type="text" id="filNombre" placeholder="Ej: Volumen"></div>
                    <div class="form-group"><label>Nombre (EN)</label><input type="text" id="filNombreEn" placeholder="Ej: Volume"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo *</label>
                        <select id="filTipo" onchange="onTipoFiltroChange()">
                            <option value="">Seleccionar</option>
                            <option value="caja">Caja (texto libre)</option>
                            <option value="desplegable">Desplegable</option>
                            <option value="desplegable_tick">Desplegable con ticks</option>
                            <option value="tick">Tick (s√≠/no)</option>
                            <option value="slider">Slider (rango)</option>
                            <option value="calc">Calc (+/-)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unidad de medida</label>
                        <input type="text" id="filUnidad" placeholder="Ej: Km, Kg, L, CV...">
                    </div>
                </div>
                <div class="form-group" id="filExtraGroup" style="display:none">
                    <label>‚úÖ Extra filtros (aparecen cuando este tick est√° activo)</label>
                    <div id="filExtraCheck" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:150px;overflow-y:auto;padding:8px;border:1px solid #e0e0e0;border-radius:6px;background:#f0fff0"></div>
                </div>
                <div class="form-group" id="filOcultarGroup" style="display:none">
                    <label>üö´ Ocultar filtros (se ocultan cuando este tick est√° activo)</label>
                    <div id="filOcultarCheck" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:150px;overflow-y:auto;padding:8px;border:1px solid #e0e0e0;border-radius:6px;background:#fff0f0"></div>
                </div>
                <div class="form-group" id="filDefectoGroup">
                    <label>Valor por defecto</label>
                    <input type="text" id="filDefecto" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label>Estado del filtro</label>
                    <select id="filEstado">
                        <option value="publicado">Publicado (aparece en filtros y caracter√≠sticas)</option>
                        <option value="oculto">Oculto (solo en caracter√≠sticas del veh√≠culo)</option>
                        <option value="inactivo">Inactivo (no aparece en ning√∫n sitio)</option>
                    </select>
                </div>
                
            </div>
            <div class="modal-footer"><button class="btn-secondary" onclick="cerrarModal('modalFiltro')">Cancelar</button><button class="btn-primary" onclick="guardarFiltro()">üíæ Guardar</button></div>
        </div>
    </div>

    <!-- Modal Configuraci√≥n Tabla -->
    <div class="modal" id="modalConfigTabla">
        <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header"><h3 id="modalConfigTablaTitle">‚öôÔ∏è Configurar Tabla de Veh√≠culos</h3><button class="modal-close" onclick="cerrarModal('modalConfigTabla')">√ó</button></div>
            <div class="modal-body">
                <div class="config-tabla-content">
                    <div class="config-tabla-sidebar">
                        <button type="button" class="active" onclick="mostrarSeccionConfig('grupos')" id="btnSeccionGrupos">üìÅ Grupos</button>
                        <button type="button" onclick="mostrarSeccionConfig('columnas')" id="btnSeccionColumnas">üìä Organizar Tabla</button>
                    </div>
                    <div class="config-tabla-main" id="configTablaMain">
                        <!-- Contenido din√°mico -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('modalConfigTabla')">Cerrar</button>
                <button class="btn-primary" onclick="guardarConfigTabla()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal Factura -->
    <div class="modal" id="modalFactura">
        <div class="modal-content" style="max-width:950px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header" style="background:#0F2A2E;color:white;"><h3 style="color:white;">üßæ Generar Factura</h3><button class="modal-close" onclick="cerrarModal('modalFactura')" style="color:white;">√ó</button></div>
            <div class="modal-body">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                    <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">N¬∫ Vehiculos</label><select id="factNumVehiculos" onchange="generarSelectoresVehiculos()" style="padding:6px;width:60px;"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">Fecha</label><input type="date" id="factFecha" style="padding:6px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">Condiciones</label><input type="text" id="factCondiciones" placeholder="Pago a 30 dias" style="padding:6px;width:130px;"></div>
                    </div>
                    <label style="display:flex;align-items:center;gap:5px;font-size:13px;"><input type="checkbox" id="factIngles"> Emitir en Ingles</label>
                </div>
                <div id="factVehiculosContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:15px;"></div>
                <div class="form-group" style="margin:0 0 15px;max-width:200px;"><label style="font-size:12px;">N¬∫ Factura</label><input type="text" id="factNumero" readonly style="padding:6px;background:#f3f4f6;"></div>
                <hr style="margin:15px 0;border:none;border-top:2px solid #0F2A2E;">
                <h4 style="margin:0 0 10px;color:#0F2A2E;font-size:14px;">Facturado a:</h4>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Nombre/Empresa</label><input type="text" id="factClienteNombre" style="padding:6px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Direccion</label><input type="text" id="factClienteDir1" style="padding:6px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">CP + Ciudad</label><input type="text" id="factClienteDir2" style="padding:6px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Provincia + Pais</label><input type="text" id="factClienteDir3" style="padding:6px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Tipo Doc</label><select id="factClienteTipoDoc" style="padding:6px;"><option>NIF</option><option>DNI</option><option>Pasaporte</option><option>CIF</option></select></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Numero Doc</label><input type="text" id="factClienteDoc" style="padding:6px;"></div>
                </div>
                <hr style="margin:15px 0;border:none;border-top:2px solid #0F2A2E;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><h4 style="margin:0;color:#0F2A2E;font-size:14px;">Conceptos:</h4><button type="button" class="btn-secondary btn-sm" onclick="agregarLineaFactura()" style="font-size:11px;">+ A√±adir linea</button></div>
                <div style="display:grid;grid-template-columns:90px 1fr 55px 85px 75px 55px 75px 28px;gap:4px;margin-bottom:5px;font-size:10px;font-weight:600;color:#666;padding:0 2px;"><span>Tipo</span><span>Concepto</span><span>Cant.</span><span>Precio/Ud</span><span>Importe</span><span>IVA%</span><span>Subtotal</span><span></span></div>
                <div id="factLineas"></div>
                <hr style="margin:15px 0;border:none;border-top:2px solid #0F2A2E;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div>
                        <h4 style="margin:0 0 8px;color:#0F2A2E;font-size:14px;">Datos de pago:</h4>
                        <div class="form-group" style="margin:0 0 6px;"><label style="font-size:11px;">Metodo</label><input type="text" id="factMetodoPago" value="Transferencia bancaria" style="padding:5px;font-size:12px;"></div>
                        <div class="form-group" style="margin:0 0 6px;"><label style="font-size:11px;">Banco</label><input type="text" id="factBanco" style="padding:5px;font-size:12px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:11px;">IBAN</label><input type="text" id="factCuenta" style="padding:5px;font-size:12px;"></div>
                    </div>
                    <div style="background:#f0fdf4;padding:12px;border-radius:8px;border:2px solid #0F2A2E;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;"><span>Subtotal:</span><span id="factSubtotal">0.00 EUR</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;"><span>IVA:</span><span id="factIVATotal">0.00 EUR</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;padding-top:5px;border-top:1px solid #0F2A2E;font-size:13px;"><strong>Total:</strong><strong id="factTotal">0.00 EUR</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;"><span>Pagado:</span><span id="factPagado">0.00 EUR</span></div>
                        <div style="display:flex;justify-content:space-between;background:#0F2A2E;color:white;padding:8px;margin:5px -12px -12px;border-radius:0 0 6px 6px;font-size:14px;"><strong>A PAGAR:</strong><strong id="factTotalPagar">0.00 EUR</strong></div>
                    </div>
                </div>
                <hr style="margin:15px 0;border:none;border-top:2px solid #0F2A2E;">
                <h4 style="margin:0 0 8px;color:#0F2A2E;font-size:14px;">Datos del emisor:</h4>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Empresa</label><input type="text" id="factEmpresa" value="TANK IBERICA, S.L." style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">NIF</label><input type="text" id="factEmpresaNIF" value="B24724684" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Direccion</label><input type="text" id="factEmpresaDir1" value="Ctra. Nacional 630 (parcela El Valle) s/n" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">CP + Ciudad</label><input type="text" id="factEmpresaDir2" value="24231 Onzonilla" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Provincia + Pais</label><input type="text" id="factEmpresaDir3" value="Leon, Espana" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Telefono</label><input type="text" id="factTelefono" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Email</label><input type="text" id="factEmail" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Web</label><input type="text" id="factWeb" value="TANKIBERICA.COM" style="padding:5px;font-size:12px;"></div>
                    <div class="form-group" style="margin:0;"><label style="font-size:11px;">Logo (URL)</label><input type="text" id="factLogoUrl" value="https://lh3.googleusercontent.com/d/1LoKrBHe5pLXYdXDAhNdMTiP4Xkm_jDbD" style="padding:5px;font-size:11px;"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-secondary" onclick="cerrarModal('modalFactura')">Cancelar</button><button class="btn-primary" onclick="generarFacturaPDF()" style="background:#0F2A2E;">üßæ Generar PDF</button></div>
        </div>
    </div>

    <script>
    // ============================================
    // CONFIGURACI√ìN
    // ============================================
    const CLIENT_ID = '928575372421-rlq17ptufeppbkqs1a26o0pb97pfut0a.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
    const SHEET_ID = '1GdmirqWFKVt39QvEJxdMH3zW0-itl64YuqYEsOAkF30';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbuibOzpV1iSQVa1JtZny_WU06o18Xly4n2Az7CBKMvpNyiBvwTYLnhSFJfWTMjL90ww/exec';
    const API_KEY = '';
    
    let token = null, user = null, tokenClient;
    let cache = {vehiculos:[],subcategorias:[],filtros:[],anunciantes:[],solicitantes:[],noticias:[],comentarios:[],usuarios:[],suscripciones:[],historico:[],balance:[],intermediacion:[],ojeados:[],tabla_config:[]};
    let tablaGrupos = []; // Grupos cargados de tabla_config para Veh√≠culos
    let tablaColumnas = []; // Columnas cargadas de tabla_config para Veh√≠culos
    let gruposActivos = {}; // Estado de cada grupo (activo/inactivo) para Veh√≠culos
    let tablaGruposInter = []; // Grupos para Intermediaci√≥n
    let tablaColumnasInter = []; // Columnas para Intermediaci√≥n
    let gruposActivosInter = {}; // Estado de grupos para Intermediaci√≥n
    let mostrarVehiculosEnInter = false; // Mostrar veh√≠culos en tabla de Intermediaci√≥n
    let imgFiles = [], imgUrls = [], portada = 0;
    
    // Funci√≥n para normalizar estado de filtros (acepta abreviaturas)
    function normalizarEstadoFiltro(f) {
        let estado = (f.estado || '').toLowerCase().trim();
        // Si no tiene estado, usar campo publicado antiguo
        if (!estado) {
            if (f.publicado === undefined || f.publicado === '') return 'publicado';
            return (f.publicado === true || f.publicado === 'TRUE') ? 'publicado' : 'inactivo';
        }
        // Normalizar abreviaturas
        if (estado === 'pub' || estado.startsWith('public')) return 'publicado';
        if (estado === 'ocul' || estado.startsWith('ocult')) return 'oculto';
        if (estado === 'inact' || estado.startsWith('inact')) return 'inactivo';
        return estado;
    }
    
    // ============================================
    // GOOGLE SHEETS API
    // ============================================
    async function readSheetData(sheetName) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
        try {
            const response = await fetch(url, { headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
            if (!response.ok) return [];
            const data = await response.json();
            if (!data.values || data.values.length < 2) return [];
            const headers = data.values[0];
            return data.values.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => {
                    let val = row[i] || '';
                    if (val === 'TRUE') val = true;
                    else if (val === 'FALSE') val = false;
                    else if ((h === 'filtros_json' || h === 'caracteristicas_json' || h === 'mantenimiento_json' || h === 'renta_json') && val) {
                        try { val = JSON.parse(val); } catch { val = (h === 'mantenimiento_json' || h === 'renta_json') ? [] : {}; }
                    }
                    obj[h] = val;
                });
                return obj;
            });
        } catch (e) {
            console.error('Error loading ' + sheetName + ':', e);
            return [];
        }
    }
    
    async function loadConfig() {
        const rows = await readSheetData('config');
        const config = {};
        rows.forEach(row => { config[row.clave] = row; });
        return config;
    }
    
    // (API_KEY movido arriba)
    
    console.log('Cargando script principal de admin...');
    // (Config movido arriba)
    
    // Init
    window.onload = () => {
        const s = document.createElement('script');
        s.src = 'https://accounts.google.com/gsi/client';
        s.onload = initAuth;
        document.head.appendChild(s);
    };
    
    function initAuth() {
        tokenClient = google.accounts.oauth2.initTokenClient({client_id: CLIENT_ID, scope: SCOPES, callback: handleAuth});
        const saved = sessionStorage.getItem('tank_token');
        if (saved) { token = saved; user = JSON.parse(sessionStorage.getItem('tank_user')||'{}'); checkToken(); }
    }
    
    async function checkToken() {
        try {
            const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {headers:{'Authorization':'Bearer '+token}});
            if (r.ok) { showAdmin(); loadAll(); } else { sessionStorage.removeItem('tank_token'); token = null; }
        } catch(e) { console.error(e); }
    }
    
    function iniciarLogin() { tokenClient.requestAccessToken(); }
    
    async function handleAuth(r) {
        if (r.error) { document.getElementById('loginError').textContent = r.error; document.getElementById('loginError').classList.add('show'); return; }
        token = r.access_token;
        try {
            const info = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {headers:{'Authorization':'Bearer '+token}}).then(x=>x.json());
            const admins = await readSheetData('admins');
            if (!admins.some(a => a.email?.toLowerCase() === info.email?.toLowerCase() && (a.activo===true||a.activo==='TRUE'))) {
                document.getElementById('loginError').textContent = info.email + ' no autorizado';
                document.getElementById('loginError').classList.add('show');
                token = null; return;
            }
            user = info;
            sessionStorage.setItem('tank_token', token);
            sessionStorage.setItem('tank_user', JSON.stringify(info));
            showAdmin(); loadAll();
        } catch(e) { console.error(e); document.getElementById('loginError').textContent = 'Error'; document.getElementById('loginError').classList.add('show'); }
    }
    
    function showAdmin() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('adminContainer').classList.add('active');
        if (user) { document.getElementById('userPhoto').src = user.picture||''; document.getElementById('userName').textContent = user.name||user.email; }
        setupNav();
    }
    
    function logout() { sessionStorage.removeItem('tank_token'); sessionStorage.removeItem('tank_user'); location.reload(); }
    
    // Nav
    function setupNav() { document.querySelectorAll('.nav-item').forEach(n => n.onclick = () => n.dataset.section && goSection(n.dataset.section)); }
    function toggleNav(el) { 
        const sub = el.nextElementSibling; 
        sub.classList.toggle('active'); 
        el.querySelector('.nav-arrow').textContent = sub.classList.contains('active') ? '‚ñº' : '‚ñ∂'; 
        // Actualizar visibilidad de badges
        actualizarBadgesMenu();
    }
    function goSection(id) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('section-'+id)?.classList.add('active');
        document.querySelector('[data-section="'+id+'"]')?.classList.add('active');
        loadSection(id);
    }
    
    // Funci√≥n para actualizar badges del men√∫
    function setBadge(id, count) {
        const el = document.getElementById(id);
        if (!el) return;
        if (count > 0) {
            el.textContent = count > 99 ? '99+' : count;
            el.classList.add('visible');
        } else {
            el.textContent = '';
            el.classList.remove('visible');
        }
    }
    
    // Funci√≥n para actualizar visibilidad de badges seg√∫n estado desplegado/plegado
    function actualizarBadgesMenu() {
        // Obtener contadores actuales
        const anuCount = parseInt(document.getElementById('badgeAnunciantes')?.textContent) || 0;
        const solCount = parseInt(document.getElementById('badgeSolicitantes')?.textContent) || 0;
        const comCount = parseInt(document.getElementById('badgeCom')?.textContent) || 0;
        const chatCount = parseInt(document.getElementById('badgeChat')?.textContent) || 0;
        
        // Cat√°logo (anunciantes + solicitantes)
        const catalogoSub = document.querySelector('#badgeCatalogo')?.closest('.nav-cat')?.nextElementSibling;
        const catalogoOpen = catalogoSub?.classList.contains('active');
        const badgeCatalogo = document.getElementById('badgeCatalogo');
        const badgeAnu = document.getElementById('badgeAnunciantes');
        const badgeSol = document.getElementById('badgeSolicitantes');
        
        if (catalogoOpen) {
            // Desplegado: ocultar badge categor√≠a, mostrar subsecciones
            if (badgeCatalogo) badgeCatalogo.classList.remove('visible');
            if (badgeAnu && anuCount > 0) badgeAnu.classList.add('visible');
            if (badgeSol && solCount > 0) badgeSol.classList.add('visible');
        } else {
            // Plegado: mostrar badge categor√≠a si hay pendientes, ocultar subsecciones
            const totalCatalogo = anuCount + solCount;
            if (badgeCatalogo) {
                if (totalCatalogo > 0) {
                    badgeCatalogo.textContent = totalCatalogo > 99 ? '99+' : totalCatalogo;
                    badgeCatalogo.classList.add('visible');
                } else {
                    badgeCatalogo.classList.remove('visible');
                }
            }
            if (badgeAnu) badgeAnu.classList.remove('visible');
            if (badgeSol) badgeSol.classList.remove('visible');
        }
        
        // Comunicaci√≥n (comentarios)
        const comunicacionSub = document.querySelector('#badgeComunicacion')?.closest('.nav-cat')?.nextElementSibling;
        const comunicacionOpen = comunicacionSub?.classList.contains('active');
        const badgeComunicacion = document.getElementById('badgeComunicacion');
        const badgeCom = document.getElementById('badgeCom');
        
        if (comunicacionOpen) {
            if (badgeComunicacion) badgeComunicacion.classList.remove('visible');
            if (badgeCom && comCount > 0) badgeCom.classList.add('visible');
        } else {
            if (badgeComunicacion) {
                if (comCount > 0) {
                    badgeComunicacion.textContent = comCount > 99 ? '99+' : comCount;
                    badgeComunicacion.classList.add('visible');
                } else {
                    badgeComunicacion.classList.remove('visible');
                }
            }
            if (badgeCom) badgeCom.classList.remove('visible');
        }
        
        // Usuarios (chat)
        const usuariosSub = document.querySelector('#badgeUsuarios')?.closest('.nav-cat')?.nextElementSibling;
        const usuariosOpen = usuariosSub?.classList.contains('active');
        const badgeUsuarios = document.getElementById('badgeUsuarios');
        const badgeChat = document.getElementById('badgeChat');
        
        if (usuariosOpen) {
            if (badgeUsuarios) badgeUsuarios.classList.remove('visible');
            if (badgeChat && chatCount > 0) badgeChat.classList.add('visible');
        } else {
            if (badgeUsuarios) {
                if (chatCount > 0) {
                    badgeUsuarios.textContent = chatCount > 99 ? '99+' : chatCount;
                    badgeUsuarios.classList.add('visible');
                } else {
                    badgeUsuarios.classList.remove('visible');
                }
            }
            if (badgeChat) badgeChat.classList.remove('visible');
        }
    }
    
    // Load All
    async function loadAll() {
        try {
            [cache.vehiculos, cache.subcategorias, cache.filtros, cache.anunciantes, cache.solicitantes, cache.noticias, cache.comentarios, cache.usuarios, cache.suscripciones, cache.historico, cache.balance, cache.intermediacion, cache.ojeados, cache.chat, cache.tabla_config] = await Promise.all([
                readSheetData('vehiculos').catch(()=>[]), readSheetData('subcategorias').catch(()=>[]), readSheetData('filtros').catch(()=>[]),
                readSheetData('anunciantes').catch(()=>[]), readSheetData('solicitantes').catch(()=>[]), readSheetData('noticias').catch(()=>[]),
                readSheetData('comentarios').catch(()=>[]), readSheetData('usuarios').catch(()=>[]), readSheetData('subscripciones').catch(()=>[]),
                readSheetData('historico').catch(()=>[]), readSheetData('balance').catch(()=>[]), readSheetData('intermediacion').catch(()=>[]),
                readSheetData('ojeados').catch(()=>[]),
                readSheetData('chat').catch(()=>[]),
                readSheetData('tabla_config').catch(()=>[])
            ]);
            
            // Procesar configuraci√≥n de tabla
            procesarTablaConfig();
            
            // Stats
            document.getElementById('sVeh').textContent = cache.vehiculos.filter(v=>v.estado === 'publicado').length;
            const anuNew = cache.anunciantes.filter(a=>a.estado!=='contactado' && a.estado!=='Contactado').length;
            const solNew = cache.solicitantes.filter(s=>s.estado!=='contactado' && s.estado!=='Contactado').length;
            document.getElementById('sAnu').textContent = anuNew;
            document.getElementById('sSol').textContent = solNew;
            const pend = cache.comentarios.filter(c=>!c.moderado && c.moderado !== 'TRUE').length;
            document.getElementById('sCom').textContent = pend;
            
            // Contar chats sin leer
            const chatsNoOcultos = (cache.chat || []).filter(msg => msg.oculto_admin !== true && msg.oculto_admin !== 'TRUE');
            const chatsPorUsuario = {};
            chatsNoOcultos.forEach(msg => {
                const odoo = msg.usuario_id || msg.email || 'anon';
                if (!chatsPorUsuario[odoo]) chatsPorUsuario[odoo] = { sin_leer: false };
                if ((msg.tipo === 'user' || !msg.tipo) && msg.leido !== true && msg.leido !== 'TRUE') {
                    chatsPorUsuario[odoo].sin_leer = true;
                }
            });
            // Guardar para uso posterior
            cache.chatAgrupado = Object.values(chatsPorUsuario);
            const chatsSinLeer = cache.chatAgrupado.filter(c => c.sin_leer).length;
            document.getElementById('sChat').textContent = chatsSinLeer;
            
            // Actualizar badges del men√∫ usando setBadge
            setBadge('badgeAnunciantes', anuNew);
            setBadge('badgeSolicitantes', solNew);
            setBadge('badgeCom', pend);
            setBadge('badgeChat', chatsSinLeer);
            setBadge('badgeUsuarios', chatsSinLeer); // Badge de la categor√≠a Usuarios (plegada)
            setBadge('badgeComunicacion', pend); // Badge de la categor√≠a Comunicaci√≥n
            setBadge('badgeCatalogo', anuNew + solNew); // Badge de la categor√≠a Cat√°logo
            
            // Marcar tarjetas con pendientes
            updateDashboardBadges(anuNew, solNew, 0, pend, chatsSinLeer);
            
            // Actualizar visibilidad de badges seg√∫n estado del men√∫
            actualizarBadgesMenu();
            
            // Pendientes para dashboard
            let html = [];
            if (pend) html.push('üí¨ '+pend+' comentarios');
            if (anuNew) html.push('üì¢ '+anuNew+' anunciantes');
            if (solNew) html.push('üîé '+solNew+' solicitantes');
            if (chatsSinLeer) html.push('‚úâÔ∏è '+chatsSinLeer+' chats sin leer');
            document.getElementById('pendientes').innerHTML = html.length ? html.map(x=>'<p style="margin:6px 0">'+x+'</p>').join('') : '<p class="info">Sin pendientes</p>';
            
            // Matches
            const matches = cache.solicitantes.filter(s=>s.vehiculo_match_id);
            document.getElementById('matches').innerHTML = matches.length ? matches.slice(0,5).map(m=>'<p style="margin:6px 0">üîó #'+(parseInt(m.id)||0)+' ‚Üí Veh #'+(parseInt(m.vehiculo_match_id)||0)+'</p>').join('') : '<p class="info">Sin matches</p>';
            
            // Dashboard de acciones pendientes
            actualizarDashboardPendientes();
            
            loadBanner();
        } catch(e) { console.error(e); }
    }
    
    function loadSection(id) {
        switch(id) {
            case 'vehiculos': cargarSubcatsFiltro(); filtrarVeh(); break;
            case 'intermediacion': renderInter(); break;
            case 'ojeados': renderOjeados(); break;
            case 'subcategorias': renderSub(); break;
            case 'filtros': renderFil(); break;
            case 'anunciantes': renderAnu(); break;
            case 'solicitantes': renderSol(); break;
            case 'posts': renderPos(); break;
            case 'comentarios': renderCom(); break;
            case 'usuarios': renderUsu(); break;
            case 'suscripciones': renderSus(); break;
            case 'banner': loadBanner(); break;
            case 'balance': renderBalance(); break;
            case 'historico': renderHistorico(); break;
            case 'chat': cargarChats(); break;
        }
    }
    let vehSortCol = 'id';
    let vehSortAsc = true;
    // vehColsVisible ahora se maneja din√°micamente con gruposActivos
    let vehSearchTempCols = null;
    
    function filtrarVeh() {
        const q = document.getElementById('buscarVeh').value.toLowerCase().trim();
        const showVenta = document.getElementById('filtroVenta').checked;
        const showAlquiler = document.getElementById('filtroAlquiler').checked;
        const showTerceros = document.getElementById('filtroTerceros').checked;
        const subcat = document.getElementById('filtroSubcat').value.toLowerCase();
        
        let filtered = cache.vehiculos.filter(v => {
            // Categor√≠as m√∫ltiples - el veh√≠culo puede tener varias
            const cats = (v.categoria || '').toLowerCase().split(',').map(c => c.trim());
            const tieneVenta = cats.includes('venta');
            const tieneAlquiler = cats.includes('alquiler');
            const tieneTerceros = cats.includes('terceros');
            
            // Si el veh√≠culo tiene alguna categor√≠a que est√° seleccionada, mostrarlo
            const matchCategoria = (showVenta && tieneVenta) || (showAlquiler && tieneAlquiler) || (showTerceros && tieneTerceros);
            if (!matchCategoria) return false;
            
            if (subcat && (v.subcategoria || '').toLowerCase() !== subcat) return false;
            
            if (q) {
                const searchFields = [v.marca, v.modelo, v.subcategoria, v.categoria, v.matricula, v.motor, v.etiqueta, v.tipo, v.ubicacion, v.descripcion, v.a√±o, v.precio, v.potencia, v.ejes, v.estado].map(f => String(f || '').toLowerCase()).join(' ');
                let mantText = '';
                if (v.mantenimiento_json) {
                    try {
                        const mant = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
                        mantText = mant.map(m => m.razon || '').join(' ').toLowerCase();
                    } catch(e) {}
                }
                if (!searchFields.includes(q) && !searchFields.split(' ').some(w => w.includes(q)) && !mantText.includes(q)) return false;
            }
            return true;
        });
        
        if (vehSortCol) {
            filtered.sort((a, b) => {
                let valA = a[vehSortCol] || '';
                let valB = b[vehSortCol] || '';
                if (!isNaN(valA) && !isNaN(valB)) { valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0; }
                if (valA < valB) return vehSortAsc ? -1 : 1;
                if (valA > valB) return vehSortAsc ? 1 : -1;
                return 0;
            });
        }
        
        // Ya no necesitamos guardar estado de columnas durante b√∫squeda
        // El nuevo sistema de grupos se mantiene siempre
        
        // Determinar qu√© categor√≠as est√°n activas
        const filtrosActivos = { venta: showVenta, alquiler: showAlquiler, terceros: showTerceros };
        const soloAlquiler = showAlquiler && !showVenta && !showTerceros;
        
        // Guardar para exportaci√≥n
        vehiculosFiltradosActuales = filtered;
        
        renderTablaVehiculos(filtered, !!q, filtrosActivos, soloAlquiler);
    }
    
    function actualizarCheckboxesCols() {
        // Ahora se maneja din√°micamente con renderGruposCheckboxes
        // Esta funci√≥n se mantiene por compatibilidad pero no hace nada
    }
    
    function actualizarColumnasVeh() {
        // Ahora se maneja din√°micamente con toggleGrupo
        // Esta funci√≥n se mantiene por compatibilidad
        filtrarVeh();
    }
    
    function sortVeh(col) {
        if (vehSortCol === col) { vehSortAsc = !vehSortAsc; } else { vehSortCol = col; vehSortAsc = true; }
        filtrarVeh();
    }
    
    function esCisterna(v) {
        const subcat = (v.subcategoria || '').toLowerCase();
        if (subcat.includes('cisterna')) return true;
        if (v.filtros_json && typeof v.filtros_json === 'object') {
            const keys = Object.keys(v.filtros_json).map(k => k.toLowerCase());
            if (keys.some(k => k.includes('cisterna'))) {
                const val = v.filtros_json[Object.keys(v.filtros_json).find(k => k.toLowerCase().includes('cisterna'))];
                return val === true || val === 'TRUE' || val === 'Si';
            }
        }
        return false;
    }
    
    function renderTablaVehiculos(vehiculos, searchActive, filtrosActivos = {}, soloAlquiler = false) {
        const thead = document.getElementById('theadVeh');
        const tbody = document.getElementById('tVeh');
        
        if (!vehiculos.length) {
            thead.innerHTML = '<tr><th colspan="20">Sin resultados</th></tr>';
            tbody.innerHTML = '<tr><td colspan="20" class="empty">No hay vehiculos</td></tr>';
            return;
        }
        
        const tieneMatricula = vehiculos.some(v => v.matricula);
        const tieneDoc = vehiculos.some(v => v.documentacion);
        const tieneMotor = vehiculos.some(v => v.motor);
        const tienePotencia = vehiculos.some(v => v.potencia);
        const tieneTipo = vehiculos.some(v => v.tipo);
        const tieneCompartimentos = vehiculos.some(v => v.compartimentos && esCisterna(v));
        const tieneEjes = vehiculos.some(v => v.ejes);
        const tieneBC = vehiculos.some(v => v.bc);
        const tieneDD = vehiculos.some(v => v.dd);
        const tieneExolum = vehiculos.some(v => v.exolum);
        const tiene44tn = vehiculos.some(v => v['44tn']);
        const tieneADR = vehiculos.some(v => v.adr);
        const tieneATP = vehiculos.some(v => v.atp);
        const tieneITV = vehiculos.some(v => v.itv);
        const tieneEtiqueta = vehiculos.some(v => v.etiqueta);
        const tienePrecioAlq = vehiculos.some(v => v.precio_alquiler);
        const tienePrecioMin = vehiculos.some(v => v.precio_minimo);
        const tieneCoste = vehiculos.some(v => v.coste);
        const tieneMant = vehiculos.some(v => v.mantenimiento_json);
        const tieneRenta = vehiculos.some(v => v.renta_json);
        const tieneAdq = vehiculos.some(v => v.adquisicion);
        
        // Verificar visibilidad seg√∫n grupos (compatible con sistema antiguo y nuevo)
        const showMat = searchActive || columnaVisible('matricula');
        const showDoc = searchActive || columnaVisible('documentacion');
        const showTec = searchActive || columnaVisible('motor') || columnaVisible('potencia') || columnaVisible('ejes');
        const showCue = searchActive || columnaVisible('coste') || columnaVisible('mantenimiento') || columnaVisible('renta');
        
        // Aplicar tambi√©n filtro de "tiene datos"
        const showMatFinal = showMat && tieneMatricula;
        const showDocFinal = showDoc && tieneDoc;
        
        let h = '<tr><th class="sortable" onclick="sortVeh(\'id\')">ID</th><th>IMG</th>';
        if (showDocFinal) h += '<th>DOCS</th>';
        h += '<th class="sortable" onclick="sortVeh(\'marca\')">MARCA</th>';
        if (showMatFinal) h += '<th class="sortable" onclick="sortVeh(\'matricula\')">MATR</th>';
        h += '<th class="sortable" onclick="sortVeh(\'modelo\')">MODELO</th>';
        h += '<th class="sortable" onclick="sortVeh(\'a√±o\')">A√ëO</th>';
        h += '<th class="sortable" onclick="sortVeh(\'categoria\')">CAT</th>';
        h += '<th class="sortable" onclick="sortVeh(\'subcategoria\')">SUBCAT</th>';
        h += '<th>VOL/CAP</th>';
        if (tieneCompartimentos) h += '<th>COMP</th>';
        if (showTec && tieneEjes) h += '<th>EJES</th>';
        if (showTec && tieneBC) h += '<th>B/C</th>';
        if (showTec && tieneDD) h += '<th>DD</th>';
        if (showTec && tieneExolum) h += '<th>EXOL</th>';
        if (showTec && tiene44tn) h += '<th>44t</th>';
        if (showTec && tieneADR) h += '<th>ADR</th>';
        if (showTec && tieneATP) h += '<th>ATP</th>';
        if (showTec && tieneITV) h += '<th>ITV</th>';
        if (showTec && tieneEtiqueta) h += '<th>ETQ</th>';
        h += '<th class="sortable" onclick="sortVeh(\'precio\')">PRECIO</th>';
        if (tienePrecioAlq) h += '<th>P.ALQ</th>';
        if (showCue && tienePrecioMin) h += '<th>P.MIN</th>';
        if (showCue && tieneCoste) h += '<th>COSTE</th>';
        if (showCue && tieneMant) h += '<th>MANT</th>';
        if (showCue && tieneRenta) h += '<th>RENTA</th>';
        if (showCue && (tieneCoste || tieneMant || tieneRenta)) h += '<th>TOTAL</th>';
        if (showCue && tieneAdq) h += '<th>ADQ</th>';
        h += '<th>EST</th><th>ACC</th></tr>';
        
        if (vehSortCol) {
            const sc = vehSortAsc ? 'asc' : 'desc';
            h = h.replace('onclick="sortVeh(\'' + vehSortCol + '\')"', 'onclick="sortVeh(\'' + vehSortCol + '\')" class="sortable ' + sc + '"');
        }
        thead.innerHTML = h;
        
        tbody.innerHTML = vehiculos.map((v, i) => {
            const realIdx = cache.vehiculos.indexOf(v);
            const imgRaw = Array.isArray(v.imagenes) ? v.imagenes[0] : (v.imagenes || '').split(',')[0];
            const img = convertirUrlDrive(imgRaw);
            const isCist = esCisterna(v);
            let mantTotal = 0;
            if (v.mantenimiento_json) {
                try {
                    const mant = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
                    mantTotal = mant.reduce((sum, m) => sum + (parseFloat(m.costo) || 0), 0);
                } catch(e) {}
            }
            // Calcular renta total
            let rentaTotal = 0;
            if (v.renta_json) {
                try {
                    const renta = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json;
                    rentaTotal = renta.reduce((sum, r) => sum + (parseFloat(r.importe) || 0), 0);
                } catch(e) {}
            }
            const costeTotal = (parseFloat(v.coste) || 0) + mantTotal - rentaTotal;
            // Estado
            const estado = v.estado || (v.publicado === true || v.publicado === 'TRUE' ? 'publicado' : 'oculto');
            const estadoClass = estado === 'publicado' ? 'publicado' : (estado === 'alquilado' ? 'nuevo' : 'oculto');
            const estadoText = estado.charAt(0).toUpperCase() + estado.slice(1,3);
            
            let r = '<tr><td>' + (v.id || realIdx + 1) + '</td>';
            // Imagen con enlace a carpeta del vehiculo
            const vehId = v.id || realIdx + 1;
            const imgHtml = img ? '<a href="javascript:void(0)" onclick="abrirCarpetaVehiculo(\'' + (parseInt(vehId)||0) + '\')" title="Abrir carpeta de fotos"><img src="' + escapeHTML(img) + '" class="img-thumb" onerror="this.style.background=\'#ddd\'"></a>' : '<span class="img-thumb" style="background:#ddd"></span>';
            r += '<td>' + imgHtml + '</td>';
            // Documentos con enlace a carpeta de documentos
            if (showDocFinal) {
                const docsHtml = v.documentacion ? '<a href="javascript:void(0)" onclick="abrirCarpetaDocs(\'' + (parseInt(vehId)||0) + '\')" title="Abrir carpeta de documentos" class="doc-link">üìÅ</a>' : '-';
                r += '<td>' + docsHtml + '</td>';
            }
            r += '<td><b>' + escapeHTML(v.marca || '-') + '</b></td>';
            if (showMatFinal) r += '<td>' + escapeHTML(v.matricula || '-') + '</td>';
            r += '<td>' + escapeHTML(v.modelo || '-') + '</td>';
            r += '<td class="num">' + (v.a√±o || '-') + '</td>';
            // Categor√≠as con badges
            const cats = (v.categoria || '').toLowerCase().split(',').map(c => c.trim()).filter(c => c);
            let catBadges = '';
            cats.forEach(cat => {
                // Solo mostrar badge si la categor√≠a est√° en los filtros activos o si hay m√∫ltiples filtros activos
                const mostrar = filtrosActivos[cat] || Object.values(filtrosActivos).filter(v => v).length > 1;
                if (mostrar) {
                    catBadges += '<span class="cat-badge ' + cat + '">' + cat.charAt(0).toUpperCase() + cat.slice(1) + '</span>';
                }
            });
            r += '<td><div class="cat-badges">' + (catBadges || '-') + '</div></td>';
            r += '<td>' + escapeHTML(v.subcategoria || '-') + '</td>';
            if (tieneTipo) r += '<td>' + escapeHTML(v.tipo || '-') + '</td>';
            if (showTec && tieneMotor) r += '<td>' + escapeHTML(v.motor || '-') + '</td>';
            if (tienePotencia) r += '<td class="num">' + (v.potencia || '-') + '</td>';
            r += '<td class="num">' + (v.filtros_json?.volumen || v.filtros_json?.capacidad || '-') + '</td>';
            if (tieneCompartimentos) r += '<td class="center">' + (isCist && v.compartimentos ? v.compartimentos : '-') + '</td>';
            if (showTec && tieneEjes) r += '<td class="center">' + (v.ejes || '-') + '</td>';
            if (showTec && tieneBC) r += '<td class="center">' + (v.bc ? '‚úì' : '-') + '</td>';
            if (showTec && tieneDD) r += '<td class="center">' + (v.dd ? '‚úì' : '-') + '</td>';
            if (showTec && tieneExolum) r += '<td class="center">' + (v.exolum ? '‚úì' : '-') + '</td>';
            if (showTec && tiene44tn) r += '<td class="center">' + (v['44tn'] ? '‚úì' : '-') + '</td>';
            if (showTec && tieneADR) r += formatFecha(v.adr);
            if (showTec && tieneATP) r += formatFecha(v.atp);
            if (showTec && tieneITV) r += formatFecha(v.itv);
            if (showTec && tieneEtiqueta) r += '<td>' + escapeHTML(v.etiqueta || '-') + '</td>';
            // Precio seg√∫n filtro: si solo alquiler, mostrar precio alquiler
            const precioMostrar = soloAlquiler && v.precio_alquiler ? v.precio_alquiler : v.precio;
            const precioLabel = soloAlquiler && v.precio_alquiler ? '/mes' : '';
            r += '<td class="num">' + (precioMostrar ? fmtNum(precioMostrar) + '‚Ç¨' + precioLabel : 'Cons') + '</td>';
            if (tienePrecioAlq) r += '<td class="num">' + (v.precio_alquiler ? fmtNum(v.precio_alquiler) + '‚Ç¨/mes' : '-') + '</td>';
            if (showCue && tienePrecioMin) r += '<td class="num">' + (v.precio_minimo ? fmtNum(v.precio_minimo) + '‚Ç¨' : '-') + '</td>';
            if (showCue && tieneCoste) r += '<td class="num">' + (v.coste ? fmtNum(v.coste) + '‚Ç¨' : '-') + '</td>';
            if (showCue && tieneMant) r += '<td class="num"><span class="mant-link" onclick="editVeh(' + realIdx + ');setTimeout(()=>{document.getElementById(\'mantTable\').scrollIntoView()},100)">' + (mantTotal ? fmtNum(mantTotal) + '‚Ç¨' : '-') + '</span></td>';
            if (showCue && tieneRenta) r += '<td class="num" style="color:#059669"><span class="mant-link" onclick="editVeh(' + realIdx + ');setTimeout(()=>{document.getElementById(\'rentaTable\').scrollIntoView()},100)">' + (rentaTotal ? '-' + fmtNum(rentaTotal) + '‚Ç¨' : '-') + '</span></td>';
            if (showCue && (tieneCoste || tieneMant || tieneRenta)) r += '<td class="num"><b>' + fmtNum(costeTotal) + '‚Ç¨</b></td>';
            if (showCue && tieneAdq) r += '<td>' + escapeHTML(v.adquisicion || '-') + '</td>';
            r += '<td><span class="badge-estado ' + estadoClass + '">' + estadoText + '</span></td>';
            r += '<td class="table-actions">';
            r += '<button type="button" onclick="editVeh(' + realIdx + ')" title="Editar">‚úèÔ∏è</button>';
            if (v.estado !== 'vendido') r += '<button type="button" onclick="abrirModalVender(\'' + escapeHTML(v.id) + '\', \'vehiculos\')" title="Vender" style="font-weight:bold;">‚Ç¨</button>';
            r += '<button type="button" onclick="prepDel(\'vehiculos\',' + (realIdx + 2) + ')" title="Eliminar">üóëÔ∏è</button>';
            r += '</td></tr>';
            return r;
        }).join('');
    }
    
    function formatFecha(fecha) {
        if (!fecha) return '<td>-</td>';
        const hoy = new Date();
        const f = new Date(fecha);
        const diffDays = Math.ceil((f - hoy) / (1000 * 60 * 60 * 24));
        let cls = '';
        if (diffDays < 0) cls = 'fecha-venc';
        else if (diffDays < 30) cls = 'fecha-prox';
        return '<td class="' + cls + '">' + fecha.substring(5) + '</td>';
    }
    
    function cargarSubcatsFiltro() {
        const select = document.getElementById('filtroSubcat');
        select.innerHTML = '<option value="">Todas subcategor√≠as</option>';
        cache.subcategorias.forEach(s => {
            select.innerHTML += '<option value="' + escapeHTML((s.nombre || '').toLowerCase()) + '">' + escapeHTML(s.nombre || '') + '</option>';
        });
    }
    
    function toggleOpcionesAvanzadas() {
        const header = document.querySelector('.opciones-avanzadas-header');
        const content = document.getElementById('opcionesAvanzadasContent');
        header.classList.toggle('open');
        content.classList.toggle('open');
    }
    
    function addFilaMant(data = {}) {
        const tbody = document.getElementById('mantBody');
        const row = document.createElement('tr');
        let facturaHTML;
        if (data.factura) {
            // Extraer nombre y URL si tiene formato nombre|url
            let nombre = 'Ver';
            let url = data.factura;
            if (data.factura.includes('|')) {
                const parts = data.factura.split('|');
                nombre = parts[0];
                url = parts[1];
            }
            const displayName = nombre.length > 12 ? nombre.substring(0,10) + '...' : nombre;
            facturaHTML = '<a href="' + escapeHTML(url) + '" target="_blank" class="btn-view-file" title="' + escapeHTML(nombre) + '">üìÑ ' + escapeHTML(displayName) + '</a>';
        } else {
            facturaHTML = '<input type="file" class="mant-factura" accept="image/*,.pdf">';
        }
        row.innerHTML = '<td><input type="date" class="mant-fecha" value="' + escapeHTML(data.fecha || '') + '"></td><td><input type="text" class="mant-razon" placeholder="Raz√≥n" value="' + escapeHTML(data.razon || '') + '"></td><td><input type="number" class="mant-costo" placeholder="0" value="' + escapeHTML(data.costo || '') + '" onchange="calcMantTotal();calcCosteTotal()"></td><td>' + facturaHTML + '<input type="hidden" class="mant-factura-url" value="' + escapeHTML(data.factura || '') + '"></td><td><button type="button" class="btn-remove-row" onclick="this.closest(\'tr\').remove();calcMantTotal();calcCosteTotal()">√ó</button></td>';
        tbody.appendChild(row);
    }
    
    function calcMantTotal() {
        let total = 0;
        document.querySelectorAll('.mant-costo').forEach(inp => { total += parseFloat(inp.value) || 0; });
        document.getElementById('mantTotal').textContent = fmtNum(total);
    }
    
    async function getMantData(vehiculo) {
        const rows = [];
        const trs = document.querySelectorAll('#mantBody tr');
        for (const tr of trs) {
            const fecha = tr.querySelector('.mant-fecha').value;
            const razon = tr.querySelector('.mant-razon').value;
            const costo = tr.querySelector('.mant-costo').value;
            let factura = tr.querySelector('.mant-factura-url')?.value || '';
            
            // Si hay archivo nuevo, subirlo a Drive
            const fileInput = tr.querySelector('.mant-factura');
            if (fileInput && fileInput.files && fileInput.files[0] && vehiculo) {
                try {
                    toast('Subiendo factura mantenimiento...', 'info');
                    factura = await subirFacturaADrive(fileInput.files[0], vehiculo, 'mantenimiento', fecha);
                } catch(e) {
                    console.error('Error subiendo factura mant:', e);
                }
            }
            
            if (fecha || razon || costo) rows.push({ fecha, razon, costo: parseFloat(costo) || 0, factura });
        }
        return rows;
    }
    
    function setMantData(data) {
        const tbody = document.getElementById('mantBody');
        tbody.innerHTML = '';
        if (data && data.length) {
            data.forEach(m => addFilaMant(m));
        }
        calcMantTotal();
    }

    // Funciones de RENTA
    function addFilaRenta(data = {}) {
        const tbody = document.getElementById('rentaBody');
        const row = document.createElement('tr');
        let facturaHTML;
        if (data.factura) {
            // Extraer nombre y URL si tiene formato nombre|url
            let nombre = 'Ver';
            let url = data.factura;
            if (data.factura.includes('|')) {
                const parts = data.factura.split('|');
                nombre = parts[0];
                url = parts[1];
            }
            const displayName = nombre.length > 12 ? nombre.substring(0,10) + '...' : nombre;
            facturaHTML = '<a href="' + escapeHTML(url) + '" target="_blank" class="btn-view-file" title="' + escapeHTML(nombre) + '">üìÑ ' + escapeHTML(displayName) + '</a>';
        } else {
            facturaHTML = '<input type="file" class="renta-factura" accept="image/*,.pdf">';
        }
        row.innerHTML = '<td><input type="date" class="renta-desde" value="' + escapeHTML(data.desde || '') + '"></td><td><input type="date" class="renta-hasta" value="' + escapeHTML(data.hasta || '') + '"></td><td><input type="text" class="renta-razon" placeholder="Cliente/Raz√≥n" value="' + escapeHTML(data.razon || '') + '"></td><td><input type="number" class="renta-importe" placeholder="0" value="' + escapeHTML(data.importe || '') + '" onchange="calcRentaTotal();calcCosteTotal()"></td><td>' + facturaHTML + '<input type="hidden" class="renta-factura-url" value="' + escapeHTML(data.factura || '') + '"></td><td><button type="button" class="btn-remove-row" onclick="this.closest(\'tr\').remove();calcRentaTotal();calcCosteTotal()">√ó</button></td>';
        tbody.appendChild(row);
    }
    
    function calcRentaTotal() {
        let total = 0;
        document.querySelectorAll('.renta-importe').forEach(inp => { total += parseFloat(inp.value) || 0; });
        document.getElementById('rentaTotal').textContent = fmtNum(total);
    }
    
    async function getRentaData(vehiculo) {
        const rows = [];
        const trs = document.querySelectorAll('#rentaBody tr');
        for (const tr of trs) {
            const desde = tr.querySelector('.renta-desde').value;
            const hasta = tr.querySelector('.renta-hasta').value;
            const razon = tr.querySelector('.renta-razon').value;
            const importe = tr.querySelector('.renta-importe').value;
            let factura = tr.querySelector('.renta-factura-url')?.value || '';
            
            // Si hay archivo nuevo, subirlo a Drive
            const fileInput = tr.querySelector('.renta-factura');
            if (fileInput && fileInput.files && fileInput.files[0] && vehiculo) {
                try {
                    toast('Subiendo factura alquiler...', 'info');
                    factura = await subirFacturaADrive(fileInput.files[0], vehiculo, 'renta', desde);
                } catch(e) {
                    console.error('Error subiendo factura renta:', e);
                }
            }
            
            if (desde || hasta || razon || importe) rows.push({ desde, hasta, razon, importe: parseFloat(importe) || 0, factura });
        }
        return rows;
    }
    
    function setRentaData(data) {
        const tbody = document.getElementById('rentaBody');
        tbody.innerHTML = '';
        if (data && data.length) {
            data.forEach(r => addFilaRenta(r));
        }
        calcRentaTotal();
    }
    
    function calcCosteTotal() {
        const coste = parseFloat(document.getElementById('vehCoste').value) || 0;
        let mantTotal = 0;
        document.querySelectorAll('.mant-costo').forEach(inp => { mantTotal += parseFloat(inp.value) || 0; });
        let rentaTotal = 0;
        document.querySelectorAll('.renta-importe').forEach(inp => { rentaTotal += parseFloat(inp.value) || 0; });
        const total = coste + mantTotal - rentaTotal;
        document.getElementById('costeTotalCalc').textContent = fmtNum(total);
    }
    
    // ========== MODAL TRANSACCI√ìN (‚Ç¨) ==========
    console.log('‚úÖ Cargando funciones de transacci√≥n...');
    let tipoTransaccionActual = null;
    
    window.abrirTransaccion = function(idx) {
        console.log('abrirTransaccion llamada con idx:', idx);
        const v = cache.vehiculos[idx];
        console.log('Veh√≠culo encontrado:', v);
        if (!v) {
            console.error('No se encontr√≥ veh√≠culo en idx:', idx);
            return;
        }
        
        document.getElementById('transVehIdx').value = idx;
        document.getElementById('transVehInfo').innerHTML = '<strong>' + escapeHTML(v.marca || '') + ' ' + escapeHTML(v.modelo || '') + '</strong> (' + escapeHTML(v.a√±o || '') + ') - ' + escapeHTML(v.matricula || 'Sin matr√≠cula');
        
        // Reset
        tipoTransaccionActual = null;
        document.getElementById('btnTransAlquiler').classList.remove('active');
        document.getElementById('btnTransVenta').classList.remove('active');
        document.getElementById('formTransAlquiler').style.display = 'none';
        document.getElementById('formTransVenta').style.display = 'none';
        document.getElementById('btnGuardarTrans').disabled = true;
        
        // Limpiar campos
        document.getElementById('transAlqDesde').value = '';
        document.getElementById('transAlqHasta').value = '';
        document.getElementById('transAlqRazon').value = '';
        document.getElementById('transAlqPrecio').value = '';
        document.getElementById('transAlqFactura').value = '';
        document.getElementById('transVentaFecha').value = '';
        document.getElementById('transVentaRazon').value = '';
        document.getElementById('transVentaPrecio').value = '';
        document.getElementById('transVentaFactura').value = '';
        document.getElementById('transVentaExportacion').checked = false;
        
        const modalTrans = document.getElementById('modalTransaccion');
        console.log('Modal element:', modalTrans);
        if (modalTrans) {
            modalTrans.classList.add('active');
            console.log('‚úÖ Modal transacci√≥n abierto, classList:', modalTrans.classList);
        } else {
            console.error('‚ùå No se encontr√≥ el modal modalTransaccion');
        }
    }
    
    window.setTipoTransaccion = function(tipo) {
        tipoTransaccionActual = tipo;
        
        document.getElementById('btnTransAlquiler').classList.toggle('active', tipo === 'alquiler');
        document.getElementById('btnTransVenta').classList.toggle('active', tipo === 'venta');
        
        document.getElementById('formTransAlquiler').style.display = tipo === 'alquiler' ? 'block' : 'none';
        document.getElementById('formTransVenta').style.display = tipo === 'venta' ? 'block' : 'none';
        
        document.getElementById('btnGuardarTrans').disabled = false;
    }
    
    window.guardarTransaccion = async function() {
        const idx = parseInt(document.getElementById('transVehIdx').value);
        const v = cache.vehiculos[idx];
        if (!v || !tipoTransaccionActual) return;
        
        if (tipoTransaccionActual === 'alquiler') {
            await guardarTransaccionAlquiler(idx, v);
        } else {
            await guardarTransaccionVenta(idx, v);
        }
    }
    
    async function guardarTransaccionAlquiler(idx, v) {
        const desde = document.getElementById('transAlqDesde').value;
        const hasta = document.getElementById('transAlqHasta').value;
        const cliente = document.getElementById('transAlqRazon').value;
        const importe = document.getElementById('transAlqPrecio').value;
        const facturaFile = document.getElementById('transAlqFactura').files[0];
        
        if (!desde || !importe) {
            toast('Completa al menos Desde e Importe', 'error');
            return;
        }
        
        toast('Guardando transacci√≥n...', 'info');
        
        // Subir factura si existe
        let facturaUrl = '';
        if (facturaFile) {
            try {
                facturaUrl = await subirFacturaADrive(facturaFile, v, 'renta', desde);
            } catch (e) {
                console.error('Error subiendo factura:', e);
                toast('Error al subir factura', 'error');
            }
        }
        
        // Obtener renta_json actual
        let rentaData = [];
        if (v.renta_json) {
            try {
                rentaData = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json;
            } catch (e) { rentaData = []; }
        }
        
        // A√±adir nueva entrada
        rentaData.push({
            desde,
            hasta,
            razon: cliente,
            importe: parseFloat(importe) || 0,
            factura: facturaUrl
        });
        
        // Actualizar en Sheets
        const rowNum = idx + 2;
        try {
            // Actualizar renta_json (columna 37 = AK)
            await updateCell('vehiculos', 'AK' + rowNum, JSON.stringify(rentaData));
            
            // Cambiar estado a "alquilado" (columna 15 = O)
            await updateCell('vehiculos', 'O' + rowNum, 'alquilado');
            
            // A√±adir entrada al balance
            const detalleVeh = (v.subcategoria || '') + ' ' + (v.tipo || '') + ' ' + (v.marca || '') + ' ' + (v.matricula || '') + ' (' + (v.a√±o || '') + ')';
            const balanceData = [
                cache.balance.length + 1,
                'ingreso',
                desde,
                'Alquiler',
                detalleVeh + (cliente ? ' - ' + cliente : ''),
                importe,
                facturaUrl,
                'cobrado',
                'Alquiler veh√≠culo ID: ' + v.id + (hasta ? ' hasta ' + hasta : '')
            ];
            await appendRow('balance', balanceData);
            
            // Actualizar cache
            v.renta_json = rentaData;
            v.estado = 'alquilado';
            cache.balance = await readSheetData('balance');
            
            toast('Alquiler registrado correctamente', 'success');
            cerrarModal('modalTransaccion');
            filtrarVeh();
        } catch (e) {
            console.error('Error guardando transacci√≥n:', e);
            toast('Error al guardar: ' + e.message, 'error');
        }
    }
    
    async function guardarTransaccionVenta(idx, v) {
        const fecha = document.getElementById('transVentaFecha').value;
        const comprador = document.getElementById('transVentaRazon').value;
        const precio = document.getElementById('transVentaPrecio').value;
        const facturaFile = document.getElementById('transVentaFactura').files[0];
        const esExportacion = document.getElementById('transVentaExportacion').checked;
        
        if (!fecha || !precio) {
            toast('Completa al menos Fecha y Precio', 'error');
            return;
        }
        
        // Confirmar
        if (!confirm('¬øEst√°s seguro de registrar la VENTA? El veh√≠culo se mover√° a Hist√≥rico y se eliminar√° del cat√°logo.')) {
            return;
        }
        
        toast('Procesando venta...', 'info');
        
        // Subir factura si existe
        let facturaUrl = '';
        if (facturaFile) {
            try {
                facturaUrl = await subirFacturaADrive(facturaFile, v, 'venta', fecha);
            } catch (e) {
                console.error('Error subiendo factura:', e);
            }
        }
        
        const rowNum = idx + 2;
        try {
            // Determinar categor√≠a de venta: exportacion > terceros > venta
            let tipoVenta = 'venta';
            if (esExportacion) {
                tipoVenta = 'exportacion';
            } else if (v.categoria === 'terceros') {
                tipoVenta = 'terceros';
            }
            
            // Procesar venta: a√±adir a balance y mover a hist√≥rico
            await procesarVenta(v, precio, comprador, fecha, facturaUrl, tipoVenta);
            
            // Eliminar de veh√≠culos
            await deleteRow('vehiculos', rowNum);
            
            toast('Venta registrada correctamente', 'success');
            cerrarModal('modalTransaccion');
            
            // Recargar datos
            cache.vehiculos = await readSheetData('vehiculos');
            cache.balance = await readSheetData('balance');
            cache.historico = await readSheetData('historico');
            filtrarVeh();
        } catch (e) {
            console.error('Error procesando venta:', e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Estructura de carpetas en Drive:
    // TankIberica/
    //   ‚îú‚îÄ‚îÄ Vehiculos/
    //   ‚îÇ   ‚îî‚îÄ‚îÄ [Marca_Modelo_Matricula]/
    //   ‚îÇ       ‚îú‚îÄ‚îÄ (fotos)
    //   ‚îÇ       ‚îî‚îÄ‚îÄ Documentos/
    //   ‚îÇ           ‚îî‚îÄ‚îÄ Tickets/
    //   ‚îú‚îÄ‚îÄ Historico/
    //   ‚îÇ   ‚îî‚îÄ‚îÄ [Marca_Modelo_Matricula]/
    //   ‚îÇ       ‚îî‚îÄ‚îÄ Documentos/
    //   ‚îî‚îÄ‚îÄ Tickets/
    //       ‚îî‚îÄ‚îÄ [A√±o]/
    //           ‚îú‚îÄ‚îÄ Ingresos/
    //           ‚îÇ   ‚îî‚îÄ‚îÄ Facturas/
    //           ‚îî‚îÄ‚îÄ Gastos/
    //               ‚îî‚îÄ‚îÄ Recibos/
    
    const DRIVE_FOLDERS = {
        root: null, // Se busca/crea TankIberica
        vehiculos: null,
        historico: null,
        tickets: null
    };
    
    async function getOrCreateFolder(name, parentId = null) {
        try {
            let q = "name='" + name + "' and mimeType='application/vnd.google-apps.folder' and trashed=false";
            if (parentId) q += " and '" + parentId + "' in parents";
            
            const searchResp = await gapi.client.drive.files.list({ q, fields: 'files(id, name)' });
            
            if (searchResp.result.files && searchResp.result.files.length > 0) {
                return searchResp.result.files[0].id;
            }
            
            // Crear carpeta
            const resource = { name, mimeType: 'application/vnd.google-apps.folder' };
            if (parentId) resource.parents = [parentId];
            
            const createResp = await gapi.client.drive.files.create({ resource, fields: 'id' });
            return createResp.result.id;
        } catch (e) {
            console.error('Error getOrCreateFolder:', e);
            throw e;
        }
    }
    
    // Buscar carpeta en Drive usando fetch
    async function buscarCarpetaDrive(nombre, parentId) {
        const q = encodeURIComponent("name='" + nombre + "' and mimeType='application/vnd.google-apps.folder' and '" + parentId + "' in parents and trashed=false");
        const url = 'https://www.googleapis.com/drive/v3/files?q=' + q + '&fields=files(id,name)';
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        const data = await resp.json();
        return data.files && data.files.length > 0 ? data.files[0] : null;
    }
    
    // Abrir carpeta de fotos del veh√≠culo en Drive
    async function abrirCarpetaVehiculo(vehId) {
        try {
            toast('Buscando carpeta...', 'info');
            
            // Buscar carpeta TankIberica
            const qRoot = encodeURIComponent("name='TankIberica' and mimeType='application/vnd.google-apps.folder' and trashed=false");
            const respRoot = await fetch('https://www.googleapis.com/drive/v3/files?q=' + qRoot + '&fields=files(id,name)', { headers: { 'Authorization': 'Bearer ' + token } });
            const dataRoot = await respRoot.json();
            
            if (!dataRoot.files || dataRoot.files.length === 0) {
                toast('Carpeta TankIberica no encontrada', 'error');
                return;
            }
            
            // Buscar carpeta Vehiculos
            const vehiculosFolder = await buscarCarpetaDrive('Vehiculos', dataRoot.files[0].id);
            if (!vehiculosFolder) {
                toast('Carpeta Vehiculos no encontrada', 'error');
                return;
            }
            
            // Buscar carpeta del veh√≠culo
            const vehFolder = await buscarCarpetaDrive(String(vehId), vehiculosFolder.id);
            if (vehFolder) {
                window.open('https://drive.google.com/drive/folders/' + vehFolder.id, '_blank');
            } else {
                toast('Carpeta del veh√≠culo no encontrada', 'info');
            }
        } catch(e) {
            console.error('Error abrirCarpetaVehiculo:', e);
            toast('Error al abrir carpeta: ' + e.message, 'error');
        }
    }
    
    // Abrir carpeta de documentos del veh√≠culo en Drive
    async function abrirCarpetaDocs(vehId) {
        try {
            toast('Buscando carpeta...', 'info');
            
            // Buscar carpeta TankIberica
            const qRoot = encodeURIComponent("name='TankIberica' and mimeType='application/vnd.google-apps.folder' and trashed=false");
            const respRoot = await fetch('https://www.googleapis.com/drive/v3/files?q=' + qRoot + '&fields=files(id,name)', { headers: { 'Authorization': 'Bearer ' + token } });
            const dataRoot = await respRoot.json();
            
            if (!dataRoot.files || dataRoot.files.length === 0) {
                toast('Carpeta TankIberica no encontrada', 'error');
                return;
            }
            
            // Buscar carpeta Vehiculos
            const vehiculosFolder = await buscarCarpetaDrive('Vehiculos', dataRoot.files[0].id);
            if (!vehiculosFolder) {
                toast('Carpeta Vehiculos no encontrada', 'error');
                return;
            }
            
            // Buscar carpeta del veh√≠culo
            const vehFolder = await buscarCarpetaDrive(String(vehId), vehiculosFolder.id);
            if (!vehFolder) {
                toast('Carpeta del veh√≠culo no encontrada', 'info');
                return;
            }
            
            // Buscar carpeta Documentos
            const docsFolder = await buscarCarpetaDrive('Documentos', vehFolder.id);
            if (docsFolder) {
                window.open('https://drive.google.com/drive/folders/' + docsFolder.id, '_blank');
            } else {
                // Si no hay carpeta Documentos, abrir la del veh√≠culo
                window.open('https://drive.google.com/drive/folders/' + vehFolder.id, '_blank');
                toast('No hay carpeta Documentos, abriendo carpeta del veh√≠culo', 'info');
            }
        } catch(e) {
            console.error('Error abrirCarpetaDocs:', e);
            toast('Error al abrir carpeta: ' + e.message, 'error');
        }
    }
    
    async function initDriveFolders() {
        if (DRIVE_FOLDERS.root) return; // Ya inicializado
        
        DRIVE_FOLDERS.root = await getOrCreateFolder('TankIberica');
        DRIVE_FOLDERS.vehiculos = await getOrCreateFolder('Vehiculos', DRIVE_FOLDERS.root);
        DRIVE_FOLDERS.historico = await getOrCreateFolder('Historico', DRIVE_FOLDERS.root);
        DRIVE_FOLDERS.tickets = await getOrCreateFolder('Tickets', DRIVE_FOLDERS.root);
    }
    
    async function subirFacturaADrive(file, vehiculo, tipo, fecha = null) {
        // tipo: 'renta' (ingreso), 'venta' (ingreso), 'mantenimiento' (gasto)
        // fecha: para determinar el a√±o en Tickets
        
        await initDriveFolders();
        
        const year = fecha ? new Date(fecha).getFullYear() : new Date().getFullYear();
        
        // Generar nombre carpeta del veh√≠culo
        const nombreCarpetaVeh = generarNombreCarpetaVeh(
            vehiculo.marca, 
            vehiculo.ano || vehiculo.a√±o, 
            vehiculo.matricula, 
            vehiculo.id
        );
        
        try {
            // 1. Construir ruta: Vehiculos/[Subcategoria]/[Tipo]/[Marca_(A√±o)_Matricula]/Facturas/
            let parentFolder = DRIVE_FOLDERS.vehiculos;
            
            // Obtener subcategor√≠a y tipo del veh√≠culo
            const subcategoria = vehiculo.subcategoria || '';
            let tipoClase = '';
            
            // Intentar obtener tipo/clase desde filtros_json del veh√≠culo
            if (vehiculo.filtros_json) {
                try {
                    const filtros = typeof vehiculo.filtros_json === 'string' ? JSON.parse(vehiculo.filtros_json) : vehiculo.filtros_json;
                    const tipoVal = filtros.tipo || filtros.Tipo || filtros.clase || filtros.Clase;
                    if (tipoVal) {
                        tipoClase = typeof tipoVal === 'object' ? (tipoVal.es || tipoVal.en || '') : String(tipoVal);
                        tipoClase = tipoClase.replace(/[\/\\:*?"<>|]/g, '_');
                    }
                } catch(e) {}
            }
            
            if (subcategoria) {
                parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
            }
            if (tipoClase) {
                parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
            }
            
            const vehFolderId = await getOrCreateFolder(nombreCarpetaVeh, parentFolder);
            const facturasFolderId = await getOrCreateFolder('Facturas', vehFolderId);
            
            // 2. Tambi√©n copiar a Tickets/[A√±o]/Ingresos|Gastos/Facturas|Recibos/
            const yearFolderId = await getOrCreateFolder(String(year), DRIVE_FOLDERS.tickets);
            let ticketTypeFolderId, ticketSubFolderId;
            
            if (tipo === 'renta' || tipo === 'venta') {
                ticketTypeFolderId = await getOrCreateFolder('Ingresos', yearFolderId);
                ticketSubFolderId = await getOrCreateFolder('Facturas', ticketTypeFolderId);
            } else {
                ticketTypeFolderId = await getOrCreateFolder('Gastos', yearFolderId);
                ticketSubFolderId = await getOrCreateFolder('Recibos', ticketTypeFolderId);
            }
            
            // Nombre del archivo
            const fileName = tipo + '_' + nombreCarpetaVeh + '_' + new Date().toISOString().split('T')[0] + '_' + file.name;
            
            // Subir a carpeta de Facturas del veh√≠culo
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify({
                name: fileName,
                parents: [facturasFolderId]
            })], { type: 'application/json' }));
            form.append('file', file);
            
            const uploadResp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token },
                body: form
            });
            
            const result = await uploadResp.json();
            const fileId = result.id;
            
            // Copiar a carpeta de Tickets (crea un acceso directo o copia)
            await gapi.client.drive.files.copy({
                fileId: fileId,
                resource: { name: fileName, parents: [ticketSubFolderId] }
            });
            
            // Devolver nombre|url para guardar ambos
            return file.name + '|https://drive.google.com/file/d/' + fileId + '/view';
        } catch (e) {
            console.error('Error subiendo a Drive:', e);
            throw e;
        }
    }
    
    // ========== BALANCE ==========
    let balanceSortCol = 'id';
    let balanceSortAsc = true;
    let balanceFilterYear = '';
    let balanceFilterTipo = '';
    
    function renderBalance() {
        let data = [...cache.balance];
        
        // Llenar filtro de a√±os
        const years = [...new Set(data.map(b => b.fecha ? new Date(b.fecha).getFullYear() : null).filter(Boolean))].sort((a,b) => b-a);
        const yearSelect = document.getElementById('balanceYearFilter');
        const currentYearVal = yearSelect.value;
        yearSelect.innerHTML = '<option value="">Todos los a√±os</option>' + years.map(y => '<option value="'+y+'"'+(currentYearVal==y?' selected':'')+'>'+y+'</option>').join('');
        
        // Llenar filtro subcategor√≠as
        if (typeof poblarFiltroSubcategorias === "function") poblarFiltroSubcategorias();
        
        // Obtener valores de filtros
        const searchTerm = (document.getElementById('balanceSearch').value || '').toLowerCase();
        const yearFilter = document.getElementById('balanceYearFilter').value;
        const tipoFilter = document.getElementById('balanceTipoFilter').value;
        const razonFilter = document.getElementById('balanceRazonFilter').value;
        const estadoFilter = document.getElementById('balanceEstadoFilter').value;
        const subcatFilter = document.getElementById("balanceSubcatFilter") ? document.getElementById("balanceSubcatFilter").value : "";
        
        // Aplicar filtros
        if (yearFilter) data = data.filter(b => b.fecha && new Date(b.fecha).getFullYear() == yearFilter);
        if (tipoFilter) data = data.filter(b => b.tipo === tipoFilter);
        if (razonFilter) data = data.filter(b => b.razon === razonFilter);
        if (estadoFilter) data = data.filter(b => b.estado === estadoFilter);
        if (subcatFilter) data = data.filter(b => b.subcategoria === subcatFilter);
        if (searchTerm) {
            data = data.filter(b => 
                (b.razon || '').toLowerCase().includes(searchTerm) ||
                (b.detalle || '').toLowerCase().includes(searchTerm) ||
                (b.notas || '').toLowerCase().includes(searchTerm) ||
                (b.importe + '').includes(searchTerm)
            );
        }
        
        // Ordenar
        data.sort((a, b) => {
            let va = a[balanceSortCol] || '';
            let vb = b[balanceSortCol] || '';
            if (balanceSortCol === 'id' || balanceSortCol === 'importe') { va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; }
            if (balanceSortCol === 'fecha') { va = new Date(va); vb = new Date(vb); }
            if (va < vb) return balanceSortAsc ? -1 : 1;
            if (va > vb) return balanceSortAsc ? 1 : -1;
            return 0;
        });
        
        const tbody = document.getElementById('tBalance');
        if (!data.length) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty">No hay transacciones</td></tr>';
        } else {
            tbody.innerHTML = data.map((b, i) => {
                const realIdx = cache.balance.indexOf(b);
                const tipoClass = b.tipo === 'ingreso' ? 'ingreso' : 'gasto';
                const tipoIcon = b.tipo === 'ingreso' ? '‚Üë' : '‚Üì';
                const estadoClass = b.estado || 'pendiente';
                const facturaLink = b.factura ? '<a href="'+escapeHTML(b.factura)+'" target="_blank" class="btn-view-file">Ver</a>' : '-';
                const benPct = (b.tipo === 'ingreso' && b.coste_asociado) ? (((parseFloat(b.importe)||0) - (parseFloat(b.coste_asociado)||0)) / (parseFloat(b.coste_asociado)||1) * 100).toFixed(1) + '%' : '-';
                return '<tr>' +
                    '<td><span class="tipo-badge '+tipoClass+'">'+tipoIcon+' '+(b.tipo || '-')+'</span></td>' +
                    '<td>'+fmtDate(b.fecha)+'</td>' +
                    '<td>'+escapeHTML(b.razon || '-')+'</td>' +
                    '<td>'+escapeHTML(b.detalle || '-')+'</td>' +
                    '<td>'+escapeHTML(b.subcategoria || '-')+'</td>' +
                    '<td class="num" style="color:'+(b.tipo==='ingreso'?'#16a34a':'#dc2626')+';font-weight:600">'+(b.tipo==='ingreso'?'+':'-')+fmtNum(b.importe || 0)+'‚Ç¨</td>' +
                    '<td class="num">'+benPct+'</td>' +
                    '<td>'+facturaLink+'</td>' +
                    '<td><span class="estado-badge '+escapeHTML(estadoClass)+'">'+escapeHTML(b.estado || 'pendiente')+'</span></td>' +
                    '<td class="table-actions"><button onclick="editBalance('+realIdx+')">‚úèÔ∏è</button><button onclick="prepDelBalance('+realIdx+')">üóëÔ∏è</button></td>' +
                '</tr>';
            }).join('');
        }
        
        // Calcular totales
        calcularBalanceTotales(data);
    }
    
    function calcularBalanceTotales(data) {
        let ingresos = 0, gastos = 0;
        data.forEach(b => {
            const importe = parseFloat(b.importe) || 0;
            if (b.tipo === 'ingreso') ingresos += importe;
            else gastos += importe;
        });
        document.getElementById('totalIngresos').textContent = fmtNum(ingresos) + ' ‚Ç¨';
        document.getElementById('totalGastos').textContent = fmtNum(gastos) + ' ‚Ç¨';
        document.getElementById('balanceNeto').textContent = (ingresos - gastos >= 0 ? '+' : '') + fmtNum(ingresos - gastos) + ' ‚Ç¨';
        document.getElementById('balanceNeto').style.color = ingresos - gastos >= 0 ? '#16a34a' : '#dc2626';
        
        // Calcular desglose por raz√≥n
        renderDesglose(data);
    }
    
    function renderDesglose(data) {
        const desglose = {};
        data.forEach(b => {
            const razon = b.razon || 'Otros';
            if (!desglose[razon]) desglose[razon] = { ingresos: 0, gastos: 0 };
            const importe = parseFloat(b.importe) || 0;
            if (b.tipo === 'ingreso') desglose[razon].ingresos += importe;
            else desglose[razon].gastos += importe;
        });
        
        const container = document.getElementById('balanceDesglose');
        container.innerHTML = Object.keys(desglose).sort().map(razon => {
            const d = desglose[razon];
            return '<div class="desglose-item">' +
                '<div class="razon"><input type="checkbox" checked onchange="filterDesglose()"> '+escapeHTML(razon)+'</div>' +
                '<div class="valores"><span class="ingresos">+'+fmtNum(d.ingresos)+'‚Ç¨</span><span class="gastos">-'+fmtNum(d.gastos)+'‚Ç¨</span></div>' +
            '</div>';
        }).join('');
    }
    
    function toggleDesglose() {
        const container = document.getElementById('balanceDesglose');
        container.style.display = document.getElementById('toggleDesglose').checked ? 'grid' : 'none';
    }
    
    function filterBalance() {
        renderBalance();
    }
    
    function sortBalance(col) {
        if (balanceSortCol === col) balanceSortAsc = !balanceSortAsc;
        else { balanceSortCol = col; balanceSortAsc = true; }
        renderBalance();
    }
    
    function abrirModalBalance() {
        document.getElementById('modalBalanceTitle').textContent = '‚ûï Nueva Transacci√≥n';
        document.getElementById('balanceId').value = '';
        document.getElementById('balanceRow').value = '';
        document.getElementById('balanceTipo').value = 'gasto';
        document.getElementById('balanceFecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('balanceRazon').value = 'Otros';
        document.getElementById('balanceDetalle').value = '';
        document.getElementById('balanceImporte').value = '';
        document.getElementById('balanceEstado').value = 'pendiente';
        document.getElementById('balanceFactura').value = '';
        document.getElementById('balanceFacturaUrl').value = '';
        document.getElementById('balanceNotas').value = '';
        abrirModal('modalBalance');
    }
    
    function editBalance(idx) {
        const b = cache.balance[idx];
        if (!b) return;
        document.getElementById('modalBalanceTitle').textContent = '‚úèÔ∏è Editar Transacci√≥n';
        document.getElementById('balanceId').value = b.id || '';
        document.getElementById('balanceRow').value = idx + 2;
        document.getElementById('balanceTipo').value = b.tipo || 'gasto';
        document.getElementById('balanceFecha').value = b.fecha || '';
        document.getElementById('balanceRazon').value = b.razon || 'Otros';
        document.getElementById('balanceDetalle').value = b.detalle || '';
        document.getElementById('balanceImporte').value = b.importe || '';
        document.getElementById('balanceEstado').value = b.estado || 'pendiente';
        document.getElementById('balanceFacturaUrl').value = b.factura || '';
        document.getElementById('balanceNotas').value = b.notas || '';
        abrirModal('modalBalance');
    }
    
    async function guardarBalance() {
        const id = document.getElementById('balanceId').value || (cache.balance.length + 1);
        const row = document.getElementById('balanceRow').value;
        const tipo = document.getElementById('balanceTipo').value;
        const fecha = document.getElementById('balanceFecha').value;
        const razon = document.getElementById('balanceRazon').value;
        const detalle = document.getElementById('balanceDetalle').value;
        const importe = document.getElementById('balanceImporte').value;
        const estado = document.getElementById('balanceEstado').value;
        let factura = document.getElementById('balanceFacturaUrl').value;
        const notas = document.getElementById('balanceNotas').value;
        
        if (!fecha || !importe) { toast('Completa fecha e importe', 'error'); return; }
        
        // Subir factura si hay
        const facturaFile = document.getElementById('balanceFactura').files[0];
        if (facturaFile) {
            try {
                toast('Subiendo factura...', 'info');
                factura = await subirFacturaBalance(facturaFile, tipo, razon, fecha);
            } catch(e) { console.error(e); }
        }
        
        const data = [id, tipo, fecha, razon, detalle, importe, factura, estado, notas];
        
        try {
            if (row) {
                await writeRow('balance', parseInt(row), data);
            } else {
                await appendRow('balance', data);
            }
            toast('Transacci√≥n guardada', 'success');
            cerrarModal('modalBalance');
            cache.balance = await readSheetData('balance');
            renderBalance();
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    async function subirFacturaBalance(file, tipo, razon, fecha) {
        await initDriveFolders();
        const year = fecha ? new Date(fecha).getFullYear() : new Date().getFullYear();
        
        const yearFolderId = await getOrCreateFolder(String(year), DRIVE_FOLDERS.tickets);
        const tipoFolder = tipo === 'ingreso' ? 'Ingresos' : 'Gastos';
        const subFolder = tipo === 'ingreso' ? 'Facturas' : 'Recibos';
        
        const tipoFolderId = await getOrCreateFolder(tipoFolder, yearFolderId);
        const subFolderId = await getOrCreateFolder(subFolder, tipoFolderId);
        
        const fileName = razon + '_' + fecha + '_' + file.name;
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify({ name: fileName, parents: [subFolderId] })], { type: 'application/json' }));
        form.append('file', file);
        
        const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token },
            body: form
        });
        const result = await resp.json();
        return 'https://drive.google.com/file/d/' + result.id + '/view';
    }
    
    function prepDelBalance(idx) {
        document.getElementById('delTipo').value = 'balance';
        document.getElementById('delRow').value = idx + 2;
        const input = document.getElementById('confirmInput');
        const btn = document.getElementById('btnConfirmDel');
        input.value = '';
        btn.disabled = true;
        input.oninput = function() { btn.disabled = this.value !== 'Borrar'; };
        abrirModal('modalConfirm');
    }
    
    function exportarBalance() {
        abrirModal('modalExportarBalance');
    }
    
    async function ejecutarExportacionBalance() {
        const formato = document.querySelector('input[name="exportBalanceFormato"]:checked').value;
        const soloFiltrados = document.querySelector('input[name="exportBalanceDatos"]:checked').value === 'filtros';
        
        let data = [...cache.balance];
        if (soloFiltrados) {
            if (balanceFilterYear) data = data.filter(b => b.fecha && new Date(b.fecha).getFullYear() == balanceFilterYear);
            if (balanceFilterTipo) data = data.filter(b => b.tipo === balanceFilterTipo);
        }
        
        // Construir datos seg√∫n columnas seleccionadas
        const rows = data.map(b => {
            const row = {};
            if (document.getElementById('expBalTipo').checked) row['Tipo'] = b.tipo;
            if (document.getElementById('expBalFecha').checked) row['Fecha'] = b.fecha;
            if (document.getElementById('expBalRazon').checked) row['Raz√≥n'] = b.razon;
            if (document.getElementById('expBalDetalle').checked) row['Detalle'] = b.detalle;
            if (document.getElementById('expBalImporte').checked) row['Importe'] = (b.tipo === 'ingreso' ? '+' : '-') + fmtNum(b.importe || 0) + '‚Ç¨';
            if (document.getElementById('expBalEstado').checked) row['Estado'] = b.estado;
            if (document.getElementById('expBalNotas').checked) row['Notas'] = b.notas;
            return row;
        });
        
        if (formato === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Balance');
            XLSX.writeFile(wb, 'balance_' + (soloFiltrados && balanceFilterYear ? balanceFilterYear : 'todos') + '.xlsx');
        } else {
            // PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFontSize(16);
            doc.text('Balance ' + (soloFiltrados && balanceFilterYear ? balanceFilterYear : 'Completo'), 14, 15);
            doc.setFontSize(10);
            doc.text('Generado: ' + new Date().toLocaleDateString('es-ES'), 14, 22);
            
            const headers = Object.keys(rows[0] || {});
            const body = rows.map(r => headers.map(h => r[h] || ''));
            
            doc.autoTable({
                head: [headers],
                body: body,
                startY: 28,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [15, 42, 46] }
            });
            doc.save('balance_' + (soloFiltrados && balanceFilterYear ? balanceFilterYear : 'todos') + '.pdf');
        }
        
        cerrarModal('modalExportarBalance');
        toast('Balance exportado', 'success');
    }
    
    function exportarResumen() {
        abrirModal('modalExportarResumen');
    }
    
    async function ejecutarExportacionResumen() {
        const formato = document.querySelector('input[name="exportResumenFormato"]:checked').value;
        const usarFiltro = document.querySelector('input[name="exportResumenPeriodo"]:checked').value === 'filtro';
        const yearFilter = usarFiltro ? balanceFilterYear : null;
        
        let ingresos = 0, gastos = 0;
        const desglose = {};
        const mensual = {};
        
        cache.balance.forEach(b => {
            if (yearFilter && (!b.fecha || new Date(b.fecha).getFullYear() != yearFilter)) return;
            const importe = parseFloat(b.importe) || 0;
            const razon = b.razon || 'Otros';
            
            if (!desglose[razon]) desglose[razon] = { ingresos: 0, gastos: 0 };
            if (b.tipo === 'ingreso') { 
                ingresos += importe; 
                desglose[razon].ingresos += importe; 
            } else { 
                gastos += importe; 
                desglose[razon].gastos += importe; 
            }
            
            // Mensual
            if (b.fecha) {
                const mes = b.fecha.substring(0, 7); // YYYY-MM
                if (!mensual[mes]) mensual[mes] = { ingresos: 0, gastos: 0 };
                if (b.tipo === 'ingreso') mensual[mes].ingresos += importe;
                else mensual[mes].gastos += importe;
            }
        });
        
        const rows = [];
        
        if (document.getElementById('expResTotales').checked) {
            rows.push({ Concepto: 'TOTAL INGRESOS', Ingresos: fmtNum(ingresos) + '‚Ç¨', Gastos: '', Neto: '' });
            rows.push({ Concepto: 'TOTAL GASTOS', Ingresos: '', Gastos: fmtNum(gastos) + '‚Ç¨', Neto: '' });
            rows.push({ Concepto: 'BALANCE NETO', Ingresos: '', Gastos: '', Neto: (ingresos - gastos >= 0 ? '+' : '') + fmtNum(ingresos - gastos) + '‚Ç¨' });
            rows.push({ Concepto: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Ingresos: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Gastos: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Neto: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' });
        }
        
        if (document.getElementById('expResDesglose').checked) {
            rows.push({ Concepto: 'DESGLOSE POR RAZ√ìN', Ingresos: '', Gastos: '', Neto: '' });
            Object.keys(desglose).sort().forEach(r => {
                const d = desglose[r];
                rows.push({ 
                    Concepto: '  ' + r, 
                    Ingresos: d.ingresos ? '+' + fmtNum(d.ingresos) + '‚Ç¨' : '-',
                    Gastos: d.gastos ? '-' + fmtNum(d.gastos) + '‚Ç¨' : '-',
                    Neto: (d.ingresos - d.gastos >= 0 ? '+' : '') + fmtNum(d.ingresos - d.gastos) + '‚Ç¨'
                });
            });
        }
        
        if (document.getElementById('expResMensual').checked) {
            rows.push({ Concepto: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Ingresos: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Gastos: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', Neto: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' });
            rows.push({ Concepto: 'DESGLOSE MENSUAL', Ingresos: '', Gastos: '', Neto: '' });
            Object.keys(mensual).sort().forEach(mes => {
                const m = mensual[mes];
                rows.push({ 
                    Concepto: '  ' + mes, 
                    Ingresos: m.ingresos ? '+' + fmtNum(m.ingresos) + '‚Ç¨' : '-',
                    Gastos: m.gastos ? '-' + fmtNum(m.gastos) + '‚Ç¨' : '-',
                    Neto: (m.ingresos - m.gastos >= 0 ? '+' : '') + fmtNum(m.ingresos - m.gastos) + '‚Ç¨'
                });
            });
        }
        
        if (formato === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Resumen');
            XLSX.writeFile(wb, 'resumen_balance_' + (yearFilter || 'todos') + '.xlsx');
        } else {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(18);
            doc.text('Resumen Balance ' + (yearFilter || 'Completo'), 14, 15);
            doc.setFontSize(10);
            doc.text('Generado: ' + new Date().toLocaleDateString('es-ES'), 14, 22);
            
            doc.autoTable({
                head: [['Concepto', 'Ingresos', 'Gastos', 'Neto']],
                body: rows.map(r => [r.Concepto, r.Ingresos, r.Gastos, r.Neto]),
                startY: 28,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [15, 42, 46] }
            });
            doc.save('resumen_balance_' + (yearFilter || 'todos') + '.pdf');
        }
        
        cerrarModal('modalExportarResumen');
        toast('Resumen exportado', 'success');
    }
    
    // ========== HIST√ìRICO ==========
    let historicoSortCol = 'id';
    let historicoSortAsc = true;
    
    function renderHistorico() {
        let data = [...cache.historico];
        
        // Obtener estados de checkboxes de columnas
        const showDocs = document.getElementById('histColDocs')?.checked || false;
        const showTecnico = document.getElementById('histColTecnico')?.checked || false;
        const showAlquiler = document.getElementById('histColAlquiler')?.checked || false;
        
        // Filtros de categor√≠a
        const showVenta = document.getElementById('histCatVenta')?.checked ?? true;
        const showTerceros = document.getElementById('histCatTerceros')?.checked ?? true;
        const showExportacion = document.getElementById('histCatExportacion')?.checked ?? true;
        
        // Llenar filtro de a√±os
        const years = [...new Set(data.map(h => h.fecha_venta ? new Date(h.fecha_venta).getFullYear() : null).filter(Boolean))].sort((a,b) => b-a);
        const yearSelect = document.getElementById('historicoYearFilter');
        const currentYearVal = yearSelect.value;
        yearSelect.innerHTML = '<option value="">Todos los a√±os</option>' + years.map(y => '<option value="'+y+'"'+(currentYearVal==y?' selected':'')+'>'+y+'</option>').join('');
        
        // Llenar filtro subcategor√≠as
        if (typeof poblarFiltroSubcategorias === "function") poblarFiltroSubcategorias();
        
        // Llenar filtro de subcategor√≠as
        const subcats = [...new Set(data.map(h => h.subcategoria).filter(Boolean))].sort();
        const subcatSelect = document.getElementById('historicoSubcatFilter');
        const currentSubcatVal = subcatSelect.value;
        subcatSelect.innerHTML = '<option value="">Todas subcategor√≠as</option>' + subcats.map(s => '<option value="'+escapeHTML(s)+'"'+(currentSubcatVal==s?' selected':'')+'>'+escapeHTML(s)+'</option>').join('');
        
        // Llenar filtro de marcas
        const marcas = [...new Set(data.map(h => h.marca).filter(Boolean))].sort();
        const marcaSelect = document.getElementById('historicoMarcaFilter');
        const currentMarcaVal = marcaSelect.value;
        marcaSelect.innerHTML = '<option value="">Todas las marcas</option>' + marcas.map(m => '<option value="'+escapeHTML(m)+'"'+(currentMarcaVal==m?' selected':'')+'>'+escapeHTML(m)+'</option>').join('');
        
        // Obtener valores de filtros
        const searchTerm = (document.getElementById('historicoSearch').value || '').toLowerCase();
        const yearFilter = document.getElementById('historicoYearFilter').value;
        const subcatFilter = document.getElementById('historicoSubcatFilter').value;
        const marcaFilter = document.getElementById('historicoMarcaFilter').value;
        
        // Aplicar filtros de categor√≠a
        data = data.filter(h => {
            const cat = (h.categoria || 'venta').toLowerCase();
            if (cat === 'venta' && !showVenta) return false;
            if (cat === 'terceros' && !showTerceros) return false;
            if (cat === 'exportacion' && !showExportacion) return false;
            return true;
        });
        
        // Aplicar otros filtros
        if (yearFilter) data = data.filter(h => h.fecha_venta && new Date(h.fecha_venta).getFullYear() == yearFilter);
        if (subcatFilter) data = data.filter(h => h.subcategoria === subcatFilter);
        if (marcaFilter) data = data.filter(h => h.marca === marcaFilter);
        if (searchTerm) {
            data = data.filter(h => 
                (h.marca || '').toLowerCase().includes(searchTerm) ||
                (h.matricula || '').toLowerCase().includes(searchTerm) ||
                (h.comprador || '').toLowerCase().includes(searchTerm) ||
                (h.id + '').includes(searchTerm)
            );
        }
        
        // Ordenar
        data.sort((a, b) => {
            let va = a[historicoSortCol] || '';
            let vb = b[historicoSortCol] || '';
            if (['id', 'precio_venta', 'precio', 'coste', 'precio_minimo', 'beneficio'].includes(historicoSortCol)) { 
                va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; 
            }
            if (historicoSortCol === 'fecha_venta' || historicoSortCol === 'adquisicion') { 
                va = new Date(va || 0); vb = new Date(vb || 0); 
            }
            if (va < vb) return historicoSortAsc ? -1 : 1;
            if (va > vb) return historicoSortAsc ? 1 : -1;
            return 0;
        });
        
        // Generar cabecera
        const thead = document.getElementById('historicoThead');
        let h = '<tr>';
        h += '<th class="sortable" onclick="sortHistorico(\'id\')">ID</th>';
        if (showDocs) h += '<th>IMG</th>';
        if (showDocs) h += '<th>DOCS</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'marca\')">Marca</th>';
        h += '<th>Matr√≠cula</th>';
        if (showTecnico) h += '<th class="sortable" onclick="sortHistorico(\'modelo\')">Modelo</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'a√±o\')">A√±o</th>';
        h += '<th>Categor√≠a</th>';
        h += '<th>Subcat</th>';
        h += '<th>Tipo</th>';
        if (showTecnico) h += '<th>Vol/Cap</th>';
        if (showTecnico) h += '<th>Comp</th>';
        if (showTecnico) h += '<th>Ejes</th>';
        if (showTecnico) h += '<th>B/C</th>';
        if (showTecnico) h += '<th>DD</th>';
        if (showTecnico) h += '<th>EXO</th>';
        if (showTecnico) h += '<th>44tn</th>';
        if (showTecnico) h += '<th>ADR</th>';
        if (showTecnico) h += '<th>ATP</th>';
        if (showTecnico) h += '<th>ITV</th>';
        if (showTecnico) h += '<th>Etiq</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'precio\')">Precio</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'precio_minimo\')">P.M√≠n</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'coste\')">Coste</th>';
        h += '<th>Mant</th>';
        if (showAlquiler) h += '<th>Alquiler</th>';
        h += '<th>C.Total</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'adquisicion\')">Adquis</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'fecha_venta\')">Vendido</th>';
        h += '<th class="sortable" onclick="sortHistorico(\'precio_venta\')">P.Venta</th>';
        h += '<th>Beneficio</th>';
        h += '<th>Comprador</th>';
        h += '<th>ACC</th>';
        h += '</tr>';
        thead.innerHTML = h;
        
        const tbody = document.getElementById('tHistorico');
        const colCount = 15 + (showDocs ? 2 : 0) + (showTecnico ? 11 : 0) + (showAlquiler ? 1 : 0);
        
        if (!data.length) {
            tbody.innerHTML = '<tr><td colspan="'+colCount+'" class="empty">No hay veh√≠culos en hist√≥rico</td></tr>';
        } else {
            tbody.innerHTML = data.map((v, i) => {
                const realIdx = cache.historico.indexOf(v);
                const img = v.imagenes ? (v.imagenes.split(',')[0] || '') : '';
                
                // Calcular totales
                let mantTotal = 0;
                if (v.mantenimiento_json) {
                    try {
                        const mant = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
                        mant.forEach(m => mantTotal += parseFloat(m.costo) || 0);
                    } catch(e) {}
                }
                let rentaTotal = 0;
                if (v.renta_json) {
                    try {
                        const renta = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json;
                        renta.forEach(r => rentaTotal += parseFloat(r.importe) || 0);
                    } catch(e) {}
                }
                const coste = parseFloat(v.coste) || 0;
                const costeTotal = coste + mantTotal;
                const precioVenta = parseFloat(v.precio_venta) || 0;
                const beneficio = precioVenta - costeTotal;
                
                // Determinar volumen/capacidad
                let volCap = '-';
                if (v.volumen && v.capacidad) volCap = v.volumen + '/' + v.capacidad;
                else if (v.volumen) volCap = v.volumen + 'L';
                else if (v.capacidad) volCap = v.capacidad + 'kg';
                
                // Categor√≠a badge
                const catText = (v.categoria || 'venta').charAt(0).toUpperCase() + (v.categoria || 'venta').slice(1);
                const catClass = v.categoria === 'exportacion' ? 'exportacion' : v.categoria === 'terceros' ? 'terceros' : 'venta';
                
                let r = '<tr>';
                r += '<td>'+(v.id || '-')+'</td>';
                if (showDocs) r += '<td>'+(img ? '<img src="'+escapeHTML(img)+'" style="width:50px;height:35px;object-fit:cover;border-radius:4px">' : '-')+'</td>';
                if (showDocs) r += '<td>'+(v.documentacion ? '<a href="'+escapeHTML(v.documentacion)+'" target="_blank">üìÅ</a>' : '-')+'</td>';
                r += '<td><strong>'+escapeHTML(v.marca || '-')+'</strong></td>';
                r += '<td>'+escapeHTML(v.matricula || '-')+'</td>';
                if (showTecnico) r += '<td>'+escapeHTML(v.modelo || '-')+'</td>';
                r += '<td>'+(v.a√±o || '-')+'</td>';
                r += '<td><span class="cat-badge '+catClass+'">'+catText+'</span></td>';
                r += '<td>'+escapeHTML(v.subcategoria || '-')+'</td>';
                r += '<td>'+escapeHTML(v.tipo || '-')+'</td>';
                if (showTecnico) r += '<td>'+escapeHTML(volCap)+'</td>';
                if (showTecnico) r += '<td>'+(v.compartimentos || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.ejes || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.bc || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.dd || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.exolum || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v['44tn'] || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.adr || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.atp || '-')+'</td>';
                if (showTecnico) r += '<td>'+(v.itv || '-')+'</td>';
                if (showTecnico) r += '<td>'+escapeHTML(v.etiqueta || '-')+'</td>';
                r += '<td class="num">'+(v.precio ? fmtNum(v.precio)+'‚Ç¨' : '-')+'</td>';
                r += '<td class="num">'+(v.precio_minimo ? fmtNum(v.precio_minimo)+'‚Ç¨' : '-')+'</td>';
                r += '<td class="num">'+(coste ? fmtNum(coste)+'‚Ç¨' : '-')+'</td>';
                r += '<td class="num"><span class="mant-link" onclick="verMantHistorico('+realIdx+')">'+(mantTotal ? fmtNum(mantTotal)+'‚Ç¨' : '-')+'</span></td>';
                if (showAlquiler) r += '<td class="num" style="color:#059669"><span class="mant-link" onclick="verRentaHistorico('+realIdx+')">'+(rentaTotal ? fmtNum(rentaTotal)+'‚Ç¨' : '-')+'</span></td>';
                r += '<td class="num" style="font-weight:600">'+(costeTotal ? fmtNum(costeTotal)+'‚Ç¨' : '-')+'</td>';
                r += '<td>'+fmtDate(v.adquisicion)+'</td>';
                r += '<td>'+fmtDate(v.fecha_venta)+'</td>';
                r += '<td class="num" style="color:#16a34a;font-weight:600">'+(precioVenta ? fmtNum(precioVenta)+'‚Ç¨' : '-')+'</td>';
                r += '<td class="num" style="color:'+(beneficio >= 0 ? '#16a34a' : '#dc2626')+';font-weight:600">'+(beneficio >= 0 ? '+' : '')+fmtNum(beneficio)+'‚Ç¨</td>';
                r += '<td>'+escapeHTML(v.comprador || '-')+'</td>';
                r += '<td class="table-actions"><button onclick="prepRestaurar('+realIdx+')" title="Restaurar">üîÑ</button></td>';
                r += '</tr>';
                return r;
            }).join('');
        }
    }
    
    function filterHistorico() {
        renderHistorico();
    }
    
    function sortHistorico(col) {
        if (historicoSortCol === col) historicoSortAsc = !historicoSortAsc;
        else { historicoSortCol = col; historicoSortAsc = true; }
        renderHistorico();
    }
    
    function verMantHistorico(idx) {
        const h = cache.historico[idx];
        if (!h || !h.mantenimiento_json) { toast('Sin datos de mantenimiento', 'info'); return; }
        try {
            const mant = typeof h.mantenimiento_json === 'string' ? JSON.parse(h.mantenimiento_json) : h.mantenimiento_json;
            let html = '<h4>Mantenimientos de '+escapeHTML(h.marca)+' '+escapeHTML(h.modelo)+'</h4><table class="mini-table"><tr><th>Fecha</th><th>Raz√≥n</th><th>Coste</th></tr>';
            mant.forEach(m => { html += '<tr><td>'+fmtDate(m.fecha)+'</td><td>'+escapeHTML(m.razon||'-')+'</td><td>'+fmtNum(m.costo||0)+'‚Ç¨</td></tr>'; });
            html += '</table>';
            toast(html, 'info', 10000);
        } catch(e) { toast('Error al leer datos', 'error'); }
    }
    
    function verRentaHistorico(idx) {
        const h = cache.historico[idx];
        if (!h || !h.renta_json) { toast('Sin datos de alquiler', 'info'); return; }
        try {
            const renta = typeof h.renta_json === 'string' ? JSON.parse(h.renta_json) : h.renta_json;
            let html = '<h4>Alquileres de '+escapeHTML(h.marca)+' '+escapeHTML(h.modelo)+'</h4><table class="mini-table"><tr><th>Desde</th><th>Hasta</th><th>Raz√≥n</th><th>Importe</th></tr>';
            renta.forEach(r => { html += '<tr><td>'+fmtDate(r.desde)+'</td><td>'+fmtDate(r.hasta)+'</td><td>'+escapeHTML(r.razon||'-')+'</td><td>'+fmtNum(r.importe||0)+'‚Ç¨</td></tr>'; });
            html += '</table>';
            toast(html, 'info', 10000);
        } catch(e) { toast('Error al leer datos', 'error'); }
    }
    
    function prepRestaurar(idx) {
        const h = cache.historico[idx];
        document.getElementById('restaurarMsg').innerHTML = '¬øDeseas restaurar <strong>'+escapeHTML(h.marca||'')+' '+escapeHTML(h.modelo||'')+'</strong> al cat√°logo activo?';
        document.getElementById('restaurarIdx').value = idx;
        const input = document.getElementById('restaurarInput');
        const btn = document.getElementById('btnConfirmRestaurar');
        input.value = '';
        btn.disabled = true;
        input.oninput = function() { btn.disabled = this.value !== 'Restaurar'; };
        abrirModal('modalRestaurar');
        setTimeout(() => input.focus(), 100);
    }
    
    async function confirmarRestaurar() {
        if (document.getElementById('restaurarInput').value !== 'Restaurar') { toast('Escribe "Restaurar"', 'error'); return; }
        
        const idx = parseInt(document.getElementById('restaurarIdx').value);
        const h = cache.historico[idx];
        if (!h) return;
        
        toast('Restaurando veh√≠culo...', 'info');
        
        // Helper para convertir a string si es objeto
        const toStr = (val) => {
            if (val === null || val === undefined) return '';
            if (typeof val === 'object') return JSON.stringify(val);
            return String(val);
        };
        
        try {
            // Restaurar categor√≠a original (venta o terceros, no exportacion)
            const catOriginal = h.categoria === 'exportacion' ? 'venta' : (h.categoria || 'venta');
            
            // Preparar datos para veh√≠culos (sin campos de venta)
            const vehData = [
                h.id, h.imagenes, catOriginal, h.subcategoria, h.marca, h.modelo, h.a√±o, h.precio,
                h.ubicacion, h.ubicacion_en, h.descripcion, h.descripcion_en, toStr(h.filtros_json), toStr(h.caracteristicas_json),
                'publicado', h.matricula, h.documentacion, h.ejes, h.bc, h.dd, h.exolum, h['44tn'], h.adr, h.atp,
                h.itv, h.etiqueta, h.motor, h.potencia, h.tipo, h.compartimentos, h.volumen, h.capacidad,
                h.precio_minimo, h.coste, toStr(h.mantenimiento_json), h.adquisicion, toStr(h.renta_json), h.precio_alquiler
            ];
            
            // A√±adir a veh√≠culos
            await appendRow('vehiculos', vehData);
            
            // Eliminar de hist√≥rico
            await deleteRow('historico', idx + 2);
            
            // Buscar y eliminar la entrada correspondiente en balance
            // Buscar por ID de veh√≠culo en las notas o por fecha_venta + marca
            const balanceIdx = cache.balance.findIndex(b => 
                (b.notas && b.notas.includes('ID: ' + h.id)) ||
                (b.fecha === h.fecha_venta && b.detalle && b.detalle.includes(h.marca))
            );
            if (balanceIdx !== -1) {
                await deleteRow('balance', balanceIdx + 2);
                toast('Entrada de balance eliminada', 'info');
            }
            
            toast('Veh√≠culo restaurado', 'success');
            cerrarModal('modalRestaurar');
            
            // Recargar datos
            cache.vehiculos = await readSheetData('vehiculos');
            cache.historico = await readSheetData('historico');
            cache.balance = await readSheetData('balance');
            renderHistorico();
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    function exportarHistorico() {
        abrirModal('modalExportarHistorico');
    }
    
    async function ejecutarExportacionHistorico() {
        const formato = document.querySelector('input[name="exportHistoricoFormato"]:checked').value;
        const soloFiltrados = document.querySelector('input[name="exportHistoricoDatos"]:checked').value === 'filtros';
        
        let data = [...cache.historico];
        
        // Aplicar filtros si es necesario
        if (soloFiltrados) {
            const yearFilter = document.getElementById('historicoYearFilter').value;
            const showVenta = document.getElementById('histCatVenta')?.checked ?? true;
            const showTerceros = document.getElementById('histCatTerceros')?.checked ?? true;
            const showExportacion = document.getElementById('histCatExportacion')?.checked ?? true;
            
            if (yearFilter) data = data.filter(h => h.fecha_venta && new Date(h.fecha_venta).getFullYear() == yearFilter);
            data = data.filter(h => {
                const cat = (h.categoria || 'venta').toLowerCase();
                if (cat === 'venta' && !showVenta) return false;
                if (cat === 'terceros' && !showTerceros) return false;
                if (cat === 'exportacion' && !showExportacion) return false;
                return true;
            });
        }
        
        const rows = data.map(v => {
            const row = {};
            
            // Calcular totales
            let mantTotal = 0, rentaTotal = 0;
            if (v.mantenimiento_json) {
                try { const m = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json; m.forEach(x => mantTotal += parseFloat(x.costo) || 0); } catch(e) {}
            }
            if (v.renta_json) {
                try { const r = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json; r.forEach(x => rentaTotal += parseFloat(x.importe) || 0); } catch(e) {}
            }
            const coste = parseFloat(v.coste) || 0;
            const costeTotal = coste + mantTotal;
            const precioVenta = parseFloat(v.precio_venta) || 0;
            const beneficio = precioVenta - costeTotal;
            
            // Columnas b√°sicas
            if (document.getElementById('expHistId')?.checked) row['ID'] = v.id;
            if (document.getElementById('expHistMarca')?.checked) row['Marca'] = v.marca;
            if (document.getElementById('expHistMatricula')?.checked) row['Matr√≠cula'] = v.matricula;
            if (document.getElementById('expHistAno')?.checked) row['A√±o'] = v.a√±o;
            if (document.getElementById('expHistCategoria')?.checked) row['Categor√≠a'] = v.categoria;
            if (document.getElementById('expHistSubcat')?.checked) row['Subcategor√≠a'] = v.subcategoria;
            if (document.getElementById('expHistTipo')?.checked) row['Tipo'] = v.tipo;
            
            // DOCS
            if (document.getElementById('expHistDocs')?.checked) row['Documentaci√≥n'] = v.documentacion || '-';
            
            // T√âCNICO
            if (document.getElementById('expHistModelo')?.checked) row['Modelo'] = v.modelo;
            if (document.getElementById('expHistVolCap')?.checked) row['Vol/Cap'] = v.volumen || v.capacidad || '-';
            if (document.getElementById('expHistComp')?.checked) row['Comp'] = v.compartimentos || '-';
            if (document.getElementById('expHistEjes')?.checked) row['Ejes'] = v.ejes || '-';
            if (document.getElementById('expHistBC')?.checked) row['B/C'] = v.bc || '-';
            if (document.getElementById('expHistDD')?.checked) row['DD'] = v.dd || '-';
            if (document.getElementById('expHistEXO')?.checked) row['EXO'] = v.exolum || '-';
            if (document.getElementById('expHist44tn')?.checked) row['44tn'] = v['44tn'] || '-';
            if (document.getElementById('expHistADR')?.checked) row['ADR'] = v.adr || '-';
            if (document.getElementById('expHistATP')?.checked) row['ATP'] = v.atp || '-';
            if (document.getElementById('expHistITV')?.checked) row['ITV'] = v.itv || '-';
            if (document.getElementById('expHistEtiq')?.checked) row['Etiq'] = v.etiqueta || '-';
            
            // Financieras
            if (document.getElementById('expHistPrecio')?.checked) row['Precio'] = v.precio ? fmtNum(v.precio) + '‚Ç¨' : '-';
            if (document.getElementById('expHistCoste')?.checked) row['Coste'] = coste ? fmtNum(coste) + '‚Ç¨' : '-';
            if (document.getElementById('expHistMant')?.checked) row['Mant'] = mantTotal ? fmtNum(mantTotal) + '‚Ç¨' : '-';
            if (document.getElementById('expHistAlquiler')?.checked) row['Alquiler'] = rentaTotal ? fmtNum(rentaTotal) + '‚Ç¨' : '-';
            if (document.getElementById('expHistCosteTotal')?.checked) row['Coste Total'] = costeTotal ? fmtNum(costeTotal) + '‚Ç¨' : '-';
            if (document.getElementById('expHistAdquis')?.checked) row['Adquisici√≥n'] = v.adquisicion || '-';
            if (document.getElementById('expHistFechaVenta')?.checked) row['Fecha Venta'] = v.fecha_venta || '-';
            if (document.getElementById('expHistPrecioVenta')?.checked) row['Precio Venta'] = precioVenta ? fmtNum(precioVenta) + '‚Ç¨' : '-';
            if (document.getElementById('expHistBeneficio')?.checked) row['Beneficio'] = (beneficio >= 0 ? '+' : '') + fmtNum(beneficio) + '‚Ç¨';
            if (document.getElementById('expHistComprador')?.checked) row['Comprador'] = v.comprador || '-';
            
            return row;
        });
        
        const yearFilter = document.getElementById('historicoYearFilter').value;
        const filename = 'historico_' + (soloFiltrados && yearFilter ? yearFilter : 'todos');
        
        if (formato === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Historico');
            XLSX.writeFile(wb, filename + '.xlsx');
        } else {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFontSize(16);
            doc.text('Hist√≥rico de Veh√≠culos', 14, 15);
            doc.setFontSize(10);
            doc.text('Generado: ' + new Date().toLocaleDateString('es-ES'), 14, 22);
            
            const headers = Object.keys(rows[0] || {});
            const body = rows.map(r => headers.map(h => r[h] || ''));
            
            doc.autoTable({
                head: [headers],
                body: body,
                startY: 28,
                styles: { fontSize: 6, cellPadding: 1 },
                headStyles: { fillColor: [15, 42, 46], fontSize: 6 }
            });
            doc.save(filename + '.pdf');
        }
        
        cerrarModal('modalExportarHistorico');
        toast('Hist√≥rico exportado', 'success');
    }
    
    // ========== FUNCI√ìN VENTA ACTUALIZADA ==========
    // A√±adir transacci√≥n a balance y mover a hist√≥rico
    async function procesarVenta(vehiculo, precioVenta, comprador, fecha, facturaUrl, tipoVenta = 'venta') {
        // Determinar raz√≥n para balance seg√∫n tipoVenta
        const razonBalance = tipoVenta === 'exportacion' ? 'Exportacion' : 'Venta';
        
        // Helper para convertir a string si es objeto
        const toStr = (val) => {
            if (val === null || val === undefined) return '';
            if (typeof val === 'object') return JSON.stringify(val);
            return String(val);
        };
        
        // 1. Crear entrada en balance
        const balanceData = [
            cache.balance.length + 1,
            'ingreso',
            fecha,
            razonBalance,
            (vehiculo.subcategoria || '') + ' ' + (vehiculo.tipo || '') + ' ' + (vehiculo.marca || '') + ' ' + (vehiculo.matricula || '') + ' (' + (vehiculo.a√±o || '') + ')',
            precioVenta,
            facturaUrl,
            'cobrado',
            (tipoVenta === 'exportacion' ? 'Exportaci√≥n' : tipoVenta === 'terceros' ? 'Venta terceros' : 'Venta') + ' de veh√≠culo ID: ' + vehiculo.id
        ];
        await appendRow('balance', balanceData);
        
        // 2. Mover a hist√≥rico (categoria guarda el tipoVenta)
        const historicoData = [
            vehiculo.id, vehiculo.imagenes, tipoVenta, vehiculo.subcategoria, vehiculo.marca, vehiculo.modelo,
            vehiculo.a√±o, vehiculo.precio, vehiculo.ubicacion, vehiculo.ubicacion_en, vehiculo.descripcion, vehiculo.descripcion_en,
            toStr(vehiculo.filtros_json), toStr(vehiculo.caracteristicas_json), 'vendido', vehiculo.matricula, vehiculo.documentacion,
            vehiculo.ejes, vehiculo.bc, vehiculo.dd, vehiculo.exolum, vehiculo['44tn'], vehiculo.adr, vehiculo.atp,
            vehiculo.itv, vehiculo.etiqueta, vehiculo.motor, vehiculo.potencia, vehiculo.tipo, vehiculo.compartimentos,
            vehiculo.volumen, vehiculo.capacidad, vehiculo.precio_minimo, vehiculo.coste, toStr(vehiculo.mantenimiento_json),
            vehiculo.adquisicion, toStr(vehiculo.renta_json), vehiculo.precio_alquiler, fecha, precioVenta, comprador
        ];
        await appendRow('historico', historicoData);
        
        return true;
    }
    
    // Sidebar toggle
    function toggleSidebar() {
        const sidebar = document.getElementById('adminSidebar');
        const icon = sidebar.querySelector('.toggle-icon');
        sidebar.classList.toggle('collapsed');
        icon.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    }
    
    // Fullscreen table
    let isFullscreen = false;
    function toggleFullscreen(containerId) {
        // Si no se pasa ID, usar el de veh√≠culos por defecto
        const container = containerId ? document.getElementById(containerId) : document.getElementById('section-vehiculos');
        if (!container) return;
        
        const isCurrentlyFullscreen = container.classList.contains('table-fullscreen');
        
        // Quitar fullscreen de cualquier otro contenedor
        document.querySelectorAll('.table-fullscreen').forEach(el => el.classList.remove('table-fullscreen'));
        
        if (!isCurrentlyFullscreen) {
            container.classList.add('table-fullscreen');
        }
        
        // Actualizar bot√≥n de veh√≠culos si existe
        const btn = document.getElementById('btnFullscreen');
        if (btn) {
            btn.textContent = container.classList.contains('table-fullscreen') ? '‚õ∂ Pantalla normal' : '‚õ∂ Pantalla completa';
        }
    }
    
    // Exportar veh√≠culos
    function abrirModalExportar() {
        document.querySelector('input[name="exportFormato"][value="pdf"]').checked = true;
        document.querySelector('input[name="exportDatos"][value="todo"]').checked = true;
        document.querySelector('input[name="exportColumnas"][value="todas"]').checked = true;
        document.getElementById('exclId').checked = false;
        document.getElementById('exclImg').checked = false;
        document.getElementById('exclCat').checked = false;
        document.getElementById('exclSubcat').checked = false;
        document.getElementById('exclPrecio').checked = false;
        document.getElementById('exclEstado').checked = false;
        document.getElementById('exclAcc').checked = true;
        abrirModal('modalExportar');
    }
    
    let vehiculosFiltradosActuales = [];
    
    async function ejecutarExportacion() {
        const formato = document.querySelector('input[name="exportFormato"]:checked').value;
        const datos = document.querySelector('input[name="exportDatos"]:checked').value;
        const columnas = document.querySelector('input[name="exportColumnas"]:checked').value;
        let vehiculos = datos === 'todo' ? cache.vehiculos : vehiculosFiltradosActuales;
        if (!vehiculos.length) { toast('No hay veh√≠culos para exportar', 'error'); return; }
        const excluir = {
            id: document.getElementById('exclId').checked,
            img: document.getElementById('exclImg').checked,
            cat: document.getElementById('exclCat').checked,
            subcat: document.getElementById('exclSubcat').checked,
            precio: document.getElementById('exclPrecio').checked,
            estado: document.getElementById('exclEstado').checked
        };
        const soloActivas = columnas === 'activas';
        toast('Generando exportaci√≥n...', 'info');
        if (formato === 'excel') await exportarExcel(vehiculos, excluir, soloActivas);
        else await exportarPDF(vehiculos, excluir, soloActivas);
        cerrarModal('modalExportar');
    }
    
    function getColumnasExportar(vehiculos, excluir, soloActivas) {
        // Verificar qu√© datos existen
        const tieneDoc = vehiculos.some(v => v.documentacion);
        const tieneMatricula = vehiculos.some(v => v.matricula);
        const tieneTipo = vehiculos.some(v => v.tipo);
        const tieneMotor = vehiculos.some(v => v.motor);
        const tienePotencia = vehiculos.some(v => v.potencia);
        const tieneEjes = vehiculos.some(v => v.ejes);
        const tieneBC = vehiculos.some(v => v.bc === true || v.bc === 'TRUE');
        const tieneDD = vehiculos.some(v => v.dd === true || v.dd === 'TRUE');
        const tieneExolum = vehiculos.some(v => v.exolum === true || v.exolum === 'TRUE');
        const tiene44tn = vehiculos.some(v => v['44tn'] === true || v['44tn'] === 'TRUE');
        const tieneADR = vehiculos.some(v => v.adr);
        const tieneATP = vehiculos.some(v => v.atp);
        const tieneITV = vehiculos.some(v => v.itv);
        const tieneEtiqueta = vehiculos.some(v => v.etiqueta);
        const tienePrecioMin = vehiculos.some(v => v.precio_minimo);
        const tieneCoste = vehiculos.some(v => v.coste);
        const tieneMant = vehiculos.some(v => v.mantenimiento_json && (Array.isArray(v.mantenimiento_json) ? v.mantenimiento_json.length : true));
        const tieneAdq = vehiculos.some(v => v.adquisicion);
        const tieneCompartimentos = vehiculos.some(v => v.compartimentos);
        const tieneVolCap = vehiculos.some(v => v.filtros_json?.volumen || v.filtros_json?.capacidad);
        
        // Determinar tipo de volumen/capacidad
        const tieneCisternas = vehiculos.some(v => esCisterna(v));
        const tieneNoCisternas = vehiculos.some(v => !esCisterna(v));
        let volCapLabel = 'Vol./Cap.';
        if (tieneCisternas && !tieneNoCisternas) volCapLabel = 'Volumen';
        else if (!tieneCisternas && tieneNoCisternas) volCapLabel = 'Capacidad';
        
        // Si solo activas, respetar configuraci√≥n de grupos
        const showMat = soloActivas ? columnaVisible('matricula') : true;
        const showDoc = soloActivas ? columnaVisible('documentacion') : true;
        const showTec = soloActivas ? (columnaVisible('motor') || columnaVisible('potencia') || columnaVisible('ejes')) : true;
        const showCue = soloActivas ? (columnaVisible('coste') || columnaVisible('mantenimiento') || columnaVisible('renta')) : true;
        
        const cols = [];
        if (!excluir.id) cols.push({ key: 'id', label: 'ID', get: v => v.id || '' });
        if (!excluir.img) cols.push({ key: 'img', label: 'Imagen', get: v => Array.isArray(v.imagenes) ? v.imagenes[0] : (v.imagenes || '').split(',')[0] });
        if (showDoc && tieneDoc) cols.push({ key: 'doc', label: 'Doc.', get: v => v.documentacion ? 'S√≠' : '' });
        cols.push({ key: 'marca', label: 'Marca', get: v => v.marca || '' });
        if (showMat && tieneMatricula) cols.push({ key: 'matricula', label: 'Matr√≠cula', get: v => v.matricula || '' });
        cols.push({ key: 'modelo', label: 'Modelo', get: v => v.modelo || '' });
        cols.push({ key: 'a√±o', label: 'A√±o', get: v => v.a√±o || '' });
        if (!excluir.cat) cols.push({ key: 'cat', label: 'Categor√≠a', get: v => v.categoria || '' });
        if (!excluir.subcat) cols.push({ key: 'subcat', label: 'Subcategor√≠a', get: v => v.subcategoria || '' });
        if (tieneTipo) cols.push({ key: 'tipo', label: 'Tipo', get: v => v.tipo || '' });
        if (showTec && tieneMotor) cols.push({ key: 'motor', label: 'Motor', get: v => v.motor || '' });
        if (tienePotencia) cols.push({ key: 'potencia', label: 'CV', get: v => v.potencia || '' });
        if (tieneVolCap) cols.push({ key: 'volcap', label: volCapLabel, get: v => v.filtros_json?.volumen || v.filtros_json?.capacidad || '' });
        if (tieneCompartimentos && tieneCisternas) cols.push({ key: 'comp', label: 'Comp.', get: v => esCisterna(v) ? (v.compartimentos || '') : '' });
        if (showTec && tieneEjes) cols.push({ key: 'ejes', label: 'Ejes', get: v => v.ejes || '' });
        if (showTec && tieneBC) cols.push({ key: 'bc', label: 'B/C', get: v => (v.bc === true || v.bc === 'TRUE') ? 'S√≠' : '' });
        if (showTec && tieneDD) cols.push({ key: 'dd', label: 'DD', get: v => (v.dd === true || v.dd === 'TRUE') ? 'S√≠' : '' });
        if (showTec && tieneExolum) cols.push({ key: 'exolum', label: 'EXOLUM', get: v => (v.exolum === true || v.exolum === 'TRUE') ? 'S√≠' : '' });
        if (showTec && tiene44tn) cols.push({ key: '44tn', label: '44tn', get: v => (v['44tn'] === true || v['44tn'] === 'TRUE') ? 'S√≠' : '' });
        if (showTec && tieneADR) cols.push({ key: 'adr', label: 'ADR', get: v => v.adr || '' });
        if (showTec && tieneATP) cols.push({ key: 'atp', label: 'ATP', get: v => v.atp || '' });
        if (showTec && tieneITV) cols.push({ key: 'itv', label: 'ITV', get: v => v.itv || '' });
        if (showTec && tieneEtiqueta) cols.push({ key: 'etiqueta', label: 'Etiqueta', get: v => v.etiqueta || '' });
        if (!excluir.precio) {
            cols.push({ key: 'precio', label: 'Precio', get: v => {
                const cats = (v.categoria || '').toLowerCase();
                const esAlquiler = cats.includes('alquiler');
                const precioVenta = v.precio;
                const precioAlq = v.precio_alquiler;
                // Si es alquiler y tiene precio alquiler, mostrar con /mes
                if (esAlquiler && precioAlq) return precioAlq + '/mes';
                // Si tiene precio venta
                if (precioVenta) return precioVenta;
                return '';
            }});
        }
        if (showCue && tienePrecioMin) cols.push({ key: 'precio_min', label: 'P.M√≠n.', get: v => v.precio_minimo || '' });
        if (showCue && tieneCoste) cols.push({ key: 'coste', label: 'Coste', get: v => v.coste || '' });
        if (showCue && tieneMant) cols.push({ key: 'mant', label: 'Mant.', get: v => {
            if (!v.mantenimiento_json) return '';
            const arr = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
            return arr.reduce((sum, m) => sum + (parseFloat(m.costo) || 0), 0) || '';
        }});
        if (showCue && (tieneCoste || tieneMant)) cols.push({ key: 'total', label: 'Total', get: v => {
            const coste = parseFloat(v.coste) || 0;
            let mant = 0;
            if (v.mantenimiento_json) {
                const arr = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
                mant = arr.reduce((sum, m) => sum + (parseFloat(m.costo) || 0), 0);
            }
            let renta = 0;
            if (v.renta_json) {
                const arr = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json;
                renta = arr.reduce((sum, r) => sum + (parseFloat(r.importe) || 0), 0);
            }
            return coste + mant - renta || '';
        }});
        if (showCue && tieneAdq) cols.push({ key: 'adq', label: 'Adquisici√≥n', get: v => v.adquisicion || '' });
        if (!excluir.estado) cols.push({ key: 'estado', label: 'Estado', get: v => v.estado || '' });
        return cols;
    }
    
    async function exportarExcel(vehiculos, excluir, soloActivas) {
        const cols = getColumnasExportar(vehiculos, excluir, soloActivas);
        const headers = cols.map(c => c.label);
        const rows = vehiculos.map(v => cols.map(c => c.get(v)));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        ws['!cols'] = headers.map(h => ({ wch: Math.max(h.length + 2, 12) }));
        XLSX.utils.book_append_sheet(wb, ws, 'Veh√≠culos');
        XLSX.writeFile(wb, 'vehiculos_' + new Date().toISOString().split('T')[0] + '.xlsx');
        toast('Excel exportado correctamente', 'success');
    }
    
    async function exportarPDF(vehiculos, excluir, soloActivas) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const cols = getColumnasExportar(vehiculos, excluir, soloActivas);
        const colsPDF = cols.slice(0, 14);
        doc.setFontSize(18);
        doc.text('Listado de Veh√≠culos - Tank Ib√©rica', 14, 15);
        doc.setFontSize(10);
        doc.text('Exportado: ' + new Date().toLocaleDateString('es-ES') + ' | Total: ' + vehiculos.length, 14, 22);
        const headers = colsPDF.map(c => c.label);
        const rows = vehiculos.map(v => colsPDF.map(c => {
            let val = c.get(v);
            if (typeof val === 'string' && val.length > 20) val = val.substring(0, 18) + '..';
            if (['precio', 'precio_min', 'coste', 'mant', 'total'].includes(c.key) && val) {
                if (typeof val === 'string' && val.includes('/mes')) {
                    val = fmtNum(val.replace('/mes', '')) + '‚Ç¨/mes';
                } else {
                    val = fmtNum(val) + '‚Ç¨';
                }
            }
            return val;
        }));
        doc.autoTable({
            head: [headers], body: rows, startY: 28,
            styles: { fontSize: 7, cellPadding: 1.5 },
            headStyles: { fillColor: [15, 42, 46], textColor: 255, fontSize: 7 },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });
        doc.save('vehiculos_' + new Date().toISOString().split('T')[0] + '.pdf');
        toast('PDF exportado correctamente', 'success');
    }
    
    // Mostrar/ocultar campo precio alquiler seg√∫n categor√≠as
    function updateCategorias() {
        const tieneAlquiler = document.getElementById('vehCatAlquiler').checked;
        const tieneVenta = document.getElementById('vehCatVenta').checked;
        const tieneTerceros = document.getElementById('vehCatTerceros').checked;
        
        // Mostrar precio alquiler si tiene alquiler
        document.getElementById('precioAlquilerGroup').style.display = tieneAlquiler ? 'block' : 'none';
        
        // Actualizar label de precio seg√∫n categor√≠as
        const precioLabel = document.querySelector('#precioVentaGroup label');
        if (tieneVenta || tieneTerceros) {
            precioLabel.textContent = 'Precio Venta ‚Ç¨';
        } else if (tieneAlquiler) {
            precioLabel.textContent = 'Precio ‚Ç¨';
        }
        
        updateSubcats();
    }

    function renderSub() {
        const t = document.getElementById('tSub');
        if (!cache.subcategorias.length) { t.innerHTML = '<tr><td colspan="6" class="empty">Sin subcategor√≠as</td></tr>'; return; }
        t.innerHTML = cache.subcategorias.map((s,i)=>{
            const upBtn = i > 0 ? '<button class="btn-move" onclick="moverSubcat('+i+',-1)" title="Subir">‚ñ≤</button>' : '<button class="btn-move" style="visibility:hidden">‚ñ≤</button>';
            const downBtn = i < cache.subcategorias.length-1 ? '<button class="btn-move" onclick="moverSubcat('+i+',1)" title="Bajar">‚ñº</button>' : '<button class="btn-move" style="visibility:hidden">‚ñº</button>';
            return '<tr><td>'+(parseInt(s.id)||i+1)+'</td><td><b>'+escapeHTML(s.nombre||'-')+'</b></td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">'+escapeHTML(s.filtros_aplicables||'-')+'</td><td>'+(parseInt(s.stock)||0)+'</td><td><span class="badge-estado '+(s.publicado?'publicado':'oculto')+'">'+(s.publicado?'Pub':'Oculto')+'</span></td><td class="table-actions">'+upBtn+downBtn+' <button onclick="editSubcat('+i+')">‚úèÔ∏è</button><button onclick="prepDel(\'subcategorias\','+(i+2)+')">üóëÔ∏è</button></td></tr>';
        }).join('');
    }
    function renderFil() {
        const t = document.getElementById('tFil');
        if (!cache.filtros.length) { t.innerHTML = '<tr><td colspan="7" class="empty">Sin filtros</td></tr>'; return; }
        t.innerHTML = cache.filtros.map((f,i)=>{
            const upBtn = i > 0 ? '<button class="btn-move" onclick="moverFiltro('+i+',-1)" title="Subir">‚ñ≤</button>' : '<button class="btn-move" style="visibility:hidden">‚ñ≤</button>';
            const downBtn = i < cache.filtros.length-1 ? '<button class="btn-move" onclick="moverFiltro('+i+',1)" title="Bajar">‚ñº</button>' : '<button class="btn-move" style="visibility:hidden">‚ñº</button>';
            // Determinar estado: publicado, oculto, inactivo
            const estado = normalizarEstadoFiltro(f);
            const estadoClass = estado === 'publicado' ? 'publicado' : (estado === 'oculto' ? 'nuevo' : 'oculto');
            const estadoText = estado === 'publicado' ? 'Pub' : (estado === 'oculto' ? 'Ocul' : 'Inact');
            return '<tr><td>'+(parseInt(f.id)||i+1)+'</td><td><b>'+escapeHTML(f.nombre||'-')+'</b>'+(f.unidad?' <small style="color:#666">('+escapeHTML(f.unidad)+')</small>':'')+'</td><td>'+escapeHTML(f.tipo||'-')+'</td><td style="max-width:100px;overflow:hidden;text-overflow:ellipsis;color:#22c55e">'+escapeHTML(f.extra_filtros||'-')+'</td><td style="max-width:100px;overflow:hidden;text-overflow:ellipsis;color:#ef4444">'+escapeHTML(f.ocultar_filtros||'-')+'</td><td><span class="badge-estado '+escapeHTML(estadoClass)+'">'+escapeHTML(estadoText)+'</span></td><td class="table-actions">'+upBtn+downBtn+' <button onclick="editFiltro('+i+')">‚úèÔ∏è</button><button onclick="prepDel(\'filtros\','+(i+2)+')">üóëÔ∏è</button></td></tr>';
        }).join('');
    }
    // Funci√≥n para mover subcategor√≠a arriba/abajo
    async function moverSubcat(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= cache.subcategorias.length) return;
        
        try {
            // Obtener datos de las dos filas a intercambiar
            const row1 = index + 2; // +2 porque la fila 1 es header
            const row2 = newIndex + 2;
            
            const data1 = cache.subcategorias[index];
            const data2 = cache.subcategorias[newIndex];
            
            // Preparar arrays de datos
            const arr1 = [data1.id, data1.nombre, data1.nombre_en||'', data1.filtros_aplicables||'', data1.publicado?'TRUE':'FALSE', data1.stock||0];
            const arr2 = [data2.id, data2.nombre, data2.nombre_en||'', data2.filtros_aplicables||'', data2.publicado?'TRUE':'FALSE', data2.stock||0];
            
            // Intercambiar en Google Sheets
            await writeRow('subcategorias', row1, arr2);
            await writeRow('subcategorias', row2, arr1);
            
            // Recargar datos
            cache.subcategorias = await readSheetData('subcategorias');
            renderSub();
            toast('Orden actualizado', 'success');
        } catch(e) {
            console.error(e);
            toast('Error al mover: ' + e.message, 'error');
        }
    }
    
    // Funci√≥n para mover filtro arriba/abajo
    async function moverFiltro(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= cache.filtros.length) return;
        
        try {
            const row1 = index + 2;
            const row2 = newIndex + 2;
            
            const data1 = cache.filtros[index];
            const data2 = cache.filtros[newIndex];
            
            // Preparar arrays de datos (columnas: id, nombre, nombre_en, tipo, estado, valores_default, extra_filtros, ocultar_filtros, unidad)
            // Compatibilidad: si no tiene estado, usar publicado para determinar
            const estado1 = data1.estado || (data1.publicado === true || data1.publicado === 'TRUE' ? 'publicado' : 'inactivo');
            const estado2 = data2.estado || (data2.publicado === true || data2.publicado === 'TRUE' ? 'publicado' : 'inactivo');
            const arr1 = [data1.id, data1.nombre, data1.nombre_en||'', data1.tipo||'', estado1, data1.valores_default||'', data1.extra_filtros||'', data1.ocultar_filtros||'', data1.unidad||''];
            const arr2 = [data2.id, data2.nombre, data2.nombre_en||'', data2.tipo||'', estado2, data2.valores_default||'', data2.extra_filtros||'', data2.ocultar_filtros||'', data2.unidad||''];
            
            // Intercambiar en Google Sheets
            await writeRow('filtros', row1, arr2);
            await writeRow('filtros', row2, arr1);
            
            // Recargar datos
            cache.filtros = await readSheetData('filtros');
            renderFil();
            toast('Orden actualizado', 'success');
        } catch(e) {
            console.error(e);
            toast('Error al mover: ' + e.message, 'error');
        }
    }

    
    // Actualizar badges de acciones pendientes
    function updatePendingBadges() {
        // Anunciantes sin contactar
        const anunciantesPendientes = (cache.anunciantes || []).filter(a => a.estado !== 'contactado').length;
        setBadge('badgeAnunciantes', anunciantesPendientes);
        
        // Solicitantes sin contactar
        const solicitantesPendientes = (cache.solicitantes || []).filter(s => s.estado !== 'contactado').length;
        setBadge('badgeSolicitantes', solicitantesPendientes);
        
        // Ojeados nuevos (√∫ltimos 7 d√≠as sin ver)
        const hace7dias = new Date();
        hace7dias.setDate(hace7dias.getDate() - 7);
        const ojeadosRecientes = (cache.ojeados || []).filter(o => {
            const fecha = new Date(o.fecha);
            return fecha >= hace7dias && !o.visto;
        }).length;
        setBadge('badgeOjeados', ojeadosRecientes);
        
        // Comentarios pendientes de moderar
        const comentariosPendientes = (cache.comentarios || []).filter(c => !c.moderado && c.moderado !== 'TRUE').length;
        setBadge('badgeCom', comentariosPendientes);
        
        // Contar chats sin leer
        const chatsSinLeer = cache.chatAgrupado?.filter(c => c.sin_leer).length || 0;
        setBadge('badgeChat', chatsSinLeer);
        
        // Badge del grupo Cat√°logo (suma de anunciantes + solicitantes + ojeados)
        const catalogoPendientes = anunciantesPendientes + solicitantesPendientes + ojeadosRecientes;
        setBadge('badgeCatalogo', catalogoPendientes);
        
        // Badge del grupo Comunicaci√≥n (comentarios)
        setBadge('badgeComunicacion', comentariosPendientes);
        
        // Badge del grupo Usuarios (chat pendiente)
        setBadge('badgeUsuarios', chatsSinLeer);
        
        // Actualizar Dashboard con resumen
        updateDashboardBadges(anunciantesPendientes, solicitantesPendientes, ojeadosRecientes, comentariosPendientes, chatsSinLeer);
    }
    
    function updateDashboardBadges(anunciantes, solicitantes, ojeados, comentarios, chats) {
        // Marcar tarjetas con pendientes (fondo rojo claro)
        const cardAnu = document.getElementById('cardAnu');
        const cardSol = document.getElementById('cardSol');
        const cardCom = document.getElementById('cardCom');
        const cardChat = document.getElementById('cardChat');
        
        if (cardAnu) cardAnu.classList.toggle('has-pending', anunciantes > 0);
        if (cardSol) cardSol.classList.toggle('has-pending', solicitantes > 0);
        if (cardCom) cardCom.classList.toggle('has-pending', comentarios > 0);
        if (cardChat) cardChat.classList.toggle('has-pending', chats > 0);
    }
    
    // Funci√≥n para actualizar dashboard de pendientes (llamada desde cargarChats)
    function actualizarDashboardPendientes() {
        const anunciantes = (cache.anunciantes || []).filter(a => a.estado !== 'contactado' && a.estado !== 'Contactado').length;
        const solicitantes = (cache.solicitantes || []).filter(s => s.estado !== 'contactado' && s.estado !== 'Contactado').length;
        const ojeados = (cache.ojeados || []).filter(o => !o.contactado && o.contactado !== 'TRUE').length;
        const comentarios = (cache.comentarios || []).filter(c => !c.moderado && c.moderado !== 'TRUE').length;
        const chats = cache.chatAgrupado?.filter(c => c.sin_leer).length || 0;
        updateDashboardBadges(anunciantes, solicitantes, ojeados, comentarios, chats);
    }

    function renderAnu() {
        const t = document.getElementById('tAnu');
        if (!cache.anunciantes.length) { t.innerHTML = '<tr><td colspan="10" class="empty">Sin anunciantes</td></tr>'; return; }
        t.innerHTML = cache.anunciantes.map((a,i)=>'<tr class="'+(a.vehiculo_match_id?'highlight-row':'')+'"><td>'+(parseInt(a.id)||i+1)+'</td><td><b>'+escapeHTML(a.nombre||'-')+'</b></td><td>'+escapeHTML(a.email||'')+'<br><small>'+escapeHTML(a.telefono||'')+'</small></td><td>'+escapeHTML(a.vehiculo||'-')+'</td><td>'+(a.precio?fmtNum(a.precio)+'‚Ç¨':'-')+'</td><td>'+fmtDate(a.fecha)+'</td><td><span class="badge-estado '+(a.estado==='contactado'?'publicado':'nuevo')+'">'+escapeHTML(a.estado||'nuevo')+'</span></td><td class="table-actions"><button onclick="marcarContactado(\'anunciantes\','+i+')">‚úÖ</button></td></tr>').join('');
    }
    function renderSol() {
        const t = document.getElementById('tSol');
        if (!cache.solicitantes.length) { t.innerHTML = '<tr><td colspan="10" class="empty">Sin solicitantes</td></tr>'; return; }
        t.innerHTML = cache.solicitantes.map((s,i)=>'<tr class="'+(s.vehiculo_match_id?'highlight-row':'')+'"><td>'+(parseInt(s.id)||i+1)+'</td><td><b>'+escapeHTML(s.nombre||'-')+'</b></td><td>'+escapeHTML(s.email||'')+'<br><small>'+escapeHTML(s.telefono||'')+'</small></td><td>'+escapeHTML(s.requisitos||'-')+'</td><td>'+fmtDate(s.fecha)+'</td><td>'+(s.vehiculo_match_id?'<a href="#" onclick="goSection(\'vehiculos\')">#'+(parseInt(s.vehiculo_match_id)||0)+'</a>':'-')+'</td><td><span class="badge-estado '+(s.estado==='contactado'?'publicado':'nuevo')+'">'+escapeHTML(s.estado||'nuevo')+'</span></td><td class="table-actions"><button onclick="marcarContactado(\'solicitantes\','+i+')">‚úÖ</button></td></tr>').join('');
    }
    function renderPos() {
        const t = document.getElementById('tPos');
        if (!cache.noticias.length) { t.innerHTML = '<tr><td colspan="10" class="empty">Sin posts</td></tr>'; return; }
        t.innerHTML = cache.noticias.map((p,i)=>'<tr><td>'+(parseInt(p.id)||i+1)+'</td><td><img src="'+escapeHTML(p.imagen||'')+'" style="width:50px;height:30px;object-fit:cover;border-radius:4px;background:#eee"></td><td><b>'+escapeHTML(p.titulo_es||'-')+'</b></td><td>'+escapeHTML(p.categoria||'-')+'</td><td>'+fmtDate(p.fecha)+'</td><td>'+(parseInt(p.vistas)||0)+'</td><td><span class="badge-estado '+(p.publicado?'publicado':'oculto')+'">'+(p.publicado?'Pub':'Borr')+'</span></td><td class="table-actions"><button onclick="toast(\'En desarrollo\',\'info\')">‚úèÔ∏è</button><button onclick="prepDel(\'noticias\','+(i+2)+')">üóëÔ∏è</button></td></tr>').join('');
    }
    function renderCom() {
        const t = document.getElementById('tCom');
        if (!cache.comentarios.length) { t.innerHTML = '<tr><td colspan="7" class="empty">Sin comentarios</td></tr>'; return; }
        t.innerHTML = cache.comentarios.map((c,i)=>'<tr><td>'+(parseInt(c.id)||i+1)+'</td><td>#'+(parseInt(c.noticia_id)||'-')+'</td><td><b>'+escapeHTML(c.nombre||'-')+'</b><br><small>'+escapeHTML(c.email||'')+'</small></td><td>'+escapeHTML((c.texto||'').substring(0,40))+'...</td><td>'+fmtDate(c.fecha)+'</td><td><span class="badge-estado '+(c.moderado?'publicado':'nuevo')+'">'+(c.moderado?'OK':'Pend')+'</span></td><td class="table-actions">'+(c.moderado?'':'<button onclick="aprobarCom('+i+')">‚úÖ</button>')+'<button onclick="prepDel(\'comentarios\','+(i+2)+')">üóëÔ∏è</button></td></tr>').join('');
    }
    function renderUsu() {
        const t = document.getElementById('tUsu');
        if (!cache.usuarios.length) { t.innerHTML = '<tr><td colspan="7" class="empty">Sin usuarios</td></tr>'; return; }
        t.innerHTML = cache.usuarios.map((u,i)=>'<tr><td>'+(parseInt(u.id)||i+1)+'</td><td><b>'+escapeHTML(u.pseudonimo||'-')+'</b></td><td>'+escapeHTML(u.nombre||'')+' '+escapeHTML(u.apellidos||'')+'</td><td>'+escapeHTML(u.email||'-')+'</td><td>'+fmtDate(u.fecha_registro)+'</td><td><span class="badge-estado '+(u.estado==='activo'?'publicado':'nuevo')+'">'+escapeHTML(u.estado||'-')+'</span></td><td class="table-actions"><button onclick="alert(\'Usuario: '+escapeHTML(u.pseudonimo||'-')+'\\nEmail: '+escapeHTML(u.email||'-')+'\')">üëÅÔ∏è</button></td></tr>').join('');
    }
    function renderSus() {
        const t = document.getElementById('tSus');
        if (!cache.suscripciones.length) { t.innerHTML = '<tr><td colspan="10" class="empty">Sin suscripciones</td></tr>'; return; }
        t.innerHTML = cache.suscripciones.map(s=>'<tr><td>'+escapeHTML(s.email||'-')+'</td><td>'+(s.registro_web?'‚úÖ':'‚ùå')+'</td><td>'+(s.area_prensa?'‚úÖ':'‚ùå')+'</td><td>'+(s.boletines?'‚úÖ':'‚ùå')+'</td><td>'+(s.destacados?'‚úÖ':'‚ùå')+'</td><td>'+(s.eventos?'‚úÖ':'‚ùå')+'</td><td>'+(s.respuestas?'‚úÖ':'‚ùå')+'</td><td>'+fmtDate(s.fecha)+'</td></tr>').join('');
    }
    
    // Banner
    async function loadBanner() {
        try {
            const cfg = await loadConfig();
            console.log('üì¢ Config banner cargada:', cfg?.banner);
            if (cfg?.banner) {
                document.getElementById('bannerEs').value = cfg.banner.valor_es || '';
                document.getElementById('bannerEn').value = cfg.banner.valor_en || '';
                document.getElementById('bannerUrl').value = cfg.banner.extra || '';
                document.getElementById('bannerDesde').value = cfg.banner.extra2 || '';
                document.getElementById('bannerHasta').value = cfg.banner.extra3 || '';
                document.getElementById('bannerActivo').checked = cfg.banner.activo === true || cfg.banner.activo === 'TRUE';
                
                // Actualizar estado en Dashboard
                actualizarEstadoBannerDashboard(cfg.banner);
            } else {
                actualizarEstadoBannerDashboard(null);
            }
        } catch(e) { console.error(e); actualizarEstadoBannerDashboard(null); }
    }
    
    function actualizarEstadoBannerDashboard(banner) {
        const card = document.getElementById('bannerStatusCard');
        const text = document.getElementById('bannerStatusText');
        const btn = document.getElementById('btnToggleBanner');
        const icon = document.getElementById('bannerStatusIcon');
        
        if (!card || !text || !btn) return;
        
        const isActive = banner && (banner.activo === true || banner.activo === 'TRUE');
        const mensaje = banner?.valor_es || '';
        
        card.classList.remove('active', 'inactive');
        card.classList.add(isActive ? 'active' : 'inactive');
        
        if (isActive) {
            icon.textContent = '‚úÖ';
            text.innerHTML = '<span style="color:#28a745">ACTIVO</span> - "' + escapeHTML(mensaje.substring(0,50) || 'Sin mensaje') + (mensaje.length > 50 ? '...' : '') + '"';
            btn.textContent = 'Desactivar';
        } else {
            icon.textContent = '‚ö†Ô∏è';
            text.innerHTML = '<span style="color:#ffc107">INACTIVO</span>' + (mensaje ? ' - "' + escapeHTML(mensaje.substring(0,30)) + '..."' : '');
            btn.textContent = 'Activar';
        }
    }
    
    async function toggleBannerRapido() {
        try {
            const cfg = await loadConfig();
            const isActive = cfg?.banner?.activo === true || cfg?.banner?.activo === 'TRUE';
            const nuevoEstado = isActive ? 'FALSE' : 'TRUE';
            
            // Columnas: clave | valor_es | valor_en | extra | extra2 | extra3 | activo
            const data = [
                'banner',
                cfg?.banner?.valor_es || '',
                cfg?.banner?.valor_en || '',
                cfg?.banner?.extra || '',
                cfg?.banner?.extra2 || '',
                cfg?.banner?.extra3 || '',
                nuevoEstado
            ];
            
            await writeRow('config', 2, data);
            toast('Banner ' + (nuevoEstado === 'TRUE' ? 'activado' : 'desactivado'), 'success');
            
            // Recargar para actualizar UI
            await loadBanner();
        } catch(e) { 
            console.error(e); 
            toast('Error: ' + e.message, 'error'); 
        }
    }
    
    async function guardarBanner() {
        try {
            // Columnas: clave | valor_es | valor_en | extra | extra2 | extra3 | activo
            const data = [
                'banner',
                document.getElementById('bannerEs').value,
                document.getElementById('bannerEn').value,
                document.getElementById('bannerUrl').value,
                document.getElementById('bannerDesde').value,
                document.getElementById('bannerHasta').value,
                document.getElementById('bannerActivo').checked ? 'TRUE' : 'FALSE'
            ];
            console.log('üíæ Guardando banner:', data);
            await writeRow('config', 2, data);
            toast('Banner guardado', 'success');
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    function previewBanner() {
        const txt = document.getElementById('bannerEs').value;
        const url = document.getElementById('bannerUrl').value;
        let html = escapeHTML(txt);
        if (url) {
            const isExternal = !url.includes(window.location.hostname) && !url.startsWith('/');
            const target = isExternal ? ' target="_blank"' : '';
            html += ' <a href="'+escapeHTML(url)+'"'+target+' style="color:#0F2A2E;font-weight:600;text-decoration:underline">M√°s informaci√≥n</a>';
        }
        const div = document.createElement('div');
        div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#fbbf24;color:#1F2A2A;padding:12px 20px;text-align:center;z-index:10002;font-size:14px';
        div.innerHTML = html + ' <button onclick="this.parentElement.remove()" style="margin-left:12px;background:none;border:none;font-size:18px;cursor:pointer">√ó</button>';
        document.body.appendChild(div);
    }
    
    // Selector de Estado con Sem√°foro
    function setEstadoVeh(estado) {
        document.getElementById('vehEstado').value = estado;
        // Actualizar visual
        document.querySelectorAll('.estado-option').forEach(opt => {
            opt.classList.remove('selected');
            const radio = opt.querySelector('input[type="radio"]');
            if (radio) radio.checked = false;
        });
        const selected = document.querySelector('.estado-option.' + estado);
        if (selected) {
            selected.classList.add('selected');
            const radio = selected.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        }
    }
    
    // Vehiculo Modal
    function abrirModalVehiculo() {
        document.getElementById('modalVehTitle').textContent = 'Nuevo Veh√≠culo';
        document.getElementById('vehId').value = '';
        document.getElementById('vehRow').value = '';
        // Categor√≠as m√∫ltiples
        document.getElementById('vehCatVenta').checked = false;
        document.getElementById('vehCatAlquiler').checked = false;
        document.getElementById('vehCatTerceros').checked = false;
        document.getElementById('vehMarca').value = '';
        document.getElementById('vehModelo').value = '';
        document.getElementById('vehAno').value = '';
        document.getElementById('vehPrecio').value = '';
        document.getElementById('vehPrecioAlquiler').value = '';
        document.getElementById('precioAlquilerGroup').style.display = 'none';
        document.getElementById('vehUbic').value = '';
        document.getElementById('vehUbicEn').value = '';
        document.getElementById('vehDesc').value = '';
        document.getElementById('vehDescEn').value = '';
        setEstadoVeh('publicado');
        document.getElementById('imgPreview').innerHTML = '';
        imgFiles = []; imgUrls = []; portada = 0;
        docFiles = []; docUrls = [];
        // Campos generales
        document.getElementById('vehMatricula').value = '';
        document.getElementById('vehDocumentacion').value = '';
        document.getElementById('docsPreview').innerHTML = '';
        document.getElementById('vehPrecioMin').value = '';
        document.getElementById('vehCoste').value = '';
        document.getElementById('vehAdquisicion').value = '';
        setMantData([]);
        setRentaData([]);
        calcCosteTotal();
        
        updateSubcats();
        renderFiltrosGrid();
        renderCaracteristicas({});
        abrirModal('modalVehiculo');
    }
    function editVeh(idx) {
        const v = cache.vehiculos[idx];
        document.getElementById('modalVehTitle').textContent = 'Editar Veh√≠culo';
        document.getElementById('vehId').value = v.id || idx+1;
        document.getElementById('vehRow').value = idx + 2;
        // Categor√≠as m√∫ltiples
        const cats = (v.categoria || '').toLowerCase().split(',').map(c => c.trim());
        document.getElementById('vehCatVenta').checked = cats.includes('venta');
        document.getElementById('vehCatAlquiler').checked = cats.includes('alquiler');
        document.getElementById('vehCatTerceros').checked = cats.includes('terceros');
        // Mostrar precio alquiler si aplica
        document.getElementById('precioAlquilerGroup').style.display = cats.includes('alquiler') ? 'block' : 'none';
        document.getElementById('vehPrecioAlquiler').value = v.precio_alquiler || '';
        updateSubcats();
        setTimeout(() => document.getElementById('vehSubcat').value = v.subcategoria || '', 50);
        document.getElementById('vehMarca').value = v.marca || '';
        document.getElementById('vehModelo').value = v.modelo || '';
        document.getElementById('vehAno').value = v.a√±o || '';
        document.getElementById('vehPrecio').value = v.precio || '';
        document.getElementById('vehUbic').value = v.ubicacion || '';
        document.getElementById('vehUbicEn').value = v.ubicacion_en || '';
        document.getElementById('vehDesc').value = v.descripcion || '';
        document.getElementById('vehDescEn').value = v.descripcion_en || '';
        // Estado
        const estado = v.estado || (v.publicado === true || v.publicado === 'TRUE' ? 'publicado' : 'oculto');
        setEstadoVeh(estado);
        imgUrls = Array.isArray(v.imagenes) ? [...v.imagenes] : (v.imagenes ? v.imagenes.split(',').map(u=>u.trim()) : []);
        imgFiles = [];
        portada = 0;
        renderImgPreview();
        renderFiltrosGrid(v.filtros_json);
        // Campos generales
        document.getElementById('vehMatricula').value = v.matricula || '';
        // Cargar documentos existentes (formato: nombre|url,nombre|url,...)
        docUrls = [];
        if (v.documentacion) {
            v.documentacion.split(',').forEach(item => {
                const trimmed = item.trim();
                if (trimmed) {
                    if (trimmed.includes('|')) {
                        const [name, url] = trimmed.split('|');
                        docUrls.push({ name: name, url: url });
                    } else {
                        // URL antigua sin nombre - intentar obtener el nombre del archivo de Drive
                        // Formato t√≠pico: https://drive.google.com/file/d/FILE_ID/view
                        const fileIdMatch = trimmed.match(/\/d\/([^\/]+)/);
                        if (fileIdMatch) {
                            // Guardar el ID para intentar obtener el nombre despu√©s
                            docUrls.push({ name: 'Documento', url: trimmed, fileId: fileIdMatch[1], needsName: true });
                        } else {
                            docUrls.push({ name: 'Documento', url: trimmed });
                        }
                    }
                }
            });
            // Intentar obtener nombres reales de Drive para URLs antiguas
            fetchDocNames();
        }
        docFiles = [];
        renderDocsPreview();
        document.getElementById('vehPrecioMin').value = v.precio_minimo || '';
        document.getElementById('vehCoste').value = v.coste || '';
        document.getElementById('vehAdquisicion').value = v.adquisicion || '';
        // Mantenimiento
        let mantData = [];
        if (v.mantenimiento_json) {
            try {
                mantData = typeof v.mantenimiento_json === 'string' ? JSON.parse(v.mantenimiento_json) : v.mantenimiento_json;
            } catch(e) {}
        }
        setMantData(mantData);
        // Renta
        let rentaData = [];
        if (v.renta_json) {
            try {
                rentaData = typeof v.renta_json === 'string' ? JSON.parse(v.renta_json) : v.renta_json;
            } catch(e) {}
        }
        setRentaData(rentaData);
        calcCosteTotal();
        // Parsear caracteristicas_json si es string
        let caracts = v.caracteristicas_json;
        if (typeof caracts === 'string' && caracts) {
            try { caracts = JSON.parse(caracts); } catch(e) { caracts = {}; }
        }
        renderCaracteristicas(caracts || {});
        abrirModal('modalVehiculo');
    }
    
    // Caracter√≠sticas adicionales
    function renderCaracteristicas(data) {
        const container = document.getElementById('caracteristicasContainer');
        // Asegurar que data es un objeto
        let obj = data;
        if (typeof obj === 'string') {
            try { obj = JSON.parse(obj); } catch(e) { obj = {}; }
        }
        if (!obj || typeof obj !== 'object') obj = {};
        
        const entries = Object.entries(obj);
        if (entries.length === 0) {
            container.innerHTML = createCaractRow('', '');
        } else {
            container.innerHTML = entries.map(([k, v]) => createCaractRow(k, v)).join('');
        }
    }
    function createCaractRow(nombre, valor) {
        return '<div class="caract-row"><input type="text" class="caract-nombre" placeholder="Caracter√≠stica" value="'+escapeHTML(nombre)+'"><input type="text" class="caract-valor" placeholder="Valor" value="'+escapeHTML(valor)+'"><button type="button" class="btn-remove-caract" onclick="removeCaracteristica(this)">√ó</button></div>';
    }
    function addCaracteristica() {
        document.getElementById('caracteristicasContainer').insertAdjacentHTML('beforeend', createCaractRow('', ''));
    }
    function removeCaracteristica(btn) {
        const container = document.getElementById('caracteristicasContainer');
        btn.parentElement.remove();
        if (container.children.length === 0) addCaracteristica();
    }
    function getCaracteristicas() {
        const result = {};
        document.querySelectorAll('.caract-row').forEach(row => {
            const nombre = row.querySelector('.caract-nombre')?.value?.trim();
            const valor = row.querySelector('.caract-valor')?.value?.trim();
            if (nombre && valor) result[nombre] = valor;
        });
        console.log('üìù Caracter√≠sticas obtenidas:', result);
        return result;
    }
    
    function updateSubcats() {
        const subs = cache.subcategorias.filter(s => s.publicado);
        document.getElementById('vehSubcat').innerHTML = '<option value="">Seleccionar</option>' + subs.map(s => '<option value="'+escapeHTML(s.nombre)+'">'+escapeHTML(s.nombre)+'</option>').join('');
    }
    
    function renderFiltrosGrid(vals = {}) {
        const grid = document.getElementById('filtrosGrid');
        if (!grid) return;
        
        const excluir = ['precio', 'marca', 'a√±o', 'ubicacion'];
        // Mostrar solo filtros NO inactivos (publicado u oculto)
        const filtros = cache.filtros.filter(f => {
            const estado = normalizarEstadoFiltro(f);
            return estado !== 'inactivo' && !excluir.includes((f.nombre||'').toLowerCase());
        });
        
        // vals puede tener formato: { "Clase": "valor" } o { "Clase": { es: "...", en: "..." } } o { "Cisterna": true }
        grid.innerHTML = filtros.map(f => {
            const nombre = f.nombre || f.id || '';
            const nombreEn = f.nombre_en || nombre;
            const nombreLower = nombre.toLowerCase();
            const tipo = (f.tipo || '').toLowerCase();
            
            // Para filtros tipo TICK, mostrar checkbox
            if (tipo === 'tick' || tipo === 'checkbox' || tipo === 'boolean') {
                let checked = false;
                if (vals && typeof vals === 'object') {
                    const keys = Object.keys(vals);
                    const matchKey = keys.find(k => k.toLowerCase() === nombreLower);
                    if (matchKey) {
                        const valor = vals[matchKey];
                        checked = valor === true || valor === 'TRUE' || valor === 'true' || valor === 'Si' || valor === 'S√≠' || valor === 'Yes' || valor === 1 || valor === '1';
                    }
                }
                
                return '<div class="filtro-item filtro-tick"><label class="checkbox-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 12px;background:#f8f9fa;border:1px solid #e5e7eb;border-radius:6px"><input type="checkbox" data-filtro="' + escapeHTML(nombre) + '" data-tipo="tick" ' + (checked ? 'checked' : '') + ' style="width:18px;height:18px"><span style="font-size:13px">' + escapeHTML(nombre) + ' <small style="color:#888">(' + escapeHTML(nombreEn) + ')</small></span></label></div>';
            }
            
            // Para otros tipos, mostrar campos biling√ºes
            let vEs = '', vEn = '';
            
            if (vals && typeof vals === 'object') {
                const keys = Object.keys(vals);
                const matchKey = keys.find(k => k.toLowerCase() === nombreLower);
                if (matchKey) {
                    const valor = vals[matchKey];
                    if (typeof valor === 'object' && valor !== null) {
                        vEs = valor.es || valor.ES || '';
                        vEn = valor.en || valor.EN || '';
                    } else {
                        vEs = valor || '';
                        vEn = '';
                    }
                }
            }
            
            return '<div class="filtro-item filtro-bilingue"><label>' + escapeHTML(nombre) + ' <small style="color:#888">(' + escapeHTML(nombreEn) + ')</small></label><div style="display:flex;gap:8px"><div style="flex:1"><span style="font-size:10px;color:#666">üá™üá∏ ES</span><input type="text" data-filtro="' + escapeHTML(nombre) + '" data-lang="es" value="' + escapeHTML(vEs) + '" placeholder="' + escapeHTML(f.tipo||'') + '"></div><div style="flex:1"><span style="font-size:10px;color:#666">üá¨üáß EN</span><input type="text" data-filtro="' + escapeHTML(nombre) + '" data-lang="en" value="' + escapeHTML(vEn) + '" placeholder="' + escapeHTML(f.tipo||'') + '"></div></div></div>';
        }).join('');
    }




    function handleImages(e) {
        const files = Array.from(e.target.files);
        if (imgUrls.length + imgFiles.length + files.length > 10) { toast('M√°x 10 im√°genes', 'error'); return; }
        imgFiles.push(...files);
        renderImgPreview();
    }
    
    // Variables para documentos
    // Documentos: se guardan como "nombre|url,nombre|url,..."
    let docFiles = [], docUrls = [];  // docUrls son objetos {name, url}
    
    function handleDocs(e) {
        const files = Array.from(e.target.files);
        if (docUrls.length + docFiles.length + files.length > 20) { toast('M√°x 20 documentos', 'error'); return; }
        docFiles.push(...files);
        renderDocsPreview();
    }
    
    // Obtener nombres reales de archivos de Drive
    async function fetchDocNames() {
        const docsNeedingNames = docUrls.filter(d => d.needsName && d.fileId);
        if (docsNeedingNames.length === 0) return;
        
        for (const doc of docsNeedingNames) {
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${doc.fileId}?fields=name`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (response.ok) {
                    const data = await response.json();
                    doc.name = data.name || 'Documento';
                    delete doc.needsName;
                    delete doc.fileId;
                }
            } catch(e) {
                console.log('No se pudo obtener nombre de archivo:', e);
            }
        }
        renderDocsPreview();
    }
    
    function renderDocsPreview() {
        const container = document.getElementById('docsPreview');
        if (!container) return;
        
        let html = '';
        
        // Documentos ya subidos (objetos {name, url})
        docUrls.forEach((doc, i) => {
            const name = doc.name || 'Documento';
            const url = doc.url || doc;
            const isEditing = doc.editing === true;
            
            if (isEditing) {
                html += '<div class="doc-preview"><input type="text" class="doc-name-edit" value="' + escapeHTML(name) + '" onkeypress="if(event.key===\'Enter\')saveDocName(' + i + ',this.value)" id="docNameInput' + i + '"><button class="edit-name" onclick="event.stopPropagation();saveDocName(' + i + ',document.getElementById(\'docNameInput' + i + '\').value)" title="Guardar">‚úì</button><button class="remove" onclick="event.stopPropagation();cancelEditDocName(' + i + ')">‚úï</button></div>';
            } else {
                html += '<div class="doc-preview"><a href="' + escapeHTML(url) + '" target="_blank">üìÑ ' + escapeHTML(name) + '</a><button class="edit-name" onclick="event.stopPropagation();editDocName(' + i + ')" title="Editar nombre">‚úèÔ∏è</button><button class="remove" onclick="event.stopPropagation();removeDoc(' + i + ')">X</button></div>';
            }
        });
        
        // Archivos pendientes de subir
        docFiles.forEach((file, i) => {
            html += '<div class="doc-preview doc-pending"><span>üìÑ ' + escapeHTML(file.name) + ' (pendiente)</span><button class="remove" onclick="event.stopPropagation();removeDoc(' + (docUrls.length + i) + ')">X</button></div>';
        });
        
        container.innerHTML = html;
        
        // Focus en input si est√° editando
        const editingIdx = docUrls.findIndex(d => d.editing);
        if (editingIdx >= 0) {
            const input = document.getElementById('docNameInput' + editingIdx);
            if (input) input.focus();
        }
    }
    
    function editDocName(i) {
        docUrls[i].editing = true;
        renderDocsPreview();
    }
    
    function saveDocName(i, newName) {
        if (newName && newName.trim()) {
            docUrls[i].name = newName.trim();
        }
        delete docUrls[i].editing;
        renderDocsPreview();
    }
    
    function cancelEditDocName(i) {
        delete docUrls[i].editing;
        renderDocsPreview();
    }
    
    function removeDoc(i) {
        if (i < docUrls.length) docUrls.splice(i, 1);
        else docFiles.splice(i - docUrls.length, 1);
        renderDocsPreview();
    }

    
    async function uploadDoc(file, vehId) {
        const root = await getOrCreateFolder('TankIberica');
        const vehs = await getOrCreateFolder('Vehiculos', root);
        
        // Obtener datos del formulario para la estructura de carpetas
        const subcategoria = document.getElementById('vehSubcat')?.value || '';
        const marca = document.getElementById('vehMarca')?.value || '';
        const ano = document.getElementById('vehAno')?.value || '';
        const matricula = document.getElementById('vehMatricula')?.value || '';
        const tipoClase = obtenerTipoClaseFormulario();
        
        // Crear estructura: Vehiculos/[Subcategoria]/[Tipo si existe]/[Marca_(A√±o)_Matricula]/
        let parentFolder = vehs;
        
        if (subcategoria) {
            parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
        }
        
        if (tipoClase) {
            parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
        }
        
        const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, vehId);
        const vehFolder = await getOrCreateFolder(nombreCarpeta, parentFolder);
        const docsFolder = await getOrCreateFolder('Documentos', vehFolder);
        
        const meta = {name: file.name, parents: [docsFolder]};
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
        form.append('file', file);
        
        const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token},
            body: form
        }).then(r => r.json());
        
        await fetch('https://www.googleapis.com/drive/v3/files/' + up.id + '/permissions', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
            body: JSON.stringify({role: 'reader', type: 'anyone'})
        });
        
        return { name: file.name, url: 'https://drive.google.com/file/d/' + up.id + '/view' };
    }

    
    // Convertir URLs de Drive a formato que funcione
    function convertirUrlDrive(url) {
        if (!url || typeof url !== 'string') return url;
        if (url.includes('lh3.googleusercontent.com')) return url;
        let fileId = null;
        let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (m) fileId = m[1];
        if (!fileId) { m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if (m) fileId = m[1]; }
        if (!fileId) { m = url.match(/open\?id=([a-zA-Z0-9_-]+)/); if (m) fileId = m[1]; }
        return fileId ? 'https://lh3.googleusercontent.com/d/' + fileId : url;
    }
    
    function renderImgPreview() {
        const all = [...imgUrls, ...imgFiles];
        document.getElementById('imgPreview').innerHTML = all.map((img, i) => {
            const isFile = img instanceof File;
            const src = isFile ? URL.createObjectURL(img) : convertirUrlDrive(img);
            const portadaClass = i === portada ? 'portada' : '';
            const portadaLabel = i === portada ? '<span class="portada-label">Portada</span>' : '';
            return '<div class="img-preview ' + portadaClass + '" onclick="setPortada(' + i + ')"><img src="' + escapeHTML(src) + '" onerror="this.style.background=\'#ddd\'"><button class="remove" onclick="event.stopPropagation();removeImg(' + i + ')">X</button>' + portadaLabel + '</div>';
        }).join('');
    }
    
    function setPortada(i) { portada = i; renderImgPreview(); }
    function removeImg(i) {
        if (i < imgUrls.length) imgUrls.splice(i, 1);
        else imgFiles.splice(i - imgUrls.length, 1);
        if (portada >= imgUrls.length + imgFiles.length) portada = 0;
        renderImgPreview();
    }
    
    // Obtener siguiente ID libre (reutiliza huecos)
    function obtenerSiguienteIdVehiculo() {
        // Recopilar todos los IDs usados (veh√≠culos + hist√≥rico)
        const idsUsados = new Set();
        
        (cache.vehiculos || []).forEach(v => {
            const num = parseInt(v.id);
            if (!isNaN(num)) idsUsados.add(num);
        });
        
        (cache.historico || []).forEach(h => {
            // Solo contar los que NO tienen prefijo P (son veh√≠culos, no intermediaci√≥n)
            const id = String(h.id || '');
            if (!id.startsWith('P')) {
                const num = parseInt(id);
                if (!isNaN(num)) idsUsados.add(num);
            }
        });
        
        // Buscar primer hueco desde 1
        let siguiente = 1;
        while (idsUsados.has(siguiente)) {
            siguiente++;
        }
        
        return siguiente;
    }
    
    // Obtener siguiente ID libre para Intermediaci√≥n (con prefijo P)
    function obtenerSiguienteIdIntermediacion() {
        const idsUsados = new Set();
        
        (cache.intermediacion || []).forEach(v => {
            const id = String(v.id || '');
            const num = parseInt(id.replace('P', ''));
            if (!isNaN(num)) idsUsados.add(num);
        });
        
        (cache.historico || []).forEach(h => {
            // Solo contar los que tienen prefijo P (intermediaci√≥n)
            const id = String(h.id || '');
            if (id.startsWith('P')) {
                const num = parseInt(id.replace('P', ''));
                if (!isNaN(num)) idsUsados.add(num);
            }
        });
        
        // Buscar primer hueco desde 1
        let siguiente = 1;
        while (idsUsados.has(siguiente)) {
            siguiente++;
        }
        
        return 'P' + siguiente;
    }
    
    async function guardarVehiculo() {
        try {
            const id = document.getElementById('vehId').value || obtenerSiguienteIdVehiculo();
            const row = document.getElementById('vehRow').value;
            // Upload images
            let urls = [...imgUrls];
            for (const f of imgFiles) {
                toast('Subiendo imagen...', 'info');
                const url = await uploadImg(f, id);
                urls.push(url);
            }
            // Reorder portada
            if (portada > 0 && urls.length > 1) {
                const p = urls.splice(portada, 1)[0];
                urls.unshift(p);
            }
            // Categor√≠as m√∫ltiples
            const categorias = [];
            if (document.getElementById('vehCatVenta').checked) categorias.push('venta');
            if (document.getElementById('vehCatAlquiler').checked) categorias.push('alquiler');
            if (document.getElementById('vehCatTerceros').checked) categorias.push('terceros');
            // Filtros - formato biling√ºe { nombreFiltro: { es: "valor", en: "valor" } } o { nombreFiltro: true } para ticks
            const filtros = {};
            document.querySelectorAll('#filtrosGrid input[data-filtro]').forEach(inp => { 
                const filtroName = inp.dataset.filtro;
                const tipo = inp.dataset.tipo;
                
                if (filtroName) {
                    // Filtros tipo tick: guardar como boolean
                    if (tipo === 'tick') {
                        if (inp.checked) {
                            filtros[filtroName] = true;
                        }
                    } else {
                        // Filtros biling√ºes
                        const lang = inp.dataset.lang || 'es';
                        const filtroValue = inp.value.trim();
                        
                        if (!filtros[filtroName]) {
                            filtros[filtroName] = { es: '', en: '' };
                        }
                        if (filtroValue) {
                            filtros[filtroName][lang] = filtroValue;
                        }
                    }
                }
            });
            // Limpiar filtros vac√≠os (sin valor en ning√∫n idioma)
            Object.keys(filtros).forEach(key => {
                const val = filtros[key];
                if (typeof val === 'object' && !val.es && !val.en) {
                    delete filtros[key];
                }
            });
            console.log('üîß Filtros a guardar:', filtros);
            console.log('üîß Filtros JSON:', JSON.stringify(filtros));
            // Caracter√≠sticas adicionales
            const caracteristicas = getCaracteristicas();
            // Construir objeto vehiculo temporal para subida de facturas
            const vehTemp = {
                id: id,
                marca: document.getElementById('vehMarca').value,
                modelo: document.getElementById('vehModelo').value,
                matricula: document.getElementById('vehMatricula').value
            };
            // Mantenimiento y Renta (con subida de facturas a Drive)
            const mantData = await getMantData(vehTemp);
            const rentaData = await getRentaData(vehTemp);
            
            // Upload documentos nuevos
            let docUrlsList = [...docUrls];  // Ya son objetos {name, url}
            for (const f of docFiles) {
                toast('Subiendo documento: ' + f.name, 'info');
                const docObj = await uploadDoc(f, id);  // Devuelve {name, url}
                docUrlsList.push(docObj);
            }
            // Guardar documentos en formato "nombre|url,nombre|url,..."
            const documentacionValue = docUrlsList.map(d => d.name + '|' + d.url).join(',');
            console.log('üìÑ Documentos a guardar:', documentacionValue);
            
            // Estado
            const estado = document.getElementById('vehEstado').value;
            // Columnas: id | imagenes | categoria | subcategoria | marca | modelo | a√±o | precio | ubicacion | ubicacion_en | descripcion | descripcion_en | filtros_json | caracteristicas_json | estado | matricula | documentacion | ejes | bc | dd | exolum | 44tn | adr | atp | itv | etiqueta | motor | potencia | tipo | compartimentos | precio_minimo | coste | mantenimiento_json | adquisicion | renta_json | precio_alquiler
            // Nota: Los campos t√©cnicos eliminados (ejes, bc, dd, exolum, 44tn, adr, atp, itv, etiqueta, motor, potencia, compartimentos) se env√≠an vac√≠os para mantener compatibilidad
            const data = [
                id,
                urls.join(','),
                categorias.join(','),
                document.getElementById('vehSubcat').value,
                document.getElementById('vehMarca').value,
                document.getElementById('vehModelo').value,
                document.getElementById('vehAno').value,
                document.getElementById('vehPrecio').value || 0,
                document.getElementById('vehUbic').value,
                document.getElementById('vehUbicEn').value,
                document.getElementById('vehDesc').value,
                document.getElementById('vehDescEn').value,
                JSON.stringify(filtros),
                JSON.stringify(caracteristicas),
                estado,
                document.getElementById('vehMatricula').value,
                documentacionValue,
                '', // ejes (eliminado - ahora en filtros)
                '', // bc (eliminado)
                '', // dd (eliminado)
                '', // exolum (eliminado)
                '', // 44tn (eliminado)
                '', // adr (eliminado)
                '', // atp (eliminado)
                '', // itv (eliminado)
                '', // etiqueta (eliminado)
                '', // motor (eliminado - ahora en filtros)
                '', // potencia (eliminado - ahora en filtros)
                '', // tipo (eliminado - ahora en filtros)
                '', // compartimentos (eliminado - ahora en filtros)
                document.getElementById('vehPrecioMin').value,
                document.getElementById('vehCoste').value,
                JSON.stringify(mantData),
                document.getElementById('vehAdquisicion').value,
                JSON.stringify(rentaData),
                document.getElementById('vehPrecioAlquiler').value || 0
            ];
            if (row) await writeRow('vehiculos', parseInt(row), data);
            else await appendRow('vehiculos', data);
            toast('Veh√≠culo guardado', 'success');
            cerrarModal('modalVehiculo');
            cache.vehiculos = await readSheetData('vehiculos');
            filtrarVeh();
            document.getElementById('sVeh').textContent = cache.vehiculos.filter(v=>v.estado === 'publicado').length;
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    // Sheets API
    async function writeRow(sheet, row, data) {
        const r = await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+SHEET_ID+'/values/'+sheet+'!A'+row+':AK'+row+'?valueInputOption=USER_ENTERED', {
            method: 'PUT',
            headers: {'Authorization':'Bearer '+token, 'Content-Type':'application/json'},
            body: JSON.stringify({values:[data]})
        });
        if (!r.ok) throw new Error('Error escribiendo');
    }
    async function appendRow(sheet, data) {
        const r = await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+SHEET_ID+'/values/'+sheet+'!A:A:append?valueInputOption=USER_ENTERED', {
            method: 'POST',
            headers: {'Authorization':'Bearer '+token, 'Content-Type':'application/json'},
            body: JSON.stringify({values:[data]})
        });
        if (!r.ok) {
            const err = await r.json();
            console.error('Error appendRow:', err);
            throw new Error('Error a√±adiendo: ' + (err.error?.message || r.status));
        }
    }
    async function deleteRow(sheet, row) {
        // Validaciones de seguridad
        if (!row || row < 2) {
            console.error('‚ùå deleteRow: Fila inv√°lida:', row);
            throw new Error('No se puede eliminar la fila ' + row + ' (debe ser >= 2)');
        }
        if (!sheet) {
            console.error('‚ùå deleteRow: Hoja no especificada');
            throw new Error('Hoja no especificada');
        }
        
        console.log('üóëÔ∏è deleteRow: Eliminando fila', row, 'de hoja', sheet);
        
        const info = await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+SHEET_ID, {headers:{'Authorization':'Bearer '+token}}).then(r=>r.json());
        const sh = info.sheets.find(s => s.properties.title === sheet);
        if (!sh) throw new Error('Hoja no encontrada: ' + sheet);
        
        // Verificar que startIndex y endIndex son correctos (solo 1 fila)
        const startIndex = row - 1;
        const endIndex = row;
        console.log('üóëÔ∏è deleteRow: startIndex=' + startIndex + ', endIndex=' + endIndex + ' (eliminando 1 fila)');
        
        const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+SHEET_ID+':batchUpdate', {
            method: 'POST',
            headers: {'Authorization':'Bearer '+token, 'Content-Type':'application/json'},
            body: JSON.stringify({requests:[{deleteDimension:{range:{sheetId:sh.properties.sheetId, dimension:'ROWS', startIndex:startIndex, endIndex:endIndex}}}]})
        });
        
        if (!response.ok) {
            const err = await response.json();
            console.error('‚ùå deleteRow error:', err);
            throw new Error('Error eliminando fila: ' + (err.error?.message || response.status));
        }
        
        console.log('‚úÖ deleteRow: Fila', row, 'eliminada correctamente');
    }
    
    // Drive API
    async function getOrCreateFolder(name, parent) {
        let q = "name='"+name+"' and mimeType='application/vnd.google-apps.folder' and trashed=false";
        if (parent) q += " and '"+parent+"' in parents";
        const search = await fetch('https://www.googleapis.com/drive/v3/files?q='+encodeURIComponent(q), {headers:{'Authorization':'Bearer '+token}}).then(r=>r.json());
        if (search.files?.length) return search.files[0].id;
        const meta = {name, mimeType:'application/vnd.google-apps.folder'};
        if (parent) meta.parents = [parent];
        const create = await fetch('https://www.googleapis.com/drive/v3/files', {method:'POST', headers:{'Authorization':'Bearer '+token, 'Content-Type':'application/json'}, body:JSON.stringify(meta)}).then(r=>r.json());
        return create.id;
    }
    // Generar nombre de carpeta para veh√≠culo: Marca_(A√±o)_Matr√≠cula
    function generarNombreCarpetaVeh(marca, ano, matricula, id) {
        const m = (marca || 'SinMarca').replace(/[\/\\:*?"<>|]/g, '_').trim();
        const a = ano || 'SinAno';
        const mat = (matricula || id || 'SinID').replace(/[\/\\:*?"<>|]/g, '_').trim();
        return `${m}_(${a})_${mat}`;
    }
    
    // Obtener tipo/clase desde filtros del formulario
    function obtenerTipoClaseFormulario() {
        let tipo = '';
        document.querySelectorAll('#filtrosGrid input[data-filtro]').forEach(inp => {
            const filtroName = (inp.dataset.filtro || '').toLowerCase();
            if ((filtroName === 'tipo' || filtroName === 'clase') && inp.value.trim()) {
                tipo = inp.value.trim().replace(/[\/\\:*?"<>|]/g, '_');
            }
        });
        return tipo;
    }
    
    async function uploadImg(file, vehId) {
        const root = await getOrCreateFolder('TankIberica');
        const vehs = await getOrCreateFolder('Vehiculos', root);
        
        // Obtener datos del formulario para la estructura de carpetas
        const subcategoria = document.getElementById('vehSubcat')?.value || '';
        const marca = document.getElementById('vehMarca')?.value || '';
        const ano = document.getElementById('vehAno')?.value || '';
        const matricula = document.getElementById('vehMatricula')?.value || '';
        const tipoClase = obtenerTipoClaseFormulario();
        
        // Crear estructura: Vehiculos/[Subcategoria]/[Tipo si existe]/[Marca_(A√±o)_Matricula]/
        let parentFolder = vehs;
        
        // Subcarpeta por subcategor√≠a
        if (subcategoria) {
            parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
        }
        
        // Subcarpeta por tipo/clase (si existe)
        if (tipoClase) {
            parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
        }
        
        // Carpeta del veh√≠culo
        const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, vehId);
        const folder = await getOrCreateFolder(nombreCarpeta, parentFolder);
        
        // Subcarpeta Fotos
        const fotosFolder = await getOrCreateFolder('Fotos', folder);
        
        const meta = {name: file.name, parents: [fotosFolder]};
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'}));
        form.append('file', file);
        const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {method:'POST', headers:{'Authorization':'Bearer '+token}, body:form}).then(r=>r.json());
        await fetch('https://www.googleapis.com/drive/v3/files/'+up.id+'/permissions', {method:'POST', headers:{'Authorization':'Bearer '+token, 'Content-Type':'application/json'}, body:JSON.stringify({role:'reader',type:'anyone'})});
        return 'https://lh3.googleusercontent.com/d/'+up.id;
    }
    
    // Delete
    function prepDel(tipo, row) {
        // Validaciones
        if (!row || row < 2) {
            console.error('prepDel: fila inv√°lida', row);
            toast('Error: fila inv√°lida para eliminar', 'error');
            return;
        }
        
        console.log('üóëÔ∏è prepDel: tipo=' + tipo + ', row=' + row);
        
        document.getElementById('delTipo').value = tipo;
        document.getElementById('delRow').value = row;
        const input = document.getElementById('confirmInput');
        const btn = document.getElementById('btnConfirmDel');
        input.value = '';
        btn.disabled = true;
        
        // Mostrar info del elemento a eliminar
        let infoText = '';
        if (tipo === 'vehiculos') {
            const veh = cache.vehiculos[row - 2]; // row-2 porque fila 1 es header
            if (veh) {
                infoText = `Veh√≠culo: ${veh.marca || ''} ${veh.modelo || ''} (ID: ${veh.id || row-1}, Fila: ${row})`;
            }
        }
        const infoEl = document.getElementById('delInfo');
        if (infoEl) infoEl.textContent = infoText;
        
        // Listener para habilitar bot√≥n cuando escriban "Borrar"
        input.oninput = function() {
            btn.disabled = this.value !== 'Borrar';
        };
        
        abrirModal('modalConfirm');
        setTimeout(() => input.focus(), 100);
    }
    async function confirmarBorrar() {
        if (document.getElementById('confirmInput').value !== 'Borrar') { toast('Escribe "Borrar"', 'error'); return; }
        const tipo = document.getElementById('delTipo').value;
        const row = parseInt(document.getElementById('delRow').value);
        
        // Validaci√≥n adicional
        if (!row || row < 2 || isNaN(row)) {
            toast('Error: fila inv√°lida', 'error');
            return;
        }
        
        console.log('üóëÔ∏è confirmarBorrar: tipo=' + tipo + ', row=' + row);
        
        try {
            await deleteRow(tipo, row);
            toast('Eliminado', 'success');
            cerrarModal('modalConfirm');
            cache[tipo] = await readSheetData(tipo);
            loadSection(tipo === 'noticias' ? 'posts' : tipo);
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    // Actions
    async function marcarContactado(tabla, idx) {
        try {
            const item = cache[tabla][idx];
            const row = idx + 2;
            let data;
            if (tabla === 'anunciantes') data = [item.id, item.nombre, item.email, item.telefono, item.vehiculo, item.precio, item.imagenes||'', item.fecha, 'contactado', item.vehiculo_match_id||''];
            else data = [item.id, item.nombre, item.email, item.telefono, item.categoria, item.requisitos, item.fecha, 'contactado', item.vehiculo_match_id||''];
            await writeRow(tabla, row, data);
            toast('Marcado contactado', 'success');
            cache[tabla] = await readSheetData(tabla);
            loadSection(tabla);
        } catch(e) { console.error(e); toast('Error', 'error'); }
    }
    async function aprobarCom(idx) {
        try {
            const c = cache.comentarios[idx];
            const data = [c.id, c.noticia_id, c.nombre, c.email, c.texto, c.fecha, c.parent_id||'', 'TRUE'];
            await writeRow('comentarios', idx+2, data);
            toast('Aprobado', 'success');
            cache.comentarios = await readSheetData('comentarios');
            renderCom();
            const pend = cache.comentarios.filter(c=>!c.moderado).length;
            document.getElementById('sCom').textContent = pend;
            document.getElementById('badgeCom').textContent = pend;
        } catch(e) { console.error(e); toast('Error', 'error'); }
    }
    
    // Utils
    function abrirModal(id) { document.getElementById(id).classList.add('active'); }
    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
    function toast(msg, type='info') { const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
    function fmtNum(n) { return n?.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.')||'0'; }
    function fmtDate(d) { if(!d)return'-'; try{ var dt=new Date(d); return String(dt.getDate()).padStart(2,'0')+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+dt.getFullYear(); }catch(e){return d;} }
    
    // =====================
    // SUBCATEGOR√çAS
    // =====================
    function abrirModalSubcat() {
        document.getElementById('modalSubcatTitle').textContent = 'Nueva Subcategor√≠a';
        document.getElementById('subId').value = '';
        document.getElementById('subRow').value = '';
        document.getElementById('subNombre').value = '';
        document.getElementById('subNombreEn').value = '';
        document.getElementById('subPublicado').checked = true;
        renderSubFiltrosCheck([]);
        abrirModal('modalSubcat');
    }
    function editSubcat(idx) {
        const s = cache.subcategorias[idx];
        document.getElementById('modalSubcatTitle').textContent = 'Editar Subcategor√≠a';
        document.getElementById('subId').value = s.id || idx+1;
        document.getElementById('subRow').value = idx + 2;
        document.getElementById('subNombre').value = s.nombre || '';
        document.getElementById('subNombreEn').value = s.nombre_en || '';
        document.getElementById('subPublicado').checked = s.publicado === true || s.publicado === 'TRUE';
        const filtrosActivos = (s.filtros_aplicables || '').split(',').map(f => f.trim()).filter(f => f);
        renderSubFiltrosCheck(filtrosActivos);
        abrirModal('modalSubcat');
    }
    function renderSubFiltrosCheck(activos) {
        const container = document.getElementById('subFiltrosCheck');
        // Filtros disponibles: los que tienen estado publicado u oculto (no inactivos)
        const filtrosDisponibles = cache.filtros.filter(f => {
            const estado = normalizarEstadoFiltro(f);
            return estado !== 'inactivo' && !['precio','marca','a√±o','ubicacion'].includes((f.nombre||'').toLowerCase());
        });
        if (!filtrosDisponibles.length) {
            container.innerHTML = '<p style="color:#888;font-size:12px">No hay filtros creados. Crea filtros primero.</p>';
            return;
        }
        container.innerHTML = filtrosDisponibles.map(f => {
            const checked = activos.includes(f.nombre) ? 'checked' : '';
            return '<label class="checkbox-label" style="font-size:12px"><input type="checkbox" value="'+escapeHTML(f.nombre)+'" '+checked+'><span>'+escapeHTML(f.nombre)+'</span></label>';
        }).join('');
    }
    async function guardarSubcat() {
        try {
            const id = document.getElementById('subId').value || (cache.subcategorias.length + 1);
            const row = document.getElementById('subRow').value;
            const nombre = document.getElementById('subNombre').value.trim();
            const nombreEn = document.getElementById('subNombreEn').value.trim();
            if (!nombre) { toast('El nombre es obligatorio', 'error'); return; }
            
            const filtrosCheck = Array.from(document.querySelectorAll('#subFiltrosCheck input:checked')).map(c => c.value);
            const filtrosStr = filtrosCheck.join(', ');
            
            // Calcular stock
            const stock = cache.vehiculos.filter(v => (v.subcategoria||'').toLowerCase() === nombre.toLowerCase() && (v.publicado === true || v.publicado === 'TRUE')).length;
            
            // Columnas: id | nombre | nombre_en | filtros_aplicables | publicado | stock
            const data = [id, nombre, nombreEn, filtrosStr, document.getElementById('subPublicado').checked ? 'TRUE' : 'FALSE', stock];
            
            if (row) await writeRow('subcategorias', parseInt(row), data);
            else await appendRow('subcategorias', data);
            
            toast('Subcategor√≠a guardada', 'success');
            cerrarModal('modalSubcat');
            cache.subcategorias = await readSheetData('subcategorias');
            renderSub();
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    // =====================
    // FILTROS
    // =====================
    function abrirModalFiltro() {
        document.getElementById('modalFiltroTitle').textContent = 'Nuevo Filtro';
        document.getElementById('filId').value = '';
        document.getElementById('filRow').value = '';
        document.getElementById('filNombre').value = '';
        document.getElementById('filNombreEn').value = '';
        document.getElementById('filTipo').value = '';
        document.getElementById('filDefecto').value = '';
        document.getElementById('filEstado').value = 'publicado';
        document.getElementById('filUnidad').value = '';
        
        document.getElementById('filExtraGroup').style.display = 'none';
        document.getElementById('filOcultarGroup').style.display = 'none';
        renderFilExtraCheck([], []);
        abrirModal('modalFiltro');
    }
    function editFiltro(idx) {
        const f = cache.filtros[idx];
        document.getElementById('modalFiltroTitle').textContent = 'Editar Filtro';
        document.getElementById('filId').value = f.id || idx+1;
        document.getElementById('filRow').value = idx + 2;
        document.getElementById('filNombre').value = f.nombre || '';
        document.getElementById('filNombreEn').value = f.nombre_en || '';
        document.getElementById('filTipo').value = f.tipo || '';
        document.getElementById('filDefecto').value = f.valores_default || '';
        // Cargar estado (compatibilidad con campo antiguo publicado)
        const estado = normalizarEstadoFiltro(f);
        document.getElementById('filEstado').value = estado;
        document.getElementById('filUnidad').value = f.unidad || '';
        
        onTipoFiltroChange();
        const extrasActivos = (f.extra_filtros || '').split(',').map(x => x.trim()).filter(x => x);
        const ocultarActivos = (f.ocultar_filtros || '').split(',').map(x => x.trim()).filter(x => x);
        renderFilExtraCheck(extrasActivos, ocultarActivos, f.nombre);
        abrirModal('modalFiltro');
    }
    function onTipoFiltroChange() {
        const tipo = document.getElementById('filTipo').value;
        // Mostrar extra y ocultar filtros solo para tick
        document.getElementById('filExtraGroup').style.display = tipo === 'tick' ? 'block' : 'none';
        document.getElementById('filOcultarGroup').style.display = tipo === 'tick' ? 'block' : 'none';
    }
    function renderFilExtraCheck(activosExtra, activosOcultar, excluirNombre = '') {
        // Renderizar Extra filtros
        const containerExtra = document.getElementById('filExtraCheck');
        const otrosFiltros = cache.filtros.filter(f => f.nombre !== excluirNombre);
        containerExtra.innerHTML = otrosFiltros.map(f => {
            const checked = activosExtra.includes(f.nombre) ? 'checked' : '';
            return '<label class="checkbox-label" style="font-size:12px"><input type="checkbox" value="'+escapeHTML(f.nombre)+'" '+checked+'><span>'+escapeHTML(f.nombre)+'</span></label>';
        }).join('');

        // Renderizar Ocultar filtros
        const containerOcultar = document.getElementById('filOcultarCheck');
        containerOcultar.innerHTML = otrosFiltros.map(f => {
            const checked = activosOcultar.includes(f.nombre) ? 'checked' : '';
            return '<label class="checkbox-label" style="font-size:12px"><input type="checkbox" value="'+escapeHTML(f.nombre)+'" '+checked+'><span>'+escapeHTML(f.nombre)+'</span></label>';
        }).join('');
    }
    async function guardarFiltro() {
        try {
            const id = document.getElementById('filId').value || (cache.filtros.length + 1);
            const row = document.getElementById('filRow').value;
            const nombre = document.getElementById('filNombre').value.trim();
            const nombreEn = document.getElementById('filNombreEn').value.trim();
            const tipo = document.getElementById('filTipo').value;
            const estado = document.getElementById('filEstado').value;
            if (!nombre || !tipo) { toast('Nombre y tipo son obligatorios', 'error'); return; }
            
            const extraCheck = tipo === 'tick' ? Array.from(document.querySelectorAll('#filExtraCheck input:checked')).map(c => c.value) : [];
            const extraStr = extraCheck.join(', ');
            const ocultarCheck = tipo === 'tick' ? Array.from(document.querySelectorAll('#filOcultarCheck input:checked')).map(c => c.value) : [];
            const ocultarStr = ocultarCheck.join(', ');
            const defecto = document.getElementById('filDefecto').value;
            const unidad = document.getElementById('filUnidad').value.trim();
            
            // Columnas: id | nombre | nombre_en | tipo | estado | valores_default | extra_filtros | ocultar_filtros | unidad
            // Nota: columna 5 ahora es 'estado' en lugar de 'publicado'
            const data = [id, nombre, nombreEn, tipo, estado, defecto, extraStr, ocultarStr, unidad];
            
            if (row) await writeRow('filtros', parseInt(row), data);
            else await appendRow('filtros', data);
            
            toast('Filtro guardado', 'success');
            cerrarModal('modalFiltro');
            cache.filtros = await readSheetData('filtros');
            renderFil();
        } catch(e) { console.error(e); toast('Error: '+e.message, 'error'); }
    }
    
    // ================================================
    // CONFIGURACI√ìN DE TABLA DE VEH√çCULOS
    // ================================================
    
    // Procesar datos de tabla_config
    function procesarTablaConfig() {
        // Filtrar por secci√≥n: vehiculos, intermediacion, o ambos
        const configVeh = (cache.tabla_config || []).filter(c => !c.seccion || c.seccion === 'vehiculos' || c.seccion === 'ambos');
        const configInter = (cache.tabla_config || []).filter(c => c.seccion === 'intermediacion' || c.seccion === 'ambos');
        
        // Grupos y columnas para Veh√≠culos
        tablaGrupos = configVeh.filter(c => c.tipo === 'grupo');
        tablaColumnas = configVeh.filter(c => c.tipo === 'columna').sort((a, b) => (parseInt(a.orden) || 0) - (parseInt(b.orden) || 0));
        
        // Grupos y columnas para Intermediaci√≥n
        tablaGruposInter = configInter.filter(c => c.tipo === 'grupo');
        tablaColumnasInter = configInter.filter(c => c.tipo === 'columna').sort((a, b) => (parseInt(a.orden) || 0) - (parseInt(b.orden) || 0));
        
        // Inicializar estado de grupos seg√∫n activo_defecto - Veh√≠culos
        gruposActivos = {};
        tablaGrupos.forEach(g => {
            gruposActivos[g.nombre] = g.activo_defecto === true || g.activo_defecto === 'TRUE';
        });
        
        // Inicializar estado de grupos - Intermediaci√≥n
        gruposActivosInter = {};
        tablaGruposInter.forEach(g => {
            gruposActivosInter[g.nombre] = g.activo_defecto === true || g.activo_defecto === 'TRUE';
        });
        
        // Renderizar checkboxes de grupos
        renderGruposCheckboxes();
        renderGruposCheckboxesInter();
    }
    
    // Renderizar checkboxes de grupos en la barra de filtros - Veh√≠culos
    function renderGruposCheckboxes() {
        const container = document.getElementById('gruposTableContainer');
        if (!container) return;
        
        if (tablaGrupos.length === 0) {
            container.innerHTML = '<span style="color:#888;font-size:12px">Sin grupos configurados</span>';
            return;
        }
        
        container.innerHTML = tablaGrupos.map(g => {
            const checked = gruposActivos[g.nombre] ? 'checked' : '';
            return `<label title="Mostrar ${escapeHTML(g.nombre)}">
                <input type="checkbox" id="grp_${sanitizeName(g.nombre)}" ${checked} onchange="toggleGrupo('${escapeHTML(g.nombre)}')"> ${escapeHTML(g.nombre)}
            </label>`;
        }).join('');
    }
    
    // Toggle grupo activo/inactivo - Veh√≠culos
    function toggleGrupo(nombreGrupo) {
        gruposActivos[nombreGrupo] = !gruposActivos[nombreGrupo];
        filtrarVeh(); // Re-renderizar tabla
    }
    
    // Verificar si una columna pertenece a alg√∫n grupo activo
    function columnaVisible(nombreColumna) {
        const colLower = nombreColumna.toLowerCase();
        
        // Buscar si esta columna pertenece a alg√∫n grupo
        for (const grupo of tablaGrupos) {
            const elementos = (grupo.elementos || '').split(';').map(e => e.trim().toLowerCase());
            if (elementos.includes(colLower)) {
                // La columna pertenece a este grupo, verificar si est√° activo
                return gruposActivos[grupo.nombre] === true;
            }
        }
        
        // Si no pertenece a ning√∫n grupo, siempre visible
        return true;
    }
    
    // Obtener valor de columna con fallback
    function getValorColumna(vehiculo, elementos) {
        const elemList = elementos.split(';').map(e => e.trim().toLowerCase());
        
        for (const elem of elemList) {
            let valor = null;
            
            // Buscar en propiedades directas
            const keys = Object.keys(vehiculo);
            const matchKey = keys.find(k => k.toLowerCase() === elem);
            if (matchKey && vehiculo[matchKey] !== null && vehiculo[matchKey] !== undefined && vehiculo[matchKey] !== '') {
                valor = vehiculo[matchKey];
            }
            
            // Buscar en filtros_json
            if (!valor && vehiculo.filtros_json && typeof vehiculo.filtros_json === 'object') {
                const filtroKey = Object.keys(vehiculo.filtros_json).find(k => k.toLowerCase() === elem);
                if (filtroKey && vehiculo.filtros_json[filtroKey]) {
                    valor = vehiculo.filtros_json[filtroKey];
                }
            }
            
            if (valor !== null && valor !== undefined && valor !== '') {
                return valor;
            }
        }
        
        return null;
    }
    
    // Sanitizar nombre para usar como ID
    function sanitizeName(name) {
        return (name || '').toLowerCase().replace(/[^a-z0-9]/g, '_');
    }
    
    // ================================================
    // MODAL CONFIGURACI√ìN DE TABLA
    // ================================================
    
    let configSeccionActual = 'grupos';
    let configGrupoEditando = null;
    
    function abrirConfigTabla() {
        configSeccionActual = 'grupos';
        mostrarSeccionConfig('grupos');
        abrirModal('modalConfigTabla');
    }
    
    function mostrarSeccionConfig(seccion) {
        configSeccionActual = seccion;
        
        // Actualizar botones sidebar
        document.getElementById('btnSeccionGrupos').classList.toggle('active', seccion === 'grupos');
        document.getElementById('btnSeccionColumnas').classList.toggle('active', seccion === 'columnas');
        
        const main = document.getElementById('configTablaMain');
        
        if (seccion === 'grupos') {
            renderSeccionGrupos(main);
        } else {
            renderSeccionColumnas(main);
        }
    }
    
    // Renderizar secci√≥n de grupos
    function renderSeccionGrupos(container) {
        let html = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h4 style="margin:0">üìÅ Grupos de Columnas</h4>
                <button class="btn-primary" onclick="nuevoGrupo()">+ Nuevo Grupo</button>
            </div>
            <p style="color:#666;font-size:12px;margin-bottom:15px">Los grupos permiten mostrar/ocultar conjuntos de columnas con un solo clic. Arrastra para reordenar.</p>
        `;
        
        // Mostrar todos los grupos (veh√≠culos, intermediaci√≥n y ambos)
        const todosGrupos = (cache.tabla_config || []).filter(c => c.tipo === 'grupo');
        
        if (todosGrupos.length === 0) {
            html += '<p style="color:#888;text-align:center;padding:40px">No hay grupos creados</p>';
        } else {
            html += '<ul class="sortable-list" id="listaGrupos">';
            todosGrupos.forEach((g, i) => {
                const elementos = (g.elementos || '').split(';').filter(e => e.trim()).length;
                const seccion = g.seccion || 'ambos';
                const seccionIcon = seccion === 'vehiculos' ? 'üöó' : (seccion === 'intermediacion' ? 'ü§ù' : '‚úÖ');
                const seccionColor = seccion === 'vehiculos' ? '#3b82f6' : (seccion === 'intermediacion' ? '#f59e0b' : '#22c55e');
                html += `
                    <li class="sortable-item" draggable="true" data-index="${i}" data-id="${parseInt(g.id)||0}">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <span class="item-name">
                            <strong>${escapeHTML(g.nombre)}</strong>
                            <small style="color:#888">(${elementos} elementos)</small>
                            <span style="color:${seccionColor};font-size:10px;margin-left:5px">${seccionIcon} ${escapeHTML(seccion)}</span>
                            ${g.activo_defecto === true || g.activo_defecto === 'TRUE' ? '<span style="color:#22c55e;font-size:10px;margin-left:5px">‚óè Activo</span>' : ''}
                            ${g.obligatorio === true || g.obligatorio === 'TRUE' ? '<span style="color:#ef4444;font-size:10px;margin-left:5px">* Obligatorio</span>' : ''}
                        </span>
                        <div class="item-actions">
                            <button style="background:#3b82f6;color:#fff" onclick="editarGrupoGeneral(${i})">‚úèÔ∏è</button>
                            <button style="background:#ef4444;color:#fff" onclick="eliminarGrupoGeneral(${i})">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
        }
        
        html += '<div id="grupoEditForm"></div>';
        container.innerHTML = html;
        
        // Inicializar drag & drop para grupos
        initDragDropGrupos();
    }
    
    // Funciones para editar/eliminar grupos generales (de cualquier secci√≥n)
    function editarGrupoGeneral(index) {
        const todosGrupos = (cache.tabla_config || []).filter(c => c.tipo === 'grupo');
        configGrupoEditando = index;
        renderFormularioGrupo(todosGrupos[index]);
    }
    
    async function eliminarGrupoGeneral(index) {
        if (!confirm('¬øEliminar este grupo?')) return;
        
        try {
            const todosGrupos = (cache.tabla_config || []).filter(c => c.tipo === 'grupo');
            const g = todosGrupos[index];
            const row = cache.tabla_config.indexOf(g) + 2;
            await deleteRow('tabla_config', row);
            
            toast('Grupo eliminado', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('grupos');
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Inicializar drag & drop para grupos
    function initDragDropGrupos() {
        const lista = document.getElementById('listaGrupos');
        if (!lista) return;
        
        let draggedItem = null;
        
        lista.querySelectorAll('.sortable-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                item.classList.add('dragging');
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedItem = null;
                guardarOrdenGrupos();
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedItem && draggedItem !== item) {
                    const rect = item.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        item.parentNode.insertBefore(draggedItem, item);
                    } else {
                        item.parentNode.insertBefore(draggedItem, item.nextSibling);
                    }
                }
            });
        });
    }
    
    // Guardar orden de grupos
    async function guardarOrdenGrupos() {
        const items = document.querySelectorAll('#listaGrupos .sortable-item');
        const promesas = [];
        
        items.forEach((item, nuevoOrden) => {
            const grupoId = item.dataset.id;
            const grupo = tablaGrupos.find(g => String(g.id) === grupoId);
            if (grupo && parseInt(grupo.orden) !== nuevoOrden + 1) {
                grupo.orden = nuevoOrden + 1;
                const row = cache.tabla_config.indexOf(grupo) + 2;
                const data = [grupo.id, grupo.tipo, grupo.nombre, grupo.nombre_en || '', grupo.elementos || '', grupo.obligatorio || 'FALSE', grupo.activo_defecto || 'FALSE', grupo.orden, grupo.visible || 'TRUE'];
                promesas.push(writeRow('tabla_config', row, data));
            }
        });
        
        if (promesas.length > 0) {
            await Promise.all(promesas);
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            toast('Orden de grupos actualizado', 'success');
        }
    }
    
    // Nuevo grupo
    function nuevoGrupo() {
        configGrupoEditando = null;
        renderFormularioGrupo({
            id: '',
            nombre: '',
            nombre_en: '',
            elementos: '',
            obligatorio: false,
            activo_defecto: false,
            seccion: 'ambos'
        });
    }
    
    // Editar grupo
    function editarGrupo(index) {
        configGrupoEditando = index;
        renderFormularioGrupo(tablaGrupos[index]);
    }
    
    // Renderizar formulario de grupo
    function renderFormularioGrupo(grupo) {
        const container = document.getElementById('grupoEditForm');
        const elementosActuales = (grupo.elementos || '').split(';').map(e => e.trim().toLowerCase()).filter(e => e);
        const seccionActual = grupo.seccion || 'ambos';
        
        // Obtener todas las columnas disponibles para seleccionar
        const columnasDisponibles = obtenerColumnasDisponibles();
        
        let html = `
            <div class="grupo-edit-form">
                <h5 style="margin-top:0">${configGrupoEditando !== null ? 'Editar' : 'Nuevo'} Grupo</h5>
                <div class="form-row">
                    <div>
                        <label>Nombre (ES)</label>
                        <input type="text" id="grupoNombre" value="${escapeHTML(grupo.nombre || '')}" placeholder="Ej: T√©cnico">
                    </div>
                    <div>
                        <label>Nombre (EN)</label>
                        <input type="text" id="grupoNombreEn" value="${escapeHTML(grupo.nombre_en || '')}" placeholder="Ej: Technical">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Aplicar a:</label>
                        <select id="grupoSeccion">
                            <option value="ambos" ${seccionActual === 'ambos' ? 'selected' : ''}>‚úÖ Veh√≠culos + Intermediaci√≥n</option>
                            <option value="vehiculos" ${seccionActual === 'vehiculos' ? 'selected' : ''}>üöó Solo Veh√≠culos</option>
                            <option value="intermediacion" ${seccionActual === 'intermediacion' ? 'selected' : ''}>ü§ù Solo Intermediaci√≥n</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label><input type="checkbox" id="grupoObligatorio" ${grupo.obligatorio === true || grupo.obligatorio === 'TRUE' ? 'checked' : ''}> Campos obligatorios en formulario</label>
                    </div>
                    <div>
                        <label><input type="checkbox" id="grupoActivoDefecto" ${grupo.activo_defecto === true || grupo.activo_defecto === 'TRUE' ? 'checked' : ''}> Activo por defecto al cargar</label>
                    </div>
                </div>
                <label>Elementos del grupo:</label>
                <div class="grupo-elementos-list">
                    ${columnasDisponibles.map(col => {
                        const checked = elementosActuales.includes(col.key.toLowerCase()) ? 'checked' : '';
                        return '<label><input type="checkbox" value="' + escapeHTML(col.key) + '" ' + checked + '> ' + escapeHTML(col.nombre) + '</label>';
                    }).join('')}
                </div>
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                    <button class="btn-secondary" onclick="cancelarGrupo()">Cancelar</button>
                    <button class="btn-primary" onclick="guardarGrupoForm()">üíæ Guardar Grupo</button>
                </div>
            </div>
        `;

        container.innerHTML = html;
        container.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Obtener columnas disponibles para grupos
    function obtenerColumnasDisponibles() {
        const fijas = [
            { key: 'id', nombre: 'ID' },
            { key: 'imagen', nombre: 'Imagen' },
            { key: 'documentacion', nombre: 'Documentos' },
            { key: 'categoria', nombre: 'Categor√≠as' },
            { key: 'subcategoria', nombre: 'Subcategor√≠a' },
            { key: 'marca', nombre: 'Marca' },
            { key: 'modelo', nombre: 'Modelo' },
            { key: 'a√±o', nombre: 'A√±o' },
            { key: 'matricula', nombre: 'Matr√≠cula' },
            { key: 'precio', nombre: 'Precio de Venta' },
            { key: 'precio_alquiler', nombre: 'Precio Alquiler' },
            { key: 'ubicacion', nombre: 'Ubicaci√≥n' },
            { key: 'propietario', nombre: 'Propietario' },
            { key: 'telefono', nombre: 'Tel√©fono' },
            { key: 'comision', nombre: 'Comisi√≥n' },
            { key: 'notas', nombre: 'Notas' },
            { key: 'precio_minimo', nombre: 'Precio M√≠nimo' },
            { key: 'coste', nombre: 'Coste Adquisici√≥n' },
            { key: 'adquisicion', nombre: 'Fecha de Adquisici√≥n' },
            { key: 'mantenimiento', nombre: 'Mantenimiento' },
            { key: 'renta', nombre: 'Renta' },
            { key: 'total', nombre: 'Total' },
            { key: 'estado', nombre: 'Estado' },
            { key: 'acciones', nombre: 'Acciones' }
        ];
        
        // A√±adir filtros din√°micos creados por admin
        const filtros = (cache.filtros || []).filter(f => {
            const estado = normalizarEstadoFiltro(f);
            return estado !== 'inactivo';
        }).map(f => ({
            key: (f.nombre || '').toLowerCase(),
            nombre: f.nombre + ' (filtro)'
        }));
        
        return [...fijas, ...filtros];
    }
    
    // Cancelar edici√≥n de grupo
    function cancelarGrupo() {
        document.getElementById('grupoEditForm').innerHTML = '';
        configGrupoEditando = null;
    }
    
    // Guardar grupo
    async function guardarGrupoForm() {
        const nombre = document.getElementById('grupoNombre').value.trim();
        const nombreEn = document.getElementById('grupoNombreEn').value.trim();
        const obligatorio = document.getElementById('grupoObligatorio').checked;
        const activoDefecto = document.getElementById('grupoActivoDefecto').checked;
        const seccion = document.getElementById('grupoSeccion').value;
        
        if (!nombre) {
            toast('El nombre es obligatorio', 'error');
            return;
        }
        
        const elementosChecked = Array.from(document.querySelectorAll('.grupo-elementos-list input:checked')).map(c => c.value);
        const elementos = elementosChecked.join(';');
        
        try {
            if (configGrupoEditando !== null) {
                // Editar existente
                const g = tablaGrupos[configGrupoEditando];
                const row = cache.tabla_config.indexOf(g) + 2;
                const data = [g.id, 'grupo', nombre, nombreEn, elementos, obligatorio ? 'TRUE' : 'FALSE', activoDefecto ? 'TRUE' : 'FALSE', g.orden || configGrupoEditando + 1, 'TRUE', seccion];
                await writeRow('tabla_config', row, data);
            } else {
                // Nuevo grupo
                const newId = Math.max(0, ...cache.tabla_config.map(c => parseInt(c.id) || 0)) + 1;
                const orden = tablaGrupos.length + 1;
                const data = [newId, 'grupo', nombre, nombreEn, elementos, obligatorio ? 'TRUE' : 'FALSE', activoDefecto ? 'TRUE' : 'FALSE', orden, 'TRUE', seccion];
                await appendRow('tabla_config', data);
            }
            
            toast('Grupo guardado', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('grupos');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Eliminar grupo
    async function eliminarGrupo(index) {
        if (!confirm('¬øEliminar este grupo?')) return;
        
        try {
            const g = tablaGrupos[index];
            const row = cache.tabla_config.indexOf(g) + 2;
            await deleteRow('tabla_config', row);
            
            toast('Grupo eliminado', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('grupos');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Renderizar secci√≥n de columnas
    function renderSeccionColumnas(container) {
        // Generar columnas base (las √∫nicas v√°lidas)
        const columnasBase = obtenerColumnasParaTabla();
        const keysValidas = new Set(columnasBase.map(c => c.key));
        
        // Columnas ordenadas para mostrar
        const columnasOrdenadas = [];
        const columnasUsadas = new Set();
        
        // Solo a√±adir columnas guardadas que sean COMBINACIONES v√°lidas (m√°s de 1 elemento)
        // y cuyos elementos est√©n en la lista de columnas v√°lidas
        tablaColumnas.forEach(colConfig => {
            const elementos = (colConfig.elementos || '').split(';').map(e => e.trim().toLowerCase()).filter(e => e);
            // Solo si tiene m√°s de 1 elemento (es una combinaci√≥n) Y todos los elementos son v√°lidos
            if (elementos.length > 1 && elementos.every(e => keysValidas.has(e))) {
                // Generar nombre autom√°tico si no tiene uno personalizado o es gen√©rico
                let nombreMostrar = colConfig.nombre;
                const nombresElementos = elementos.map(e => {
                    const col = columnasBase.find(cb => cb.key === e);
                    return col ? col.nombre : e;
                });
                const nombreAuto = nombresElementos.join('/');
                
                // Si el nombre guardado es muy diferente, usar el guardado; sino usar el auto
                if (!nombreMostrar || nombreMostrar === 'Documento' || nombreMostrar.length < 2) {
                    nombreMostrar = nombreAuto;
                }
                
                columnasOrdenadas.push({
                    ...colConfig,
                    nombre: nombreMostrar,
                    nombreAuto: nombreAuto,
                    elementosArray: elementos,
                    esCombinada: true
                });
                elementos.forEach(e => columnasUsadas.add(e));
            }
        });
        
        // A√±adir columnas base que no est√©n usadas en combinaciones
        columnasBase.forEach(col => {
            if (!columnasUsadas.has(col.key)) {
                columnasOrdenadas.push({
                    id: 'auto_' + col.key,
                    nombre: col.nombre,
                    elementos: col.key,
                    elementosArray: [col.key],
                    esCombinada: false
                });
            }
        });
        
        let html = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h4 style="margin:0">üìä Organizar Columnas</h4>
            </div>
            <p style="color:#666;font-size:12px;margin-bottom:15px">Arrastra para reordenar. Usa "Combinar" para mostrar varios valores en una columna con fallback.</p>
        `;
        
        html += '<ul class="sortable-list" id="listaColumnas">';
        columnasOrdenadas.forEach((c, i) => {
            const tieneFallback = c.esCombinada;
            html += `
                <li class="sortable-item" draggable="true" data-index="${i}" data-id="${escapeHTML(c.id)}" data-elementos="${escapeHTML(c.elementos)}">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="item-name">
                        <strong>${escapeHTML(c.nombre)}</strong>
                        ${tieneFallback ? '<span style="color:#f59e0b;font-size:10px;margin-left:5px">‚ö° Combinada</span>' : ''}
                    </span>
                    <div class="item-actions">
                        ${tieneFallback ? 
                            `<button style="background:#3b82f6;color:#fff;font-size:10px" onclick="editarCombinacion('${escapeHTML(c.id)}')" title="Editar combinaci√≥n">‚úèÔ∏è</button>
                             <button style="background:#ef4444;color:#fff;font-size:10px" onclick="descombinaColumna('${escapeHTML(c.id)}')" title="Separar columnas">Separar</button>` :
                            `<button style="background:#f59e0b;color:#fff;font-size:10px" onclick="combinarColumna(${i})" title="Combinar con otra">Combinar</button>`
                        }
                    </div>
                </li>
            `;
            if (tieneFallback) {
                html += `<div class="fallback-list" style="margin-left:30px;margin-bottom:10px">`;
                c.elementosArray.forEach((e, j) => {
                    const colBase = columnasBase.find(cb => cb.key === e);
                    html += `<span>${j + 1}. ${escapeHTML(colBase ? colBase.nombre : e)} ${j === 0 ? '(principal)' : '(fallback)'}</span>`;
                });
                html += '</div>';
            }
        });
        html += '</ul>';
        
        html += '<div id="columnaEditForm"></div>';
        container.innerHTML = html;
        
        // Inicializar drag & drop
        initDragDropColumnas();
    }
    
    // Obtener columnas para la tabla (lista fija + filtros din√°micos)
    function obtenerColumnasParaTabla() {
        const fijas = [
            { key: 'id', nombre: 'ID' },
            { key: 'imagen', nombre: 'Imagen' },
            { key: 'documentacion', nombre: 'Documentos' },
            { key: 'categoria', nombre: 'Categor√≠as' },
            { key: 'subcategoria', nombre: 'Subcategor√≠a' },
            { key: 'marca', nombre: 'Marca' },
            { key: 'modelo', nombre: 'Modelo' },
            { key: 'a√±o', nombre: 'A√±o' },
            { key: 'matricula', nombre: 'Matr√≠cula' },
            { key: 'precio', nombre: 'Precio de Venta' },
            { key: 'precio_alquiler', nombre: 'Precio Alquiler' },
            { key: 'ubicacion', nombre: 'Ubicaci√≥n' }
        ];
        
        // A√±adir filtros din√°micos creados por admin
        const filtros = (cache.filtros || []).filter(f => {
            const estado = normalizarEstadoFiltro(f);
            return estado !== 'inactivo';
        }).map(f => ({
            key: (f.nombre || '').toLowerCase(),
            nombre: f.nombre
        }));
        
        const finales = [
            { key: 'precio_minimo', nombre: 'Precio M√≠nimo' },
            { key: 'coste', nombre: 'Coste Adquisici√≥n' },
            { key: 'adquisicion', nombre: 'Fecha de Adquisici√≥n' },
            { key: 'mantenimiento', nombre: 'Mantenimiento' },
            { key: 'renta', nombre: 'Renta' },
            { key: 'total', nombre: 'Total' },
            { key: 'estado', nombre: 'Estado' },
            { key: 'acciones', nombre: 'Acciones' }
        ];
        
        return [...fijas, ...filtros, ...finales];
    }
    
    // Combinar columna con otra
    function combinarColumna(index) {
        const container = document.getElementById('columnaEditForm');
        const columnasBase = obtenerColumnasParaTabla();
        const items = document.querySelectorAll('#listaColumnas .sortable-item');
        const currentItem = items[index];
        const currentElementos = (currentItem.dataset.elementos || '').split(';').map(e => e.trim().toLowerCase());
        
        // Obtener columnas disponibles para combinar (no la actual, no las ya combinadas)
        const disponibles = columnasBase.filter(col => !currentElementos.includes(col.key));
        
        let html = `
            <div class="grupo-edit-form">
                <h5 style="margin-top:0">Combinar columna</h5>
                <p style="color:#666;font-size:12px">Selecciona las columnas a combinar. Se mostrar√° el primer valor disponible.</p>
                <div class="grupo-elementos-list">
                    ${currentElementos.map(e => {
                        const col = columnasBase.find(c => c.key === e);
                        return `<label style="background:#d1fae5;border-color:#10b981"><input type="checkbox" value="${e}" checked disabled> ${col ? col.nombre : e} (actual)</label>`;
                    }).join('')}
                    ${disponibles.map(col => {
                        return `<label><input type="checkbox" value="${col.key}"> ${col.nombre}</label>`;
                    }).join('')}
                </div>
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                    <button class="btn-secondary" onclick="document.getElementById('columnaEditForm').innerHTML=''">Cancelar</button>
                    <button class="btn-primary" onclick="guardarCombinacion(${index})">üíæ Combinar</button>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        container.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Guardar combinaci√≥n
    async function guardarCombinacion(index) {
        const items = document.querySelectorAll('#listaColumnas .sortable-item');
        const currentItem = items[index];
        const currentId = currentItem.dataset.id;
        
        const elementosChecked = Array.from(document.querySelectorAll('#columnaEditForm .grupo-elementos-list input:checked')).map(c => c.value);
        
        if (elementosChecked.length < 2) {
            toast('Selecciona al menos 2 columnas para combinar', 'error');
            return;
        }
        
        const elementos = elementosChecked.join(';');
        const columnasBase = obtenerColumnasParaTabla();
        
        // Generar nombre autom√°tico: CARACTERISTICA1/CARACTERISTICA2/...
        const nombresElementos = elementosChecked.map(e => {
            const col = columnasBase.find(c => c.key === e);
            return col ? col.nombre : e;
        });
        const nombre = nombresElementos.join('/');
        
        try {
            // Buscar si ya existe en config
            const existente = tablaColumnas.find(c => String(c.id) === currentId);
            
            if (existente) {
                const row = cache.tabla_config.indexOf(existente) + 2;
                const data = [existente.id, 'columna', nombre, '', elementos, 'FALSE', 'FALSE', existente.orden || index + 1, 'TRUE'];
                await writeRow('tabla_config', row, data);
            } else {
                const newId = Math.max(0, ...cache.tabla_config.map(c => parseInt(c.id) || 0)) + 1;
                const data = [newId, 'columna', nombre, '', elementos, 'FALSE', 'FALSE', index + 1, 'TRUE'];
                await appendRow('tabla_config', data);
            }
            
            toast('Columnas combinadas', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('columnas');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Editar columna combinada
    function editarCombinacion(colId) {
        const col = tablaColumnas.find(c => String(c.id) === colId);
        if (!col) return;
        
        const container = document.getElementById('columnaEditForm');
        const columnasBase = obtenerColumnasParaTabla();
        const elementosActuales = (col.elementos || '').split(';').map(e => e.trim().toLowerCase()).filter(e => e);
        
        // Generar nombre autom√°tico
        const nombresElementos = elementosActuales.map(e => {
            const colBase = columnasBase.find(c => c.key === e);
            return colBase ? colBase.nombre : e;
        });
        const nombreAuto = nombresElementos.join('/');
        const nombreActual = col.nombre || nombreAuto;
        
        let html = `
            <div class="grupo-edit-form">
                <h5 style="margin-top:0">Editar columna combinada</h5>
                <div class="form-group" style="margin-bottom:15px">
                    <label>Nombre de la columna</label>
                    <input type="text" id="editColNombre" value="${escapeHTML(nombreActual)}" placeholder="${escapeHTML(nombreAuto)}">
                    <small style="color:#666">Deja vac√≠o para usar: ${escapeHTML(nombreAuto)}</small>
                </div>
                <p style="color:#666;font-size:12px">Selecciona las columnas a combinar (m√≠nimo 2). Se mostrar√° el primer valor disponible.</p>
                <div class="grupo-elementos-list">
                    ${columnasBase.map(c => {
                        const checked = elementosActuales.includes(c.key) ? 'checked' : '';
                        return `<label><input type="checkbox" value="${c.key}" ${checked}> ${c.nombre}</label>`;
                    }).join('')}
                </div>
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end">
                    <button class="btn-secondary" onclick="document.getElementById('columnaEditForm').innerHTML=''">Cancelar</button>
                    <button class="btn-primary" onclick="guardarEdicionCombinacion('${colId}')">üíæ Guardar</button>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        container.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Guardar edici√≥n de combinaci√≥n
    async function guardarEdicionCombinacion(colId) {
        const elementosChecked = Array.from(document.querySelectorAll('#columnaEditForm .grupo-elementos-list input:checked')).map(c => c.value);
        
        if (elementosChecked.length < 2) {
            toast('Selecciona al menos 2 columnas para combinar', 'error');
            return;
        }
        
        const elementos = elementosChecked.join(';');
        const columnasBase = obtenerColumnasParaTabla();
        
        // Obtener nombre personalizado o generar autom√°tico
        let nombre = document.getElementById('editColNombre').value.trim();
        if (!nombre) {
            const nombresElementos = elementosChecked.map(e => {
                const col = columnasBase.find(c => c.key === e);
                return col ? col.nombre : e;
            });
            nombre = nombresElementos.join('/');
        }
        
        try {
            const col = tablaColumnas.find(c => String(c.id) === colId);
            if (col) {
                const row = cache.tabla_config.indexOf(col) + 2;
                const data = [col.id, 'columna', nombre, '', elementos, 'FALSE', 'FALSE', col.orden || 1, 'TRUE'];
                await writeRow('tabla_config', row, data);
            }
            
            toast('Columna actualizada', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('columnas');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Descombinar columna
    async function descombinaColumna(colId) {
        if (!confirm('¬øSeparar esta columna combinada?')) return;
        
        try {
            const col = tablaColumnas.find(c => String(c.id) === colId);
            if (col) {
                const row = cache.tabla_config.indexOf(col) + 2;
                await deleteRow('tabla_config', row);
            }
            
            toast('Columna separada', 'success');
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
            mostrarSeccionConfig('columnas');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Inicializar drag & drop para columnas
    function initDragDropColumnas() {
        const lista = document.getElementById('listaColumnas');
        if (!lista) return;
        
        let draggedItem = null;
        
        lista.querySelectorAll('.sortable-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                item.classList.add('dragging');
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedItem = null;
                guardarOrdenColumnas();
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedItem && draggedItem !== item) {
                    const rect = item.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        item.parentNode.insertBefore(draggedItem, item);
                    } else {
                        item.parentNode.insertBefore(draggedItem, item.nextSibling);
                    }
                }
            });
        });
    }
    
    // Guardar orden de columnas
    async function guardarOrdenColumnas() {
        const items = document.querySelectorAll('#listaColumnas .sortable-item');
        const promesas = [];
        
        items.forEach((item, nuevoOrden) => {
            const colId = item.dataset.id;
            const col = tablaColumnas.find(c => String(c.id) === colId);
            if (col && parseInt(col.orden) !== nuevoOrden + 1) {
                col.orden = nuevoOrden + 1;
                const row = cache.tabla_config.indexOf(col) + 2;
                const data = [col.id, col.tipo, col.nombre, col.nombre_en || '', col.elementos || '', col.obligatorio || '', col.activo_defecto || '', col.orden, col.visible || 'TRUE'];
                promesas.push(writeRow('tabla_config', row, data));
            }
        });
        
        if (promesas.length > 0) {
            await Promise.all(promesas);
            cache.tabla_config = await readSheetData('tabla_config');
            procesarTablaConfig();
        }
    }
    
    // Editar columna (configurar fallback)
    // Guardar toda la configuraci√≥n
    async function guardarConfigTabla() {
        toast('Configuraci√≥n guardada', 'success');
        cerrarModal('modalConfigTabla');
        filtrarVeh(); // Re-renderizar tabla
    }
    
    // ================================================
    // ================================================
    // INTERMEDIACI√ìN (Base de datos interna)
    // ================================================
    
    let interImagenes = [];
    let interImagenesFiles = [];
    let interDocs = [];
    let interDocsFiles = [];
    let interGastos = [];
    let interIngresos = [];
    let interCaracteristicas = {};
    // gruposActivosInter ya declarado arriba (l√≠nea ~2146)
    
    // Cargar intermediaci√≥n
    async function cargarIntermediacion() {
        if (!cache.intermediacion) {
            cache.intermediacion = await readSheetData('intermediacion') || [];
        }
        renderGruposCheckboxesInter();
        renderInter();
        cargarSubcatsInter();
    }
    
    // Cargar subcategor√≠as en filtro y modal
    function cargarSubcatsInter() {
        const selectFiltro = document.getElementById('filtroInterSubcat');
        const selectModal = document.getElementById('interSubcat');
        const subcats = cache.subcategorias || [];
        
        if (selectFiltro) {
            selectFiltro.innerHTML = '<option value="">Todas las subcategor√≠as</option>' +
                subcats.map(s => `<option value="${escapeHTML(s.nombre)}">${escapeHTML(s.nombre)}</option>`).join('');
        }
        if (selectModal) {
            selectModal.innerHTML = '<option value="">Seleccionar</option>' +
                subcats.map(s => `<option value="${escapeHTML(s.nombre)}">${escapeHTML(s.nombre)}</option>`).join('');
        }
    }
    
    // Renderizar grupos de columnas (checkboxes din√°micos)
    function renderGruposCheckboxesInter() {
        const container = document.getElementById('gruposInterContainer');
        if (!container) return;
        
        // Usar grupos espec√≠ficos de Intermediaci√≥n
        const grupos = tablaGruposInter.filter(g => {
            const elementos = (g.elementos || '').split(';').filter(e => e.trim());
            return elementos.length > 0;
        });
        
        if (grupos.length === 0) {
            container.innerHTML = '<span style="color:#888;font-size:12px">Sin grupos</span>';
            return;
        }
        
        container.innerHTML = grupos.map(g => {
            const checked = gruposActivosInter[g.nombre] ? 'checked' : '';
            return '<label title="' + escapeHTML(g.nombre) + '"><input type="checkbox" ' + checked + ' onchange="toggleGrupoInter(\'' + escapeHTML(g.nombre) + '\')"> ' + escapeHTML(g.nombre.toUpperCase()) + '</label>';
        }).join('');
    }
    
    function toggleGrupoInter(nombre) {
        gruposActivosInter[nombre] = !gruposActivosInter[nombre];
        renderInter();
    }
    
    function toggleMostrarVehInter() {
        mostrarVehiculosEnInter = document.getElementById('mostrarVehEnInter')?.checked || false;
        renderInter();
    }
    
    
    // Selector de estado
    function setEstadoInter(estado) {
        document.getElementById('interEstado').value = estado;
        document.querySelectorAll('#estadoSelectorInter .estado-option').forEach(opt => {
            opt.classList.remove('selected');
            const radio = opt.querySelector('input[type="radio"]');
            if (radio) radio.checked = false;
        });
        const selected = document.querySelector('#estadoSelectorInter .estado-option.' + estado);
        if (selected) {
            selected.classList.add('selected');
            const radio = selected.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        }
    }
    
    // Renderizar tabla
    function renderInter() {
        let data = [...(cache.intermediacion || [])];
        
        // Si est√° activo mostrar veh√≠culos, a√±adirlos con marca especial
        if (mostrarVehiculosEnInter) {
            const vehiculos = (cache.vehiculos || []).map(v => ({
                ...v,
                _esVehiculo: true,
                propietario: 'PROPIO',
                precio_venta: v.precio,
                gastos_json: v.mantenimiento_json,
                ingresos_json: v.renta_json
            }));
            data = [...data, ...vehiculos];
        }
        
        const tbody = document.getElementById('tInter');
        const thead = document.getElementById('theadInter');
        if (!tbody || !thead) return;
        
        // Determinar columnas visibles seg√∫n grupos activos
        const showDoc = gruposActivosInter['Documentaci√≥n'];
        const showId = gruposActivosInter['Identificaci√≥n'];
        const showCue = gruposActivosInter['Cuentas'];
        const showProp = gruposActivosInter['Propietario'];
        
        // Headers base
        let headers = '<tr><th>ID</th><th>IMG</th><th>SUBCAT</th><th>MARCA</th><th>MODELO</th><th>A√ëO</th>';
        if (showId) headers += '<th>MATR√çCULA</th>';
        if (showDoc) headers += '<th>DOCS</th>';
        if (showProp !== false) headers += '<th>PROPIETARIO</th>';
        headers += '<th>PRECIO</th>';
        if (showCue) headers += '<th>COSTE</th><th>GASTOS</th><th>INGR</th><th>BENEF</th>';
        headers += '<th>ESTADO</th><th>ACC</th></tr>';
        thead.innerHTML = headers;
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="20" class="empty">No hay veh√≠culos</td></tr>';
            return;
        }
        
        // Filtrar
        let filtered = [...data];
        const buscar = document.getElementById('buscarInter')?.value.toLowerCase() || '';
        const estado = document.getElementById('filtroInterEstado')?.value || '';
        const subcat = document.getElementById('filtroInterSubcat')?.value || '';
        
        if (buscar) {
            filtered = filtered.filter(v => 
                (v.marca || '').toLowerCase().includes(buscar) ||
                (v.modelo || '').toLowerCase().includes(buscar) ||
                (v.matricula || '').toLowerCase().includes(buscar) ||
                (v.propietario || '').toLowerCase().includes(buscar) ||
                (v.id || '').toString().toLowerCase().includes(buscar)
            );
        }
        if (estado) filtered = filtered.filter(v => v.estado === estado);
        if (subcat) filtered = filtered.filter(v => v.subcategoria === subcat);
        
        // Ordenar: Intermediaci√≥n primero, luego por ID
        filtered.sort((a, b) => {
            // Intermediaci√≥n antes que veh√≠culos
            if (a._esVehiculo && !b._esVehiculo) return 1;
            if (!a._esVehiculo && b._esVehiculo) return -1;
            // Dentro del mismo tipo, por ID descendente
            const numA = parseInt((a.id || '').toString().replace('P', '')) || 0;
            const numB = parseInt((b.id || '').toString().replace('P', '')) || 0;
            return numB - numA;
        });
        
        tbody.innerHTML = filtered.map((v) => {
            const esVehiculo = v._esVehiculo;
            const img = v.imagenes ? v.imagenes.split(',')[0] : '';
            const imgHtml = img ? '<img src="' + escapeHTML(img) + '" style="width:50px;height:35px;object-fit:cover;border-radius:4px;">' : '‚Äî';
            
            const estadoMap = {
                'vendido': 'vendido',
                'alquilado': 'status-rented',
                'reservado': 'status-reserved',
                'disponible': 'publicado',
                'publicado': 'publicado',
                'oculto': 'oculto',
                'taller': 'taller'
            };
            const estadoClass = estadoMap[v.estado] || 'publicado';
            const estadoText = v.estado || 'disponible';
            
            // Calcular beneficio
            const coste = parseFloat(v.coste) || 0;
            const precioVenta = parseFloat(v.precio_venta) || parseFloat(v.precio) || 0;
            let gastosTotal = 0, ingresosTotal = 0;
            try { gastosTotal = (JSON.parse(v.gastos_json || v.mantenimiento_json || '[]')).reduce((s, g) => s + (parseFloat(g.importe) || parseFloat(g.coste) || 0), 0); } catch(e) {}
            try { ingresosTotal = (JSON.parse(v.ingresos_json || v.renta_json || '[]')).reduce((s, i) => s + (parseFloat(i.importe) || 0), 0); } catch(e) {}
            const beneficio = precioVenta - coste - gastosTotal + ingresosTotal;
            
            // Documentos
            const numDocs = v.documentacion ? v.documentacion.split(',').filter(d => d.trim()).length : 0;
            
            // Estilo diferente para veh√≠culos propios
            const rowStyle = esVehiculo ? 'background:#f0f9ff;' : '';
            const idPrefix = esVehiculo ? '<span style="color:#3b82f6" title="Veh√≠culo propio">V</span>' : '';
            
            let row = '<tr style="' + rowStyle + '">';
            row += '<td><strong>' + idPrefix + escapeHTML(v.id || '?') + '</strong></td>';
            row += '<td>' + imgHtml + '</td>';
            row += '<td>' + escapeHTML(v.subcategoria || '‚Äî') + '</td>';
            row += '<td>' + escapeHTML(v.marca || '‚Äî') + '</td>';
            row += '<td>' + escapeHTML(v.modelo || '‚Äî') + '</td>';
            row += '<td>' + (v.ano || v.a√±o || '‚Äî') + '</td>';
            
            if (showId) row += '<td>' + escapeHTML(v.matricula || '‚Äî') + '</td>';
            if (showDoc) row += '<td>' + (numDocs > 0 ? 'üìÑ ' + numDocs : '‚Äî') + '</td>';
            if (showProp !== false) row += '<td>' + (esVehiculo ? '<span style="color:#3b82f6;font-weight:600">PROPIO</span>' : escapeHTML(v.propietario || '‚Äî')) + '</td>';
            row += '<td class="num">' + (precioVenta ? precioVenta.toLocaleString() + '‚Ç¨' : 'Cons') + '</td>';
            
            if (showCue) {
                row += '<td class="num">' + (coste ? coste.toLocaleString() + '‚Ç¨' : '‚Äî') + '</td>';
                row += '<td class="num">' + (gastosTotal ? gastosTotal.toLocaleString() + '‚Ç¨' : '‚Äî') + '</td>';
                row += '<td class="num" style="color:#059669">' + (ingresosTotal ? ingresosTotal.toLocaleString() + '‚Ç¨' : '‚Äî') + '</td>';
                row += '<td class="num" style="color:' + (beneficio >= 0 ? '#10b981' : '#ef4444') + ';font-weight:600">' + beneficio.toLocaleString() + '‚Ç¨</td>';
            }
            
            row += '<td><span class="badge-estado ' + escapeHTML(estadoClass) + '">' + escapeHTML(estadoText) + '</span></td>';

            if (esVehiculo) {
                row += '<td class="table-actions">';
                row += '<button onclick="editVeh(' + cache.vehiculos.indexOf(cache.vehiculos.find(x => x.id === v.id)) + ')" title="Editar">‚úèÔ∏è</button>';
                if (v.estado !== 'vendido') row += '<button onclick="abrirModalVender(\'' + escapeHTML(v.id) + '\', \'vehiculos\')" title="Vender" style="font-weight:bold">‚Ç¨</button>';
                row += '</td></tr>';
            } else {
                row += '<td class="table-actions">';
                row += '<button onclick="editarInter(\'' + escapeHTML(v.id) + '\')" title="Editar">‚úèÔ∏è</button>';
                if (v.estado !== 'vendido') row += '<button onclick="abrirModalVender(\'' + escapeHTML(v.id) + '\', \'intermediacion\')" title="Vender" style="font-weight:bold">‚Ç¨</button>';
                row += '<button onclick="prepDelInter(\'' + escapeHTML(v.id) + '\', ' + (parseInt(v._row)||0) + ')" title="Eliminar">üóëÔ∏è</button>';
                row += '</td></tr>';
            }
            
            return row;
        }).join('');
    }
    
    function filtrarInter() { renderInter(); }
    
    function abrirModalIntermediacion() {
        document.getElementById('modalInterTitle').textContent = 'Nuevo Veh√≠culo (Intermediaci√≥n)';
        document.getElementById('interId').value = '';
        document.getElementById('interRow').value = '';
        
        // Estado
        setEstadoInter('disponible');
        
        // Limpiar campos
        ['interSubcat', 'interMarca', 'interModelo', 'interAno', 'interMatricula',
         'interPrecioVenta', 'interUbicacion', 'interUbicacionEn', 'interDescripcion', 'interDescripcionEn',
         'interPropietario', 'interTelefono', 'interNotas',
         'interPrecioMin', 'interCoste', 'interComision', 'interFechaAdq'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        
        interImagenes = [];
        interImagenesFiles = [];
        interDocs = [];
        interDocsFiles = [];
        interGastos = [];
        interIngresos = [];
        interCaracteristicas = {};
        
        document.getElementById('interImgPreview').innerHTML = '';
        document.getElementById('docsPreviewInter').innerHTML = '';
        document.getElementById('interGastosBody').innerHTML = '';
        document.getElementById('interIngresosBody').innerHTML = '';
        document.getElementById('interGastosTotal').textContent = '0';
        document.getElementById('interIngresosTotal').textContent = '0';
        document.getElementById('interBeneficio').textContent = '0';
        
        cargarSubcatsInter();
        renderFiltrosGridInter({});
        renderCaracteristicasInter({});
        abrirModal('modalIntermediacion');
    }
    
    // Editar
    async function editarInter(id) {
        const v = cache.intermediacion.find(x => String(x.id) === String(id));
        if (!v) return;
        
        document.getElementById('modalInterTitle').textContent = 'Editar ' + id;
        document.getElementById('interId').value = v.id;
        document.getElementById('interRow').value = v._row;
        
        setEstadoInter(v.estado || 'disponible');
        
        cargarSubcatsInter();
        setTimeout(() => document.getElementById('interSubcat').value = v.subcategoria || '', 50);
        
        document.getElementById('interMarca').value = v.marca || '';
        document.getElementById('interModelo').value = v.modelo || '';
        document.getElementById('interAno').value = v.ano || '';
        document.getElementById('interMatricula').value = v.matricula || '';
        document.getElementById('interPrecioVenta').value = v.precio_venta || '';
        document.getElementById('interUbicacion').value = v.ubicacion || '';
        document.getElementById('interUbicacionEn').value = v.ubicacion_en || '';
        document.getElementById('interDescripcion').value = v.descripcion || '';
        document.getElementById('interDescripcionEn').value = v.descripcion_en || '';
        document.getElementById('interPropietario').value = v.propietario || '';
        document.getElementById('interTelefono').value = v.telefono || '';
        document.getElementById('interNotas').value = v.notas || '';
        document.getElementById('interPrecioMin').value = v.precio_minimo || '';
        document.getElementById('interCoste').value = v.coste || '';
        document.getElementById('interComision').value = v.comision || '';
        document.getElementById('interFechaAdq').value = v.fecha_adquisicion || '';
        
        // Im√°genes
        interImagenes = v.imagenes ? v.imagenes.split(',').filter(u => u.trim()) : [];
        interImagenesFiles = [];
        renderInterImagenes();
        
        // Documentos
        interDocs = [];
        if (v.documentacion) {
            v.documentacion.split(',').forEach(item => {
                const trimmed = item.trim();
                if (trimmed) {
                    if (trimmed.includes('|')) {
                        const [name, url] = trimmed.split('|');
                        interDocs.push({ name, url });
                    } else {
                        interDocs.push({ name: 'Documento', url: trimmed });
                    }
                }
            });
        }
        interDocsFiles = [];
        renderDocsPreviewInter();
        
        // Gastos
        try { interGastos = JSON.parse(v.gastos_json || '[]'); } catch(e) { interGastos = []; }
        renderInterGastos();
        
        // Ingresos
        try { interIngresos = JSON.parse(v.ingresos_json || '[]'); } catch(e) { interIngresos = []; }
        renderInterIngresos();
        
        // Filtros
        let filtros = {};
        try { filtros = JSON.parse(v.filtros_json || '{}'); } catch(e) {}
        renderFiltrosGridInter(filtros);
        
        // Caracter√≠sticas
        try { interCaracteristicas = JSON.parse(v.caracteristicas_json || '{}'); } catch(e) { interCaracteristicas = {}; }
        renderCaracteristicasInter(interCaracteristicas);
        
        calcularBeneficioInter();
        abrirModal('modalIntermediacion');
    }
    
    // Renderizar filtros (reutiliza l√≥gica de veh√≠culos)
    function renderFiltrosGridInter(vals = {}) {
        const grid = document.getElementById('filtrosGridInter');
        if (!grid) return;
        
        const excluir = ['precio', 'marca', 'a√±o', 'ubicacion'];
        const filtros = (cache.filtros || []).filter(f => {
            const estado = normalizarEstadoFiltro(f);
            return estado !== 'inactivo' && !excluir.includes((f.nombre||'').toLowerCase());
        });
        
        grid.innerHTML = filtros.map(f => {
            const nombre = f.nombre || '';
            const nombreLower = nombre.toLowerCase();
            const tipo = (f.tipo || '').toLowerCase();
            
            if (tipo === 'tick' || tipo === 'checkbox' || tipo === 'boolean') {
                let checked = false;
                if (vals && typeof vals === 'object') {
                    const matchKey = Object.keys(vals).find(k => k.toLowerCase() === nombreLower);
                    if (matchKey) {
                        const valor = vals[matchKey];
                        checked = valor === true || valor === 'TRUE' || valor === 'true' || valor === 'Si' || valor === 'S√≠';
                    }
                }
                return `<div class="filtro-item filtro-tick"><label class="checkbox-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 12px;background:#f8f9fa;border:1px solid #e5e7eb;border-radius:6px"><input type="checkbox" data-filtro="${escapeHTML(nombre)}" data-tipo="tick" ${checked ? 'checked' : ''} style="width:18px;height:18px"><span style="font-size:13px">${escapeHTML(nombre)}</span></label></div>`;
            }
            
            let vEs = '', vEn = '';
            if (vals && typeof vals === 'object') {
                const matchKey = Object.keys(vals).find(k => k.toLowerCase() === nombreLower);
                if (matchKey) {
                    const valor = vals[matchKey];
                    if (typeof valor === 'object' && valor !== null) {
                        vEs = valor.es || '';
                        vEn = valor.en || '';
                    } else {
                        vEs = valor || '';
                    }
                }
            }
            
            return `<div class="filtro-item filtro-bilingue"><label>${escapeHTML(nombre)}</label><div style="display:flex;gap:8px"><div style="flex:1"><span style="font-size:10px;color:#666">üá™üá∏</span><input type="text" data-filtro="${escapeHTML(nombre)}" data-lang="es" value="${escapeHTML(vEs)}" placeholder="${escapeHTML(f.tipo||'')}"></div><div style="flex:1"><span style="font-size:10px;color:#666">üá¨üáß</span><input type="text" data-filtro="${escapeHTML(nombre)}" data-lang="en" value="${escapeHTML(vEn)}" placeholder="${escapeHTML(f.tipo||'')}"></div></div></div>`;
        }).join('');
    }
    
    // Caracter√≠sticas adicionales
    function renderCaracteristicasInter(data = {}) {
        const container = document.getElementById('caracteristicasContainerInter');
        if (!container) return;
        interCaracteristicas = typeof data === 'object' ? data : {};
        
        const entries = Object.entries(interCaracteristicas);
        container.innerHTML = entries.map(([key, val], i) => `
            <div class="caract-row" style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" value="${escapeHTML(key)}" placeholder="Nombre" style="flex:1" onchange="updateCaractInter(${i}, 'key', this.value)">
                <input type="text" value="${escapeHTML(val)}" placeholder="Valor" style="flex:1" onchange="updateCaractInter(${i}, 'val', this.value)">
                <button type="button" onclick="removeCaractInter(${i})" style="background:#ef4444;color:#fff;border:none;border-radius:4px;padding:0 10px">√ó</button>
            </div>
        `).join('');
    }
    
    function addCaracteristicaInter() {
        interCaracteristicas[''] = '';
        renderCaracteristicasInter(interCaracteristicas);
    }
    
    function updateCaractInter(idx, field, value) {
        const entries = Object.entries(interCaracteristicas);
        if (field === 'key') {
            const oldKey = entries[idx][0];
            const val = entries[idx][1];
            delete interCaracteristicas[oldKey];
            interCaracteristicas[value] = val;
        } else {
            const key = entries[idx][0];
            interCaracteristicas[key] = value;
        }
    }
    
    function removeCaractInter(idx) {
        const entries = Object.entries(interCaracteristicas);
        delete interCaracteristicas[entries[idx][0]];
        renderCaracteristicasInter(interCaracteristicas);
    }
    
    function getCaracteristicasInter() {
        const result = {};
        Object.entries(interCaracteristicas).forEach(([k, v]) => {
            if (k && k.trim()) result[k.trim()] = v;
        });
        return result;
    }
    
    // Im√°genes
    async function handleImagesInter(event) {
        const files = Array.from(event.target.files);
        if (interImagenes.length + interImagenesFiles.length + files.length > 10) {
            toast('M√°ximo 10 im√°genes', 'error');
            return;
        }
        interImagenesFiles.push(...files);
        renderInterImagenes();
    }
    
    function renderInterImagenes() {
        const container = document.getElementById('interImgPreview');
        let html = '';
        
        interImagenes.forEach((url, i) => {
            html += `<div class="img-thumb"><img src="${escapeHTML(url)}"><button type="button" onclick="removeInterImg(${i}, 'url')">√ó</button></div>`;
        });

        interImagenesFiles.forEach((file, i) => {
            const url = URL.createObjectURL(file);
            html += `<div class="img-thumb"><img src="${escapeHTML(url)}"><span class="pending">‚è≥</span><button type="button" onclick="removeInterImg(${i}, 'file')">√ó</button></div>`;
        });
        
        container.innerHTML = html;
    }
    
    function removeInterImg(idx, tipo) {
        if (tipo === 'url') interImagenes.splice(idx, 1);
        else interImagenesFiles.splice(idx, 1);
        renderInterImagenes();
    }
    
    // Documentos
    function handleDocsInter(event) {
        const files = Array.from(event.target.files);
        interDocsFiles.push(...files);
        renderDocsPreviewInter();
    }
    
    function renderDocsPreviewInter() {
        const container = document.getElementById('docsPreviewInter');
        let html = '';
        
        interDocs.forEach((doc, i) => {
            html += `<div class="doc-preview"><a href="${escapeHTML(doc.url)}" target="_blank">üìÑ ${escapeHTML(doc.name)}</a><button class="edit-name" onclick="editDocNameInter(${i})">‚úèÔ∏è</button><button class="remove" onclick="removeDocInter(${i}, 'url')">X</button></div>`;
        });

        interDocsFiles.forEach((file, i) => {
            html += `<div class="doc-preview doc-pending"><span>üìÑ ${escapeHTML(file.name)} (pendiente)</span><button class="remove" onclick="removeDocInter(${i}, 'file')">X</button></div>`;
        });
        
        container.innerHTML = html;
    }
    
    function editDocNameInter(i) {
        const newName = prompt('Nombre del documento:', interDocs[i].name);
        if (newName && newName.trim()) {
            interDocs[i].name = newName.trim();
            renderDocsPreviewInter();
        }
    }
    
    function removeDocInter(idx, tipo) {
        if (tipo === 'url') interDocs.splice(idx, 1);
        else interDocsFiles.splice(idx, 1);
        renderDocsPreviewInter();
    }
    
    // Gastos
    function addFilaGastoInter() {
        interGastos.push({ fecha: '', concepto: '', importe: 0, factura: '' });
        renderInterGastos();
    }
    
    function renderInterGastos() {
        const tbody = document.getElementById('interGastosBody');
        tbody.innerHTML = interGastos.map((g, i) => {
            let facturaHtml;
            if (g.factura) {
                // Extraer nombre y URL si tiene formato nombre|url
                let nombre = 'üìÑ';
                let url = g.factura;
                if (g.factura.includes('|')) {
                    const parts = g.factura.split('|');
                    nombre = parts[0];
                    url = parts[1];
                }
                facturaHtml = '<a href="' + escapeHTML(url) + '" target="_blank" title="' + escapeHTML(nombre) + '">üìÑ ' + escapeHTML(nombre.length > 15 ? nombre.substring(0,12) + '...' : nombre) + '</a>';
            } else {
                facturaHtml = '<input type="file" onchange="subirFacturaGastoInter(' + i + ', this.files[0])" style="width:80px">';
            }
            return '<tr>' +
                '<td><input type="date" value="' + escapeHTML(g.fecha || '') + '" onchange="updateInterGasto(' + i + ', \'fecha\', this.value)"></td>' +
                '<td><input type="text" value="' + escapeHTML(g.concepto || '') + '" onchange="updateInterGasto(' + i + ', \'concepto\', this.value)" placeholder="Concepto"></td>' +
                '<td><input type="number" value="' + escapeHTML(g.importe || '') + '" onchange="updateInterGasto(' + i + ', \'importe\', this.value)" placeholder="0"></td>' +
                '<td>' + facturaHtml + '</td>' +
                '<td><button type="button" onclick="removeInterGasto(' + i + ')">üóëÔ∏è</button></td>' +
            '</tr>';
        }).join('');
        
        const total = interGastos.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
        document.getElementById('interGastosTotal').textContent = total.toLocaleString();
        calcularBeneficioInter();
    }
    
    function updateInterGasto(idx, field, value) {
        interGastos[idx][field] = field === 'importe' ? parseFloat(value) || 0 : value;
        renderInterGastos();
    }
    
    function removeInterGasto(idx) {
        interGastos.splice(idx, 1);
        renderInterGastos();
    }
    
    // Subir factura de gasto a Drive
    async function subirFacturaGastoInter(idx, file) {
        if (!file) return;
        
        const id = document.getElementById('interId').value || 'TEMP_' + Date.now();
        
        try {
            toast('Subiendo factura...', 'info');
            const root = await getOrCreateFolder('TankIberica');
            const inter = await getOrCreateFolder('Intermediacion', root);
            
            // Obtener datos del formulario
            const subcategoria = document.getElementById('interSubcategoria')?.value || '';
            const marca = document.getElementById('interMarca')?.value || '';
            const ano = document.getElementById('interAno')?.value || '';
            const matricula = document.getElementById('interMatricula')?.value || '';
            const tipoClase = obtenerTipoClaseFormularioInter();
            
            let parentFolder = inter;
            
            if (subcategoria) {
                parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
            }
            
            if (tipoClase) {
                parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
            }
            
            const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, id);
            const folder = await getOrCreateFolder(nombreCarpeta, parentFolder);
            const facturas = await getOrCreateFolder('Facturas', folder);
            
            const meta = {name: file.name, parents: [facturas]};
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
            form.append('file', file);
            
            const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + token},
                body: form
            }).then(r => r.json());
            
            await fetch('https://www.googleapis.com/drive/v3/files/' + up.id + '/permissions', {
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
                body: JSON.stringify({role: 'reader', type: 'anyone'})
            });
            
            const url = up.webViewLink || ('https://drive.google.com/file/d/' + up.id + '/view');
            interGastos[idx].factura = file.name + '|' + url;
            interGastos[idx].factura_nombre = file.name;
            renderInterGastos();
            toast('Factura subida', 'success');
            
        } catch(e) {
            console.error(e);
            toast('Error subiendo factura: ' + e.message, 'error');
        }
    }
    
    // Subir factura de ingreso a Drive
    async function subirFacturaIngresoInter(idx, file) {
        if (!file) return;
        
        const id = document.getElementById('interId').value || 'TEMP_' + Date.now();
        
        try {
            toast('Subiendo factura...', 'info');
            const root = await getOrCreateFolder('TankIberica');
            const inter = await getOrCreateFolder('Intermediacion', root);
            
            // Obtener datos del formulario
            const subcategoria = document.getElementById('interSubcategoria')?.value || '';
            const marca = document.getElementById('interMarca')?.value || '';
            const ano = document.getElementById('interAno')?.value || '';
            const matricula = document.getElementById('interMatricula')?.value || '';
            const tipoClase = obtenerTipoClaseFormularioInter();
            
            let parentFolder = inter;
            
            if (subcategoria) {
                parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
            }
            
            if (tipoClase) {
                parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
            }
            
            const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, id);
            const folder = await getOrCreateFolder(nombreCarpeta, parentFolder);
            const facturas = await getOrCreateFolder('Facturas', folder);
            
            const meta = {name: file.name, parents: [facturas]};
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
            form.append('file', file);
            
            const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + token},
                body: form
            }).then(r => r.json());
            
            await fetch('https://www.googleapis.com/drive/v3/files/' + up.id + '/permissions', {
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
                body: JSON.stringify({role: 'reader', type: 'anyone'})
            });
            
            const url = up.webViewLink || ('https://drive.google.com/file/d/' + up.id + '/view');
            interIngresos[idx].factura = file.name + '|' + url;
            interIngresos[idx].factura_nombre = file.name;
            renderInterIngresos();
            toast('Factura subida', 'success');
            
        } catch(e) {
            console.error(e);
            toast('Error subiendo factura: ' + e.message, 'error');
        }
    }
    
    // Ingresos
    function addFilaIngresoInter() {
        interIngresos.push({ desde: '', hasta: '', concepto: '', importe: 0, factura: '' });
        renderInterIngresos();
    }
    
    function renderInterIngresos() {
        const tbody = document.getElementById('interIngresosBody');
        tbody.innerHTML = interIngresos.map((g, i) => {
            let facturaHtml;
            if (g.factura) {
                // Extraer nombre y URL si tiene formato nombre|url
                let nombre = 'üìÑ';
                let url = g.factura;
                if (g.factura.includes('|')) {
                    const parts = g.factura.split('|');
                    nombre = parts[0];
                    url = parts[1];
                }
                facturaHtml = '<a href="' + escapeHTML(url) + '" target="_blank" title="' + escapeHTML(nombre) + '">üìÑ ' + escapeHTML(nombre.length > 15 ? nombre.substring(0,12) + '...' : nombre) + '</a>';
            } else {
                facturaHtml = '<input type="file" onchange="subirFacturaIngresoInter(' + i + ', this.files[0])" style="width:80px">';
            }
            return '<tr>' +
                '<td><input type="date" value="' + escapeHTML(g.desde || '') + '" onchange="updateInterIngreso(' + i + ', \'desde\', this.value)"></td>' +
                '<td><input type="date" value="' + (g.hasta || '') + '" onchange="updateInterIngreso(' + i + ', \'hasta\', this.value)"></td>' +
                '<td><input type="text" value="' + escapeHTML(g.concepto || '') + '" onchange="updateInterIngreso(' + i + ', \'concepto\', this.value)" placeholder="Concepto"></td>' +
                '<td><input type="number" value="' + escapeHTML(g.importe || '') + '" onchange="updateInterIngreso(' + i + ', \'importe\', this.value)" placeholder="0"></td>' +
                '<td>' + facturaHtml + '</td>' +
                '<td><button type="button" onclick="removeInterIngreso(' + i + ')">üóëÔ∏è</button></td>' +
            '</tr>';
        }).join('');
        
        const total = interIngresos.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
        document.getElementById('interIngresosTotal').textContent = total.toLocaleString();
        calcularBeneficioInter();
    }
    
    function updateInterIngreso(idx, field, value) {
        interIngresos[idx][field] = field === 'importe' ? parseFloat(value) || 0 : value;
        renderInterIngresos();
    }
    
    function removeInterIngreso(idx) {
        interIngresos.splice(idx, 1);
        renderInterIngresos();
    }
    
    // Calcular beneficio
    function calcularBeneficioInter() {
        const venta = parseFloat(document.getElementById('interPrecioVenta')?.value) || 0;
        const coste = parseFloat(document.getElementById('interCoste')?.value) || 0;
        const comision = parseFloat(document.getElementById('interComision')?.value) || 0;
        const gastos = interGastos.reduce((sum, g) => sum + (parseFloat(g.importe) || 0), 0);
        const ingresos = interIngresos.reduce((sum, i) => sum + (parseFloat(i.importe) || 0), 0);
        
        let beneficio;
        let formula;
        
        if (comision > 0 && coste === 0) {
            // Solo comisi√≥n (no compramos el veh√≠culo)
            beneficio = (venta * comision / 100) - gastos + ingresos;
            formula = `(${venta.toLocaleString()}‚Ç¨ √ó ${comision}%) - ${gastos.toLocaleString()}‚Ç¨ gastos + ${ingresos.toLocaleString()}‚Ç¨ ingresos`;
        } else {
            // Compra-venta normal
            beneficio = venta - coste - gastos + ingresos;
            formula = `${venta.toLocaleString()}‚Ç¨ venta - ${coste.toLocaleString()}‚Ç¨ coste - ${gastos.toLocaleString()}‚Ç¨ gastos + ${ingresos.toLocaleString()}‚Ç¨ ingresos`;
        }
        
        const el = document.getElementById('interBeneficio');
        if (el) {
            el.textContent = beneficio.toLocaleString();
            el.style.color = beneficio >= 0 ? '#10b981' : '#ef4444';
        }
        
        const formulaEl = document.getElementById('interBeneficioFormula');
        if (formulaEl) formulaEl.textContent = formula;
    }
    
    // Guardar
    async function guardarIntermediacion() {
        const id = document.getElementById('interId').value;
        const row = document.getElementById('interRow').value;
        
        const marca = document.getElementById('interMarca').value.trim();
        const subcategoria = document.getElementById('interSubcat').value;
        
        if (!marca) {
            toast('Marca es obligatoria', 'error');
            return;
        }
        
        // Generar nuevo ID si es nuevo (reutiliza huecos)
        let newId = id;
        if (!newId) {
            newId = obtenerSiguienteIdIntermediacion();
        }
        
        try {
            // Subir im√°genes nuevas
            let urls = [...interImagenes];
            for (const f of interImagenesFiles) {
                toast('Subiendo imagen...', 'info');
                const url = await uploadImgInter(f, newId);
                urls.push(url);
            }
            
            // Subir documentos nuevos
            let docsList = [...interDocs];
            for (const f of interDocsFiles) {
                toast('Subiendo documento: ' + f.name, 'info');
                const docObj = await uploadDocInter(f, newId);
                docsList.push(docObj);
            }
            
            // Recoger filtros
            const filtros = {};
            document.querySelectorAll('#filtrosGridInter input[data-filtro]').forEach(inp => {
                const filtroName = inp.dataset.filtro;
                const tipo = inp.dataset.tipo;
                
                if (filtroName) {
                    if (tipo === 'tick') {
                        if (inp.checked) filtros[filtroName] = true;
                    } else {
                        const lang = inp.dataset.lang || 'es';
                        if (!filtros[filtroName]) filtros[filtroName] = { es: '', en: '' };
                        if (inp.value.trim()) filtros[filtroName][lang] = inp.value.trim();
                    }
                }
            });
            // Limpiar vac√≠os
            Object.keys(filtros).forEach(key => {
                const val = filtros[key];
                if (typeof val === 'object' && !val.es && !val.en) delete filtros[key];
            });
            
            const caracteristicas = getCaracteristicasInter();
            
            // Estructura de datos para la hoja
            const data = [
                newId,
                urls.join(','),
                subcategoria,
                marca,
                document.getElementById('interModelo').value,
                document.getElementById('interAno').value,
                document.getElementById('interMatricula').value,
                document.getElementById('interPrecioVenta').value || 0,
                document.getElementById('interUbicacion').value,
                document.getElementById('interUbicacionEn').value,
                document.getElementById('interDescripcion').value,
                document.getElementById('interDescripcionEn').value,
                JSON.stringify(filtros),
                JSON.stringify(caracteristicas),
                document.getElementById('interEstado').value,
                document.getElementById('interPropietario').value,
                document.getElementById('interTelefono').value,
                document.getElementById('interNotas').value,
                docsList.map(d => d.name + '|' + d.url).join(','),
                document.getElementById('interPrecioMin').value,
                document.getElementById('interCoste').value,
                document.getElementById('interComision').value,
                document.getElementById('interFechaAdq').value,
                JSON.stringify(interGastos),
                JSON.stringify(interIngresos),
                id ? undefined : new Date().toISOString().split('T')[0]
            ];
            
            if (row) {
                await writeRow('intermediacion', parseInt(row), data);
            } else {
                await appendRow('intermediacion', data);
            }
            
            toast('Guardado correctamente', 'success');
            cerrarModal('modalIntermediacion');
            cache.intermediacion = await readSheetData('intermediacion');
            renderInter();
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Subir imagen a Drive
    // Obtener tipo/clase desde filtros del formulario de Intermediaci√≥n
    function obtenerTipoClaseFormularioInter() {
        let tipo = '';
        document.querySelectorAll('#filtrosGridInter input[data-filtro]').forEach(inp => {
            const filtroName = (inp.dataset.filtro || '').toLowerCase();
            if ((filtroName === 'tipo' || filtroName === 'clase') && inp.value.trim()) {
                tipo = inp.value.trim().replace(/[\/\\:*?"<>|]/g, '_');
            }
        });
        return tipo;
    }
    
    async function uploadImgInter(file, vehId) {
        const root = await getOrCreateFolder('TankIberica');
        const inter = await getOrCreateFolder('Intermediacion', root);
        
        // Obtener datos del formulario para la estructura de carpetas
        const subcategoria = document.getElementById('interSubcategoria')?.value || '';
        const marca = document.getElementById('interMarca')?.value || '';
        const ano = document.getElementById('interAno')?.value || '';
        const matricula = document.getElementById('interMatricula')?.value || '';
        const tipoClase = obtenerTipoClaseFormularioInter();
        
        // Crear estructura: Intermediacion/[Subcategoria]/[Tipo si existe]/[Marca_(A√±o)_Matricula]/
        let parentFolder = inter;
        
        if (subcategoria) {
            parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
        }
        
        if (tipoClase) {
            parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
        }
        
        const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, vehId);
        const folder = await getOrCreateFolder(nombreCarpeta, parentFolder);
        const fotos = await getOrCreateFolder('Fotos', folder);
        
        const meta = {name: file.name, parents: [fotos]};
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
        form.append('file', file);
        
        const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token},
            body: form
        }).then(r => r.json());
        
        await fetch('https://www.googleapis.com/drive/v3/files/' + up.id + '/permissions', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
            body: JSON.stringify({role: 'reader', type: 'anyone'})
        });
        
        return 'https://lh3.googleusercontent.com/d/' + up.id;
    }
    
    // Subir documento a Drive
    async function uploadDocInter(file, vehId) {
        const root = await getOrCreateFolder('TankIberica');
        const inter = await getOrCreateFolder('Intermediacion', root);
        
        // Obtener datos del formulario
        const subcategoria = document.getElementById('interSubcategoria')?.value || '';
        const marca = document.getElementById('interMarca')?.value || '';
        const ano = document.getElementById('interAno')?.value || '';
        const matricula = document.getElementById('interMatricula')?.value || '';
        const tipoClase = obtenerTipoClaseFormularioInter();
        
        let parentFolder = inter;
        
        if (subcategoria) {
            parentFolder = await getOrCreateFolder(subcategoria, parentFolder);
        }
        
        if (tipoClase) {
            parentFolder = await getOrCreateFolder(tipoClase, parentFolder);
        }
        
        const nombreCarpeta = generarNombreCarpetaVeh(marca, ano, matricula, vehId);
        const folder = await getOrCreateFolder(nombreCarpeta, parentFolder);
        const docs = await getOrCreateFolder('Documentos', folder);
        
        const meta = {name: file.name, parents: [docs]};
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
        form.append('file', file);
        
        const up = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token},
            body: form
        }).then(r => r.json());
        
        await fetch('https://www.googleapis.com/drive/v3/files/' + up.id + '/permissions', {
            method: 'POST',
            headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
            body: JSON.stringify({role: 'reader', type: 'anyone'})
        });
        
        return { name: file.name, url: up.webViewLink || ('https://drive.google.com/file/d/' + up.id + '/view') };
    }
    
    // Eliminar con confirmaci√≥n segura
    function prepDelInter(id, row) {
        document.getElementById('delTipo').value = 'intermediacion';
        document.getElementById('delRow').value = row;
        
        const v = cache.intermediacion.find(x => String(x.id) === String(id));
        const infoEl = document.getElementById('delInfo');
        if (infoEl && v) {
            infoEl.textContent = `Intermediaci√≥n: ${v.marca || ''} ${v.modelo || ''} (ID: ${v.id}, Fila: ${row})`;
        }
        
        const input = document.getElementById('confirmInput');
        const btn = document.getElementById('btnConfirmDel');
        input.value = '';
        btn.disabled = true;
        input.oninput = function() { btn.disabled = this.value !== 'Borrar'; };
        
        abrirModal('modalConfirm');
        setTimeout(() => input.focus(), 100);
    }
    
    // Modal Vender (compartido entre veh√≠culos e intermediaci√≥n)
    function abrirModalVender(id, tipo) {
        document.getElementById('venderId').value = id;
        document.getElementById('venderTipo').value = tipo;
        
        let v;
        if (tipo === 'intermediacion') {
            v = cache.intermediacion.find(x => String(x.id) === String(id));
            document.getElementById('venderComisionGroup').style.display = 'block';
            document.getElementById('venderComision').value = v?.comision || '';
        } else {
            v = cache.vehiculos.find(x => String(x.id) === String(id));
            document.getElementById('venderComisionGroup').style.display = 'none';
        }
        
        if (!v) return;
        
        document.getElementById('venderRow').value = v._row;
        document.getElementById('venderInfo').innerHTML = `<strong>${escapeHTML(v.marca || '')} ${escapeHTML(v.modelo || '')}</strong> (${escapeHTML(v.matricula || 'Sin matr√≠cula')})<br>ID: ${escapeHTML(v.id)}`;
        document.getElementById('venderPrecio').value = v.precio_venta || v.precio || '';
        document.getElementById('venderComprador').value = '';
        document.getElementById('venderFecha').value = new Date().toISOString().split('T')[0];
        document.getElementById('venderNotas').value = '';
        
        calcularBeneficioVenta();
        abrirModal('modalVender');
    }
    
    function calcularBeneficioVenta() {
        const tipo = document.getElementById('venderTipo').value;
        const id = document.getElementById('venderId').value;
        const precioVenta = parseFloat(document.getElementById('venderPrecio').value) || 0;
        const comision = parseFloat(document.getElementById('venderComision')?.value) || 0;
        
        let v, coste = 0, gastos = 0, ingresos = 0;
        
        if (tipo === 'intermediacion') {
            v = cache.intermediacion.find(x => String(x.id) === String(id));
            coste = parseFloat(v?.coste) || 0;
            try { gastos = (JSON.parse(v?.gastos_json || '[]')).reduce((s, g) => s + (parseFloat(g.importe) || 0), 0); } catch(e) {}
            try { ingresos = (JSON.parse(v?.ingresos_json || '[]')).reduce((s, i) => s + (parseFloat(i.importe) || 0), 0); } catch(e) {}
        } else {
            v = cache.vehiculos.find(x => String(x.id) === String(id));
            coste = parseFloat(v?.coste) || 0;
            try { gastos = (JSON.parse(v?.mantenimiento_json || '[]')).reduce((s, g) => s + (parseFloat(g.coste) || 0), 0); } catch(e) {}
            try { ingresos = (JSON.parse(v?.renta_json || '[]')).reduce((s, i) => s + (parseFloat(i.importe) || 0), 0); } catch(e) {}
        }
        
        let beneficio;
        if (comision > 0 && coste === 0) {
            beneficio = (precioVenta * comision / 100) - gastos + ingresos;
        } else {
            beneficio = precioVenta - coste - gastos + ingresos;
        }
        
        const el = document.getElementById('venderBeneficio');
        el.textContent = beneficio.toLocaleString() + '‚Ç¨';
        el.style.color = beneficio >= 0 ? '#10b981' : '#ef4444';
    }
    
    // Confirmar venta
    async function confirmarVenta() {
        const id = document.getElementById('venderId').value;
        const tipo = document.getElementById('venderTipo').value;
        const row = document.getElementById('venderRow').value;
        const precioVenta = document.getElementById('venderPrecio').value;
        const comprador = document.getElementById('venderComprador').value;
        const fecha = document.getElementById('venderFecha').value;
        
        if (!precioVenta || !comprador || !fecha) {
            toast('Completa todos los campos obligatorios', 'error');
            return;
        }
        
        try {
            let v;
            if (tipo === 'intermediacion') {
                v = cache.intermediacion.find(x => String(x.id) === String(id));
            } else {
                v = cache.vehiculos.find(x => String(x.id) === String(id));
            }
            
            if (!v) throw new Error('Veh√≠culo no encontrado');
            
            // Calcular beneficio final
            const comision = parseFloat(document.getElementById('venderComision')?.value) || 0;
            const coste = parseFloat(v.coste) || 0;
            let gastos = 0, ingresos = 0;
            
            if (tipo === 'intermediacion') {
                try { gastos = (JSON.parse(v.gastos_json || '[]')).reduce((s, g) => s + (parseFloat(g.importe) || 0), 0); } catch(e) {}
                try { ingresos = (JSON.parse(v.ingresos_json || '[]')).reduce((s, i) => s + (parseFloat(i.importe) || 0), 0); } catch(e) {}
            } else {
                try { gastos = (JSON.parse(v.mantenimiento_json || '[]')).reduce((s, g) => s + (parseFloat(g.coste) || 0), 0); } catch(e) {}
                try { ingresos = (JSON.parse(v.renta_json || '[]')).reduce((s, i) => s + (parseFloat(i.importe) || 0), 0); } catch(e) {}
            }
            
            let beneficio;
            if (comision > 0 && coste === 0) {
                beneficio = (parseFloat(precioVenta) * comision / 100) - gastos + ingresos;
            } else {
                beneficio = parseFloat(precioVenta) - coste - gastos + ingresos;
            }
            
            // 1. A√±adir a hist√≥rico
            const historicoData = [
                v.id,
                v.imagenes || '',
                tipo === 'intermediacion' ? v.subcategoria : v.categoria,
                tipo === 'intermediacion' ? v.subcategoria : v.subcategoria,
                v.marca,
                v.modelo,
                v.ano || v.a√±o,
                precioVenta,
                v.ubicacion,
                v.ubicacion_en,
                v.descripcion,
                v.descripcion_en,
                v.filtros_json,
                v.caracteristicas_json,
                'vendido',
                v.matricula,
                v.documentacion,
                '', '', '', '', '', '', '', '', '', '', '', '', '', // campos t√©cnicos vac√≠os
                v.precio_minimo,
                v.coste,
                tipo === 'intermediacion' ? v.gastos_json : v.mantenimiento_json,
                v.fecha_adquisicion || v.adquisicion,
                tipo === 'intermediacion' ? v.ingresos_json : v.renta_json,
                v.precio_alquiler || '',
                comprador,
                fecha,
                document.getElementById('venderNotas').value,
                beneficio,
                tipo
            ];
            
            await appendRow('historico', historicoData);
            
            // 2. A√±adir a balance
            await appendRow('balance', [
                'B' + Date.now(),
                v.id,
                tipo,
                v.marca + ' ' + v.modelo,
                precioVenta,
                beneficio,
                fecha,
                'Venta a ' + comprador
            ]);
            
            // 3. Mover carpeta en Drive
            try {
                await moverCarpetaDrive(tipo === 'intermediacion' ? 'Intermediacion' : 'Vehiculos', 'Historico', v.id);
            } catch(e) {
                console.log('No se pudo mover carpeta:', e);
            }
            
            // 4. Eliminar de la hoja original
            await deleteRow(tipo, parseInt(row));
            
            toast('Venta registrada correctamente', 'success');
            cerrarModal('modalVender');
            
            // Recargar datos
            if (tipo === 'intermediacion') {
                cache.intermediacion = await readSheetData('intermediacion');
                renderInter();
            } else {
                cache.vehiculos = await readSheetData('vehiculos');
                filtrarVeh();
            }
            cache.historico = await readSheetData('historico');
            cache.balance = await readSheetData('balance');
            
        } catch(e) {
            console.error(e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Mover carpeta en Drive
    async function moverCarpetaDrive(origen, destino, id) {
        const root = await getOrCreateFolder('TankIberica');
        const origenFolder = await getOrCreateFolder(origen, root);
        const destinoFolder = await getOrCreateFolder(destino, root);
        
        // Buscar carpeta del veh√≠culo
        const q = `name='${id}' and '${origenFolder}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
        const search = await fetch('https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(q), {
            headers: {'Authorization': 'Bearer ' + token}
        }).then(r => r.json());
        
        if (search.files && search.files.length > 0) {
            const folderId = search.files[0].id;
            // Mover: a√±adir nuevo padre y quitar antiguo
            await fetch(`https://www.googleapis.com/drive/v3/files/${folderId}?addParents=${destinoFolder}&removeParents=${origenFolder}`, {
                method: 'PATCH',
                headers: {'Authorization': 'Bearer ' + token}
            });
        }
    }
    
    // Configuraci√≥n de tabla (placeholder - usa mismo sistema que veh√≠culos)
    function abrirConfigTablaInter() {
        toast('Usa la configuraci√≥n de tabla en Veh√≠culos - los grupos se comparten', 'info');
    }

    // ================================================
    // OJEADOS
    // ================================================
    
    // Plataformas por defecto
    let plataformasOjeados = ['Wallapop', 'Milanuncios', 'AutoScout24', 'Coches.net', 'Facebook', 'Otra'];
    
    // Cargar plataformas guardadas en localStorage
    function cargarPlataformas() {
        const saved = localStorage.getItem('tankiberica_plataformas');
        if (saved) {
            try {
                plataformasOjeados = JSON.parse(saved);
            } catch(e) {}
        }
        renderPlataformasSelects();
    }
    
    // Guardar plataformas en localStorage
    function guardarPlataformas() {
        localStorage.setItem('tankiberica_plataformas', JSON.stringify(plataformasOjeados));
        renderPlataformasSelects();
    }
    
    // Renderizar selects de plataformas
    function renderPlataformasSelects() {
        // Filtro
        const filtroSelect = document.getElementById('filtroOjeadoPlataforma');
        if (filtroSelect) {
            const currentVal = filtroSelect.value;
            filtroSelect.innerHTML = '<option value="">Todas las plataformas</option>' +
                plataformasOjeados.map(p => '<option value="' + escapeHTML(p) + '">' + escapeHTML(p) + '</option>').join('');
            filtroSelect.value = currentVal;
        }
        
        // Modal
        const modalSelect = document.getElementById('ojeadoPlataforma');
        if (modalSelect) {
            const currentVal = modalSelect.value;
            modalSelect.innerHTML = '<option value="">Seleccionar</option>' +
                plataformasOjeados.map(p => '<option value="' + escapeHTML(p) + '">' + escapeHTML(p) + '</option>').join('');
            modalSelect.value = currentVal;
        }
    }
    
    // Mostrar/ocultar campo de otra plataforma
    function onPlataformaChange() {
        const select = document.getElementById('ojeadoPlataforma');
        const otraGroup = document.getElementById('otraPlataformaGroup');
        if (select.value === 'Otra') {
            otraGroup.style.display = 'block';
        } else {
            otraGroup.style.display = 'none';
            document.getElementById('ojeadoOtraPlataforma').value = '';
        }
    }
    
    // Configuraci√≥n de plataformas
    function abrirConfigPlataformas() {
        const panel = document.getElementById('configPlataformasPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        if (panel.style.display === 'block') {
            renderPlataformasConfig();
        }
    }
    
    function cerrarConfigPlataformas() {
        document.getElementById('configPlataformasPanel').style.display = 'none';
    }
    
    function renderPlataformasConfig() {
        const container = document.getElementById('plataformasLista');
        container.innerHTML = plataformasOjeados.map((p, i) =>
            '<span style="background:#e2e8f0;padding:5px 10px;border-radius:4px;display:inline-flex;align-items:center;gap:5px">' +
                escapeHTML(p) +
                (p !== 'Otra' ? '<button onclick="eliminarPlataforma(' + i + ')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px">√ó</button>' : '') +
            '</span>'
        ).join('');
    }
    
    function agregarPlataforma() {
        const input = document.getElementById('nuevaPlataforma');
        const nombre = input.value.trim();
        if (!nombre) return toast('Escribe un nombre', 'error');
        if (plataformasOjeados.includes(nombre)) return toast('Ya existe', 'error');
        
        // Insertar antes de "Otra"
        const otraIdx = plataformasOjeados.indexOf('Otra');
        if (otraIdx !== -1) {
            plataformasOjeados.splice(otraIdx, 0, nombre);
        } else {
            plataformasOjeados.push(nombre);
        }
        
        guardarPlataformas();
        renderPlataformasConfig();
        input.value = '';
        toast('Plataforma a√±adida', 'success');
    }
    
    function eliminarPlataforma(idx) {
        if (plataformasOjeados[idx] === 'Otra') return;
        plataformasOjeados.splice(idx, 1);
        guardarPlataformas();
        renderPlataformasConfig();
        toast('Plataforma eliminada', 'success');
    }
    
    function renderOjeados() {
        // Cargar plataformas al primer render
        if (!document.getElementById('filtroOjeadoPlataforma')?.options?.length) {
            cargarPlataformas();
        }
        
        let data = [...(cache.ojeados || [])];
        
        // Aplicar filtros
        const buscar = (document.getElementById('buscarOjeado')?.value || '').toLowerCase();
        const estado = document.getElementById('filtroOjeadoEstado')?.value || '';
        const plataforma = document.getElementById('filtroOjeadoPlataforma')?.value || '';
        
        if (buscar) {
            data = data.filter(o => 
                (o.producto || '').toLowerCase().includes(buscar) ||
                (o.plataforma || '').toLowerCase().includes(buscar) ||
                (o.telefono || '').includes(buscar) ||
                (o.email || '').toLowerCase().includes(buscar)
            );
        }
        if (estado) data = data.filter(o => o.estado === estado);
        if (plataforma) data = data.filter(o => (o.plataforma || '').toLowerCase() === plataforma.toLowerCase());
        
        const tbody = document.getElementById('tOjeados');
        if (!data.length) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty">No hay ojeados registrados</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.map((o, i) => {
            const realIdx = cache.ojeados.indexOf(o);
            const estadoClass = o.estado || 'inactivo';
            const enlaceBtn = o.enlace ? '<a href="'+escapeHTML(o.enlace)+'" target="_blank" class="btn-view-file">Ver</a>' : '-';
            return '<tr>' +
                '<td>'+(parseInt(o.id) || i+1)+'</td>' +
                '<td>'+escapeHTML(o.producto || '-')+'</td>' +
                '<td>'+escapeHTML(o.plataforma || '-')+'</td>' +
                '<td>'+enlaceBtn+'</td>' +
                '<td class="num">'+(o.precio ? fmtNum(o.precio)+'‚Ç¨' : '-')+'</td>' +
                '<td class="num">'+(o.negociado ? fmtNum(o.negociado)+'‚Ç¨' : '-')+'</td>' +
                '<td>'+escapeHTML(o.telefono || '-')+'</td>' +
                '<td>'+escapeHTML(o.email || '-')+'</td>' +
                '<td><span class="status '+escapeHTML(estadoClass)+'">'+escapeHTML(o.estado || 'inactivo')+'</span></td>' +
                '<td class="table-actions">' +
                    '<button onclick="editarOjeado('+realIdx+')" title="Editar">‚úèÔ∏è</button>' +
                    '<button onclick="eliminarOjeado(\''+escapeHTML(o.id)+'\', '+(parseInt(o._row) || realIdx+2)+')" title="Eliminar">üóëÔ∏è</button>' +
                '</td>' +
            '</tr>';
        }).join('');
    }
    
    function filtrarOjeados() {
        renderOjeados();
    }
    
    function abrirModalOjeado() {
        cargarPlataformas();
        document.getElementById('ojeadoId').value = '';
        document.getElementById('ojeadoRow').value = '';
        document.getElementById('ojeadoProducto').value = '';
        document.getElementById('ojeadoPlataforma').value = '';
        document.getElementById('ojeadoOtraPlataforma').value = '';
        document.getElementById('otraPlataformaGroup').style.display = 'none';
        document.getElementById('ojeadoEnlace').value = '';
        document.getElementById('ojeadoPrecio').value = '';
        document.getElementById('ojeadoNegociado').value = '';
        document.getElementById('ojeadoTelefono').value = '';
        document.getElementById('ojeadoEmail').value = '';
        document.getElementById('ojeadoEstado').value = 'inactivo';
        document.getElementById('ojeadoNotas').value = '';
        document.getElementById('modalOjeadoTitle').textContent = 'Nuevo Ojeado';
        abrirModal('modalOjeado');
    }
    
    function editarOjeado(idx) {
        const o = cache.ojeados[idx];
        cargarPlataformas();
        if (!o) return;
        document.getElementById('ojeadoId').value = o.id || '';
        document.getElementById('ojeadoRow').value = o._row || '';
        document.getElementById('ojeadoProducto').value = o.producto || '';
        
        // Manejar plataforma - si no est√° en lista, mostrar en "Otra"
        const plataforma = o.plataforma || '';
        if (plataformasOjeados.includes(plataforma)) {
            document.getElementById('ojeadoPlataforma').value = plataforma;
            document.getElementById('otraPlataformaGroup').style.display = 'none';
        } else if (plataforma) {
            document.getElementById('ojeadoPlataforma').value = 'Otra';
            document.getElementById('ojeadoOtraPlataforma').value = plataforma;
            document.getElementById('otraPlataformaGroup').style.display = 'block';
        }
        
        document.getElementById('ojeadoEnlace').value = o.enlace || '';
        document.getElementById('ojeadoPrecio').value = o.precio || '';
        document.getElementById('ojeadoNegociado').value = o.negociado || '';
        document.getElementById('ojeadoTelefono').value = o.telefono || '';
        document.getElementById('ojeadoEmail').value = o.email || '';
        document.getElementById('ojeadoEstado').value = o.estado || 'inactivo';
        document.getElementById('ojeadoNotas').value = o.notas || '';
        document.getElementById('modalOjeadoTitle').textContent = 'Editar Ojeado';
        abrirModal('modalOjeado');
    }
    
    async function guardarOjeado() {
        const id = document.getElementById('ojeadoId').value;
        const row = document.getElementById('ojeadoRow').value;
        
        // Obtener plataforma (usar "Otra" personalizada si aplica)
        let plataforma = document.getElementById('ojeadoPlataforma').value;
        if (plataforma === 'Otra') {
            const otra = document.getElementById('ojeadoOtraPlataforma').value.trim();
            if (otra) plataforma = otra;
        }
        
        const data = [
            id || ('O' + (cache.ojeados.length + 1)),
            document.getElementById('ojeadoProducto').value,
            plataforma,
            document.getElementById('ojeadoEnlace').value,
            document.getElementById('ojeadoPrecio').value,
            document.getElementById('ojeadoNegociado').value,
            document.getElementById('ojeadoTelefono').value,
            document.getElementById('ojeadoEmail').value,
            document.getElementById('ojeadoEstado').value,
            document.getElementById('ojeadoNotas').value,
            new Date().toISOString().split('T')[0]
        ];
        
        try {
            if (row) {
                await writeRow('ojeados', row, data);
            } else {
                await appendRow('ojeados', data);
            }
            toast('Ojeado guardado', 'success');
            cerrarModal('modalOjeado');
            cache.ojeados = await readSheetData('ojeados');
            renderOjeados();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }
    
    async function eliminarOjeado(id, row) {
        if (!confirm('¬øEliminar ojeado ' + id + '?')) return;
        try {
            await deleteRow('ojeados', row);
            toast('Ojeado eliminado', 'success');
            cache.ojeados = await readSheetData('ojeados');
            renderOjeados();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }

    // ================================================
    // CHAT CON USUARIOS
    // ================================================
    let chatActivo = null;
    
    async function cargarChats() {
        const list = document.getElementById('chatList');
        if (!list) return;
        
        // Recargar desde Sheets
        cache.chat = await readSheetData('chat').catch(() => []);
        let chats = cache.chat || [];
        
        // Filtrar mensajes ocultos para admin
        chats = chats.filter(msg => msg.oculto_admin !== true && msg.oculto_admin !== 'TRUE');
        
        if (chats.length === 0) {
            list.innerHTML = '<p class="empty-state" style="padding:20px;text-align:center;color:#9ca3af;">No hay conversaciones</p>';
            setBadge('badgeChat', 0);
            return;
        }
        
        // Agrupar por usuario
        const chatsPorUsuario = {};
        chats.forEach((msg, idx) => {
            const odoo = msg.usuario_id || msg.email || 'anon';
            if (!chatsPorUsuario[odoo]) {
                chatsPorUsuario[odoo] = {
                    usuario_id: msg.usuario_id,
                    usuario_pseudo: msg.usuario_pseudo || msg.email || 'Usuario',
                    usuario_email: msg.email,
                    mensajes: [],
                    sin_leer: false,
                    ultimo_mensaje: '',
                    fecha: ''
                };
            }
            chatsPorUsuario[odoo].mensajes.push({
                id: msg.id,
                row: idx + 2,
                tipo: msg.tipo || 'user',
                texto: msg.mensaje,
                fecha: msg.fecha,
                leido: msg.leido === true || msg.leido === 'TRUE'
            });
            if ((msg.tipo === 'user' || !msg.tipo) && msg.leido !== true && msg.leido !== 'TRUE') {
                chatsPorUsuario[odoo].sin_leer = true;
            }
            chatsPorUsuario[odoo].ultimo_mensaje = msg.mensaje;
            chatsPorUsuario[odoo].fecha = msg.fecha;
        });
        
        // Convertir a array
        cache.chatAgrupado = Object.values(chatsPorUsuario);
        
        list.innerHTML = cache.chatAgrupado.map((chat, idx) => `
            <div class="chat-list-item ${chat.sin_leer ? 'unread' : ''} ${chatActivo === idx ? 'active' : ''}" onclick="seleccionarChat(${idx})">
                <h4>${escapeHTML(chat.usuario_pseudo)} ${chat.sin_leer ? '<span class="badge-unread">Nuevo</span>' : ''}</h4>
                <p>${escapeHTML((chat.ultimo_mensaje || '').substring(0, 50))}${chat.ultimo_mensaje?.length > 50 ? '...' : ''}</p>
                <span class="time">${escapeHTML(chat.fecha || '')}</span>
            </div>
        `).join('');
        
        // Actualizar badge usando setBadge
        const sinLeer = cache.chatAgrupado.filter(c => c.sin_leer).length;
        setBadge('badgeChat', sinLeer);
        
        // Actualizar dashboard de acciones pendientes y badges del men√∫
        actualizarDashboardPendientes();
        actualizarBadgesMenu();
    }
    
    async function seleccionarChat(idx) {
        chatActivo = idx;
        const chat = cache.chatAgrupado?.[idx];
        if (!chat) return;
        
        // Actualizar lista para marcar como activo
        document.querySelectorAll('.chat-list-item').forEach((item, i) => {
            item.classList.toggle('active', i === idx);
        });
        
        // Actualizar header
        const title = document.getElementById('chatDetailTitle');
        if (title) {
            title.innerHTML = `<strong>${escapeHTML(chat.usuario_pseudo || 'Usuario')}</strong> - ${escapeHTML(chat.usuario_email || '')}`;
        }
        
        // Mostrar botones de acciones
        const actions = document.getElementById('chatActions');
        if (actions) actions.style.display = 'flex';
        
        // Mostrar mensajes
        const container = document.getElementById('chatDetailMessages');
        if (container && chat.mensajes) {
            // Agrupar por fecha estilo WhatsApp
            let lastDate = '';
            let html = '';
            
            chat.mensajes.forEach(msg => {
                const fechaCompleta = msg.fecha || '';
                let fecha = '';
                let hora = '';
                
                // Buscar patr√≥n de hora HH:MM
                const horaMatch = fechaCompleta.match(/(\d{1,2}):(\d{2})/);
                if (horaMatch) {
                    hora = horaMatch[1].padStart(2, '0') + ':' + horaMatch[2];
                }
                
                // Buscar patr√≥n de fecha DD/MM/YYYY
                const fechaMatch = fechaCompleta.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                if (fechaMatch) {
                    fecha = fechaMatch[1];
                }
                
                if (fecha && fecha !== lastDate) {
                    html += '<div style="text-align:center;margin:12px 0;"><span style="background:#e5e7eb;color:#6b7280;font-size:11px;padding:4px 12px;border-radius:12px;">' + escapeHTML(fecha) + '</span></div>';
                    lastDate = fecha;
                }
                
                html += `
                    <div class="chat-msg ${escapeHTML(msg.tipo)}">
                        <div class="bubble">${escapeHTML(msg.texto)}<span style="font-size:10px;opacity:0.7;margin-left:10px;float:right;">${escapeHTML(hora)}</span></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        // Mostrar input
        const inputArea = document.getElementById('chatDetailInput');
        if (inputArea) inputArea.style.display = 'block';
        
        // Marcar mensajes como le√≠dos en Sheets
        if (chat.sin_leer) {
            for (const msg of chat.mensajes) {
                if (!msg.leido && msg.tipo === 'user') {
                    try {
                        await marcarMensajeLeido(msg.row);
                    } catch(e) { console.error('Error marcando le√≠do:', e); }
                }
            }
            chat.sin_leer = false;
            cargarChats();
        }
    }
    
    async function marcarMensajeLeido(row) {
        // Columna G = leido
        await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+SHEET_ID+'/values/chat!G'+row+'?valueInputOption=USER_ENTERED', {
            method: 'PUT',
            headers: {'Authorization':'Bearer '+token, 'Content-Type':'application/json'},
            body: JSON.stringify({values:[['TRUE']]})
        });
    }
    
    async function enviarRespuestaChat() {
        if (chatActivo === null) return;
        
        const input = document.getElementById('chatAdminInput');
        const mensaje = input?.value.trim();
        if (!mensaje) return;
        
        try {
            const chat = cache.chatAgrupado[chatActivo];
            const newId = Date.now();
            const fecha = new Date().toLocaleString('es-ES');
            
            // Guardar en Google Sheets via AppsScript
            const formData = new URLSearchParams();
            formData.append('action', 'appendRow');
            formData.append('sheet', 'chat');
            formData.append('data', JSON.stringify([
                newId,
                chat.usuario_id || '',
                'Admin',
                '',
                mensaje,
                fecha,
                'TRUE',
                'admin'
            ]));
            
            const resp = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await resp.json();
            if (!result.success) throw new Error(result.message);
            
            input.value = '';
            toast('Respuesta enviada', 'success');
            await cargarChats();
            seleccionarChat(chatActivo);
        } catch(e) {
            console.error('Error enviando respuesta:', e);
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Borrar chat solo para admin (marcar como oculto_admin)
    async function borrarChatAdmin() {
        if (chatActivo === null) return;
        if (!confirm('¬øBorrar esta conversaci√≥n solo para ti (admin)? El usuario seguir√° vi√©ndola.')) return;
        
        const chat = cache.chatAgrupado[chatActivo];
        try {
            // Marcar todos los mensajes de este usuario como ocultos para admin
            for (const msg of chat.mensajes) {
                await updateCell('chat', msg.row, 9, 'TRUE'); // Columna I = oculto_admin
            }
            toast('Chat ocultado para admin', 'success');
            chatActivo = null;
            document.getElementById('chatActions').style.display = 'none';
            document.getElementById('chatDetailTitle').innerHTML = 'Selecciona una conversaci√≥n';
            document.getElementById('chatDetailMessages').innerHTML = '<p class="empty-state">Selecciona un usuario para ver la conversaci√≥n</p>';
            document.getElementById('chatDetailInput').style.display = 'none';
            await cargarChats();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Borrar chat solo para usuario (marcar como oculto_usuario)
    async function borrarChatUsuario() {
        if (chatActivo === null) return;
        if (!confirm('¬øBorrar esta conversaci√≥n solo para el usuario? T√∫ seguir√°s vi√©ndola.')) return;
        
        const chat = cache.chatAgrupado[chatActivo];
        try {
            for (const msg of chat.mensajes) {
                await updateCell('chat', msg.row, 10, 'TRUE'); // Columna J = oculto_usuario
            }
            toast('Chat ocultado para usuario', 'success');
            await cargarChats();
            seleccionarChat(chatActivo);
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Borrar chat para ambos (eliminar filas)
    async function borrarChatAmbos() {
        if (chatActivo === null) return;
        if (!confirm('‚ö†Ô∏è ¬øELIMINAR PERMANENTEMENTE esta conversaci√≥n para AMBOS? Esta acci√≥n no se puede deshacer.')) return;
        
        const chat = cache.chatAgrupado[chatActivo];
        try {
            // Borrar filas de mayor a menor para no afectar √≠ndices
            const rowsToDelete = chat.mensajes.map(m => m.row).sort((a,b) => b - a);
            
            for (const row of rowsToDelete) {
                await deleteRow('chat', row);
            }
            
            toast('Conversaci√≥n eliminada', 'success');
            chatActivo = null;
            document.getElementById('chatActions').style.display = 'none';
            document.getElementById('chatDetailTitle').innerHTML = 'Selecciona una conversaci√≥n';
            document.getElementById('chatDetailMessages').innerHTML = '<p class="empty-state">Selecciona un usuario para ver la conversaci√≥n</p>';
            document.getElementById('chatDetailInput').style.display = 'none';
            await cargarChats();
        } catch(e) {
            toast('Error: ' + e.message, 'error');
        }
    }
    
    // Funci√≥n auxiliar para actualizar una celda
    async function updateCell(sheet, row, col, value) {
        const colLetter = String.fromCharCode(64 + col); // 1=A, 2=B, etc.
        const range = `${sheet}!${colLetter}${row}`;
        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`, {
            method: 'PUT',
            headers: {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'},
            body: JSON.stringify({values: [[value]]})
        });
    }
    
    // Obtener ID de hoja por nombre
    async function getSheetId(sheetName) {
        const resp = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?fields=sheets.properties`, {
            headers: {'Authorization': 'Bearer ' + token}
        });
        const data = await resp.json();
        const sheet = data.sheets?.find(s => s.properties.title === sheetName);
        return sheet?.properties?.sheetId || 0;
    }
    
    // PWA Service Worker - Desactivado temporalmente
    /*
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                })
                .catch((error) => {
                    console.log('‚ùå Error registrando Service Worker:', error);
                });
        });
    }
    */

    // ========== FACTURACION ==========
    var factLineasCount = 0;
    var factVehiculosSeleccionados = [];
    
    function fmtDateDMY(d) { if(!d)return""; var dt=new Date(d); return String(dt.getDate()).padStart(2,"0")+"-"+String(dt.getMonth()+1).padStart(2,"0")+"-"+dt.getFullYear(); }
    
    function abrirModalFactura() { console.log("Abriendo modal factura..."); var modal = document.getElementById("modalFactura"); console.log("Modal element:", modal); if(modal) { modal.classList.add("active"); console.log("Clase active a√±adida"); console.log("Classes:", modal.className); }
        document.getElementById("factFecha").value = new Date().toISOString().split("T")[0];
        document.getElementById("factNumVehiculos").value = "1";
        document.getElementById("factLineas").innerHTML = "";
        document.getElementById("factIngles").checked = false;
        factLineasCount = 0;
        factVehiculosSeleccionados = [];
        generarSelectoresVehiculos();
        calcularTotalesFactura();
        abrirModal("modalFactura");
    }
    
    function generarSelectoresVehiculos() {
        var num = parseInt(document.getElementById("factNumVehiculos").value) || 0;
        var container = document.getElementById("factVehiculosContainer");
        container.innerHTML = "";
        factVehiculosSeleccionados = [];
        document.getElementById("factLineas").innerHTML = "";
        factLineasCount = 0;
        
        for (var i = 0; i < num; i++) {
            var html = "<div class=\"form-group\" style=\"margin:0;\"><label style=\"font-size:11px;\">Vehiculo " + (i+1) + "</label><select id=\"factVeh" + i + "\" onchange=\"onVehiculoSeleccionado()\" style=\"padding:6px;width:100%;\"><option value=\"\">(Seleccionar)</option>";
            var vehs = cache.vehiculos || [];
            for (var j = 0; j < vehs.length; j++) { var v = vehs[j]; html += "<option value=\"V-"+escapeHTML(v.id)+"\">"+escapeHTML(v.id)+" - "+escapeHTML(v.marca||"")+" "+escapeHTML(v.modelo||"")+" ("+escapeHTML(v.matricula||"")+")</option>"; }
            var inters = cache.intermediacion || [];
            for (var k = 0; k < inters.length; k++) { var m = inters[k]; html += "<option value=\"I-"+escapeHTML(m.id)+"\">"+escapeHTML(m.id)+" - "+escapeHTML(m.marca||"")+" "+escapeHTML(m.modelo||"")+" ("+escapeHTML(m.matricula||"")+")</option>"; }
            var hist = cache.historico || [];
            for (var l = 0; l < hist.length; l++) { var h = hist[l]; html += "<option value=\"H-"+escapeHTML(h.id)+"\">"+escapeHTML(h.id)+" - "+escapeHTML(h.marca||"")+" "+escapeHTML(h.modelo||"")+" ("+escapeHTML(h.matricula||"") + ") [H]</option>"; }
            html += "</select></div>";
            container.insertAdjacentHTML("beforeend", html);
            agregarLineaFactura();
        }
        if (num === 0) agregarLineaFactura();
        actualizarNumeroFactura();
    }
    
    function onVehiculoSeleccionado() {
        factVehiculosSeleccionados = [];
        var num = parseInt(document.getElementById("factNumVehiculos").value) || 0;
        for (var i = 0; i < num; i++) {
            var sel = document.getElementById("factVeh" + i);
            if (sel && sel.value) {
                var veh = obtenerVehiculoPorId(sel.value);
                if (veh) factVehiculosSeleccionados.push(veh);
            }
        }
        actualizarConceptosVehiculos();
        actualizarNumeroFactura();
    }
    
    function obtenerVehiculoPorId(idStr) {
        if (!idStr) return null;
        var parts = idStr.split("-");
        var prefix = parts[0];
        var id = parts[1];
        var lista = prefix === "V" ? cache.vehiculos : (prefix === "I" ? cache.intermediacion : cache.historico);
        for (var i = 0; i < lista.length; i++) { if (lista[i].id == id) return lista[i]; }
        return null;
    }
    
    function actualizarNumeroFactura() {
        var year = new Date().getFullYear();
        var ids = [];
        var num = parseInt(document.getElementById("factNumVehiculos").value) || 0;
        for (var i = 0; i < num; i++) {
            var sel = document.getElementById("factVeh" + i);
            if (sel && sel.value) { var id = sel.value.split("-")[1]; if (id) ids.push(id); }
        }
        document.getElementById("factNumero").value = ids.length > 0 ? year + ids.join("-") : "";
    }
    
    function actualizarConceptosVehiculos() {
        var lineas = document.getElementById("factLineas").children;
        for (var i = 0; i < lineas.length && i < factVehiculosSeleccionados.length; i++) {
            var lid = lineas[i].id.replace("factLinea", "");
            var veh = factVehiculosSeleccionados[i];
            var razonEl = document.getElementById("factRazon" + lid);
            if (razonEl && veh) {
                razonEl.value = [(veh.subcategoria||""), (veh.tipo||""), (veh.marca||""), (veh.matricula||"")].filter(Boolean).join(" ");
            }
        }
    }
    
    function agregarLineaFactura() {
        factLineasCount++;
        var id = factLineasCount;
        var html = "<div id=\"factLinea"+id+"\" style=\"display:grid;grid-template-columns:90px 1fr 55px 85px 75px 55px 75px 28px;gap:4px;margin-bottom:8px;align-items:center;\">";
        html += "<select id=\"factTrans"+id+"\" style=\"padding:5px;font-size:11px;\"><option value=\"Venta\">Venta</option><option value=\"Alquiler\">Alquiler</option><option value=\"Servicio\">Servicio</option><option value=\"Reserva\">Reserva</option><option value=\"Otro\">Otro</option></select>";
        html += "<input type=\"text\" id=\"factRazon"+id+"\" style=\"padding:5px;font-size:11px;\" placeholder=\"Concepto\">";
        html += "<input type=\"number\" id=\"factCant"+id+"\" value=\"1\" min=\"1\" style=\"padding:5px;font-size:11px;text-align:center;\" onchange=\"calcularTotalesFactura()\">";
        html += "<input type=\"number\" id=\"factPrecio"+id+"\" value=\"0\" step=\"0.01\" style=\"padding:5px;font-size:11px;text-align:right;\" onchange=\"calcularTotalesFactura()\">";
        html += "<input type=\"text\" id=\"factImp"+id+"\" readonly style=\"padding:5px;font-size:11px;text-align:right;background:#f3f4f6;\">";
        html += "<input type=\"number\" id=\"factIVA"+id+"\" value=\"21\" style=\"padding:5px;font-size:11px;text-align:center;\" onchange=\"calcularTotalesFactura()\">";
        html += "<input type=\"text\" id=\"factSub"+id+"\" readonly style=\"padding:5px;font-size:11px;text-align:right;background:#e8f5e9;font-weight:600;\">";
        html += "<button type=\"button\" onclick=\"eliminarLineaFactura("+id+")\" style=\"background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 6px;cursor:pointer;font-size:12px;\">√ó</button>";
        html += "</div>";
        document.getElementById("factLineas").insertAdjacentHTML("beforeend", html);
        calcularTotalesFactura();
    }
    
    function eliminarLineaFactura(id) { var el = document.getElementById("factLinea" + id); if (el) el.remove(); calcularTotalesFactura(); }
    
    function calcularTotalesFactura() {
        var subtotal = 0, totalIva = 0, pagado = 0;
        var lineas = document.getElementById("factLineas").children;
        for (var i = 0; i < lineas.length; i++) {
            var lid = lineas[i].id.replace("factLinea", "");
            var cant = parseFloat(document.getElementById("factCant" + lid)?.value) || 0;
            var precio = parseFloat(document.getElementById("factPrecio" + lid)?.value) || 0;
            var iva = parseFloat(document.getElementById("factIVA" + lid)?.value) || 0;
            var trans = document.getElementById("factTrans" + lid)?.value || "";
            var importe = cant * precio;
            var ivaAmt = importe * iva / 100;
            var sub = importe + ivaAmt;
            document.getElementById("factImp" + lid).value = importe.toFixed(2);
            document.getElementById("factSub" + lid).value = sub.toFixed(2);
            subtotal += importe;
            totalIva += ivaAmt;
            if (trans === "Reserva") pagado += sub;
        }
        var total = subtotal + totalIva;
        document.getElementById("factSubtotal").textContent = subtotal.toFixed(2) + " EUR";
        document.getElementById("factIVATotal").textContent = totalIva.toFixed(2) + " EUR";
        document.getElementById("factTotal").textContent = total.toFixed(2) + " EUR";
        document.getElementById("factPagado").textContent = pagado.toFixed(2) + " EUR";
        document.getElementById("factTotalPagar").textContent = (total - pagado).toFixed(2) + " EUR";
    }
    
    function generarFacturaPDF() {
        var esIngles = document.getElementById("factIngles").checked;
        var doc = new jspdf.jsPDF("p", "mm", "a4");
        var txt = esIngles ? { factura:"INVOICE",num:"No:",fecha:"Date:",facturadoA:"Bill to:",cond:"Terms:",tipo:"Type",concepto:"Description",cant:"Qty",precio:"Price/Unit",importe:"Amount",iva:"VAT",subtotalL:"Subtotal",subtotal:"Subtotal:",ivaT:"VAT:",total:"Total:",pagado:"Paid:",aPagar:"AMOUNT DUE:",pago:"Payment:",banco:"Bank:",cuenta:"Account:" } : { factura:"FACTURA",num:"N¬∫:",fecha:"Fecha:",facturadoA:"Facturado a:",cond:"Condiciones:",tipo:"Tipo",concepto:"Concepto",cant:"Cant.",precio:"Precio/Ud",importe:"Importe",iva:"IVA",subtotalL:"Subtotal",subtotal:"Subtotal:",ivaT:"IVA:",total:"Total:",pagado:"Pagado:",aPagar:"TOTAL A PAGAR:",pago:"Forma de pago:",banco:"Banco:",cuenta:"IBAN:" };
        
        var logoUrl = document.getElementById("factLogoUrl").value;
        if (logoUrl) {
            var img = new Image(); img.crossOrigin = "anonymous";
            img.onload = function() { try { var c = document.createElement("canvas"); c.width = img.width; c.height = img.height; c.getContext("2d").drawImage(img,0,0); dibujarFacturaPDF(doc, txt, esIngles, c.toDataURL("image/png")); } catch(e) { dibujarFacturaPDF(doc, txt, esIngles, null); } };
            img.onerror = function() { dibujarFacturaPDF(doc, txt, esIngles, null); };
            img.src = logoUrl;
        } else { dibujarFacturaPDF(doc, txt, esIngles, null); }
    }
    
    function dibujarFacturaPDF(doc, txt, esIngles, logoData) {
        doc.setFillColor(15, 42, 46); doc.rect(0, 0, 210, 55, "F");
        var logoH = 12;
        if (logoData) { try { doc.addImage(logoData, "PNG", 14, 5, 60, logoH); } catch(e) {} }
        doc.setTextColor(255,255,255); doc.setFontSize(10);
        doc.text(document.getElementById("factEmpresa").value, 14, 22);
        doc.setFontSize(9);
        doc.text("NIF: " + document.getElementById("factEmpresaNIF").value, 14, 28);
        doc.text(document.getElementById("factEmpresaDir1").value, 14, 34);
        doc.text(document.getElementById("factEmpresaDir2").value, 14, 40);
        doc.text(document.getElementById("factEmpresaDir3").value, 14, 46);
        doc.setFontSize(18); doc.text(txt.factura, 195, 12, {align:"right"});
        doc.setFontSize(10);
        doc.text(txt.num + " " + document.getElementById("factNumero").value, 195, 20, {align:"right"});
        doc.text(txt.fecha + " " + fmtDateDMY(document.getElementById("factFecha").value), 195, 27, {align:"right"});
        
        doc.setTextColor(0,0,0); doc.setFontSize(11); doc.text(txt.facturadoA, 14, 65);
        doc.setFontSize(10);
        doc.text(document.getElementById("factClienteNombre").value || "", 14, 72);
        doc.text(document.getElementById("factClienteDir1").value || "", 14, 78);
        doc.text(document.getElementById("factClienteDir2").value || "", 14, 84);
        doc.text(document.getElementById("factClienteDir3").value || "", 14, 90);
        doc.text(document.getElementById("factClienteTipoDoc").value + ": " + document.getElementById("factClienteDoc").value, 14, 96);
        var cond = document.getElementById("factCondiciones").value;
        if (cond) doc.text(txt.cond + " " + cond, 14, 102);
        
        var lineas = document.getElementById("factLineas").children;
        var tableData = [];
        for (var i = 0; i < lineas.length; i++) {
            var lid = lineas[i].id.replace("factLinea", "");
            var trans = document.getElementById("factTrans" + lid)?.value || "";
            var razon = document.getElementById("factRazon" + lid)?.value || "";
            var cant = document.getElementById("factCant" + lid)?.value || "1";
            var precio = document.getElementById("factPrecio" + lid)?.value || "0";
            var importe = document.getElementById("factImp" + lid)?.value || "0";
            var iva = document.getElementById("factIVA" + lid)?.value || "21";
            var sub = document.getElementById("factSub" + lid)?.value || "0";
            tableData.push([trans, razon, cant, precio+" EUR", importe+" EUR", iva+"%", sub+" EUR"]);
        }
        doc.autoTable({ head:[[txt.tipo,txt.concepto,txt.cant,txt.precio,txt.importe,txt.iva,txt.subtotalL]], body:tableData, startY:cond?110:105, styles:{fontSize:8,cellPadding:2}, headStyles:{fillColor:[15,42,46]}, columnStyles:{0:{cellWidth:20},2:{cellWidth:12,halign:"center"},3:{cellWidth:22,halign:"right"},4:{cellWidth:20,halign:"right"},5:{cellWidth:14,halign:"center"},6:{cellWidth:22,halign:"right"}} });
        
        var fY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        doc.text(txt.pago + " " + document.getElementById("factMetodoPago").value, 14, fY);
        doc.text(txt.banco + " " + document.getElementById("factBanco").value, 14, fY+6);
        doc.text(txt.cuenta + " " + document.getElementById("factCuenta").value, 14, fY+12);
        
        doc.text(txt.subtotal, 140, fY); doc.text(document.getElementById("factSubtotal").textContent, 195, fY, {align:"right"});
        doc.text(txt.ivaT, 140, fY+6); doc.text(document.getElementById("factIVATotal").textContent, 195, fY+6, {align:"right"});
        doc.line(140, fY+9, 195, fY+9);
        doc.setFontSize(11); doc.text(txt.total, 140, fY+15); doc.text(document.getElementById("factTotal").textContent, 195, fY+15, {align:"right"});
        var pag = document.getElementById("factPagado").textContent;
        var oY = fY + 18;
        if (pag !== "0.00 EUR") { doc.setFontSize(10); doc.text(txt.pagado, 140, oY); doc.text(pag, 195, oY, {align:"right"}); oY += 6; }
        doc.setFillColor(15,42,46); doc.rect(138, oY, 59, 10, "F");
        doc.setTextColor(255,255,255); doc.setFontSize(10);
        doc.text(txt.aPagar, 140, oY+7); doc.text(document.getElementById("factTotalPagar").textContent, 193, oY+7, {align:"right"});
        
        doc.setFillColor(15,42,46); doc.rect(0, 282, 210, 15, "F");
        doc.setTextColor(255,255,255); doc.setFontSize(9);
        doc.text(document.getElementById("factTelefono").value || "", 14, 290);
        doc.text(document.getElementById("factEmail").value || "", 105, 290, {align:"center"});
        doc.text(document.getElementById("factWeb").value || "TANKIBERICA.COM", 196, 290, {align:"right"});
        
        doc.save("Factura_" + document.getElementById("factNumero").value + ".pdf");
        toast(esIngles ? "Invoice generated" : "Factura generada", "success");
    }


    // ========== BALANCE MEJORADO ==========
    var chartRazon = null, chartSubcat = null;
    
    function poblarFiltroSubcategorias() {
        var data = cache.balance || [];
        var subcats = [];
        for (var i = 0; i < data.length; i++) {
            var s = data[i].subcategoria;
            if (s && subcats.indexOf(s) < 0) subcats.push(s);
        }
        subcats.sort();
        var sel = document.getElementById("balanceSubcatFilter");
        if (sel) {
            var cv = sel.value;
            sel.innerHTML = "<option value=\"\">Subcategor√≠a</option>";
            for (var j = 0; j < subcats.length; j++) {
                sel.innerHTML += "<option value=\"" + escapeHTML(subcats[j]) + "\"" + (cv === subcats[j] ? " selected" : "") + ">" + escapeHTML(subcats[j]) + "</option>";
            }
        }
    }
    
    function toggleGraficos() {
        var show = document.getElementById("toggleGraficos").checked;
        document.getElementById("balanceGraficos").style.display = show ? "block" : "none";
        if (show) renderGraficos();
    }
    
    function renderGraficos() {
        var tipo = document.getElementById("tipoGrafico").value;
        var data = getBalanceFiltrado();
        renderChartRazon(data, tipo);
        renderChartSubcat(data, tipo);
    }
    
    function getBalanceFiltrado() {
        var data = cache.balance || [];
        var year = document.getElementById("balanceYearFilter").value;
        var tipoF = document.getElementById("balanceTipoFilter").value;
        var razon = document.getElementById("balanceRazonFilter").value;
        var estado = document.getElementById("balanceEstadoFilter").value;
        var subcat = document.getElementById("balanceSubcatFilter") ? document.getElementById("balanceSubcatFilter").value : "";
        if (year) data = data.filter(function(b) { return b.fecha && new Date(b.fecha).getFullYear() == year; });
        if (tipoF) data = data.filter(function(b) { return b.tipo === tipoF; });
        if (razon) data = data.filter(function(b) { return b.razon === razon; });
        if (estado) data = data.filter(function(b) { return b.estado === estado; });
        if (subcat) data = data.filter(function(b) { return b.subcategoria === subcat; });
        return data;
    }
    
    function renderChartRazon(data, tipo) {
        var ctx = document.getElementById("chartRazon");
        if (!ctx) return;
        var porRazon = {};
        for (var i = 0; i < data.length; i++) {
            var b = data[i];
            var r = b.razon || "Otros";
            if (!porRazon[r]) porRazon[r] = { ing: 0, gas: 0 };
            var imp = parseFloat(b.importe) || 0;
            if (b.tipo === "ingreso") porRazon[r].ing += imp;
            else porRazon[r].gas += imp;
        }
        var labels = Object.keys(porRazon);
        var ingresos = [], gastos = [];
        for (var j = 0; j < labels.length; j++) {
            ingresos.push(porRazon[labels[j]].ing);
            gastos.push(porRazon[labels[j]].gas);
        }
        if (chartRazon) chartRazon.destroy();
        if (tipo === "pie") {
            var netos = [];
            for (var k = 0; k < labels.length; k++) netos.push(ingresos[k] - gastos[k]);
            chartRazon = new Chart(ctx, { type: "pie", data: { labels: labels, datasets: [{ data: netos.map(Math.abs), backgroundColor: labels.map(function(_, i) { return "hsl(" + (i * 360 / labels.length) + ",70%,60%)"; }) }] } });
        } else {
            chartRazon = new Chart(ctx, { type: "bar", data: { labels: labels, datasets: [{ label: "Ingresos", data: ingresos, backgroundColor: "#22c55e" }, { label: "Gastos", data: gastos, backgroundColor: "#ef4444" }] } });
        }
    }
    
    function renderChartSubcat(data, tipo) {
        var ctx = document.getElementById("chartSubcat");
        if (!ctx) return;
        var porSubcat = {};
        for (var i = 0; i < data.length; i++) {
            var b = data[i];
            var s = b.subcategoria || "Sin cat";
            if (!porSubcat[s]) porSubcat[s] = { ing: 0, cost: 0 };
            if (b.tipo === "ingreso") {
                porSubcat[s].ing += parseFloat(b.importe) || 0;
                porSubcat[s].cost += parseFloat(b.coste_asociado) || 0;
            }
        }
        var labels = Object.keys(porSubcat);
        var pcts = [];
        for (var j = 0; j < labels.length; j++) {
            var ing = porSubcat[labels[j]].ing;
            var cost = porSubcat[labels[j]].cost;
            pcts.push(cost > 0 ? ((ing - cost) / cost * 100) : 0);
        }
        if (chartSubcat) chartSubcat.destroy();
        if (tipo === "pie") {
            chartSubcat = new Chart(ctx, { type: "pie", data: { labels: labels, datasets: [{ data: pcts.map(Math.abs), backgroundColor: labels.map(function(_, i) { return "hsl(" + (120 + i * 30) + ",60%,50%)"; }) }] } });
        } else {
            chartSubcat = new Chart(ctx, { type: "bar", data: { labels: labels, datasets: [{ label: "Beneficio %", data: pcts, backgroundColor: pcts.map(function(v) { return v >= 0 ? "#22c55e" : "#ef4444"; }) }] }, options: { plugins: { legend: { display: false } } } });
        }
    }

    
    // ========== EMOJI PICKER ==========
    let currentEmojiTarget = null;
    
    function toggleEmojiPicker(targetId) {
        const picker = document.getElementById('emojiPicker');
        const btn = event.currentTarget;
        
        if (picker.style.display === 'block' && currentEmojiTarget === targetId) {
            closeEmojiPicker();
            return;
        }
        
        currentEmojiTarget = targetId;
        const rect = btn.getBoundingClientRect();
        picker.style.top = (rect.bottom + 8) + 'px';
        picker.style.left = Math.max(10, Math.min(rect.left - 100, window.innerWidth - 360)) + 'px';
        picker.style.display = 'block';
    }
    
    function closeEmojiPicker() {
        document.getElementById('emojiPicker').style.display = 'none';
        currentEmojiTarget = null;
    }
    
    // Delegaci√≥n de eventos para los botones de emoji
    document.addEventListener('DOMContentLoaded', function() {
        const picker = document.getElementById('emojiPicker');
        if (picker) {
            picker.addEventListener('click', function(e) {
                const btn = e.target.closest('.emoji-btn');
                if (btn && currentEmojiTarget) {
                    const emoji = btn.dataset.emoji;
                    const input = document.getElementById(currentEmojiTarget);
                    if (input) {
                        const start = input.selectionStart || input.value.length;
                        const end = input.selectionEnd || input.value.length;
                        input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
                        input.focus();
                        const newPos = start + emoji.length;
                        input.setSelectionRange(newPos, newPos);
                    }
                    closeEmojiPicker();
                }
            });
        }
    });
    
    // Cerrar picker al hacer clic fuera
    document.addEventListener('click', function(e) {
        const picker = document.getElementById('emojiPicker');
        if (picker && picker.style.display === 'block') {
            if (!picker.contains(e.target) && !e.target.closest('[onclick*="toggleEmojiPicker"]')) {
                closeEmojiPicker();
            }
        }
    });

    </script>

    


    <!-- Emoji Picker Modal -->
    <div id="emojiPicker" class="emoji-picker-container">
        <div class="emoji-picker-header">
            <span>Seleccionar emoji</span>
            <button onclick="closeEmojiPicker()" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>
        </div>
        <div class="emoji-grid">
            <!-- Veh√≠culos y Transporte -->
            <span class="emoji-btn" data-emoji="üöö">üöö</span>
            <span class="emoji-btn" data-emoji="üöõ">üöõ</span>
            <span class="emoji-btn" data-emoji="üöê">üöê</span>
            <span class="emoji-btn" data-emoji="üöå">üöå</span>
            <span class="emoji-btn" data-emoji="üöç">üöç</span>
            <span class="emoji-btn" data-emoji="üöé">üöé</span>
            <span class="emoji-btn" data-emoji="üöó">üöó</span>
            <span class="emoji-btn" data-emoji="üöï">üöï</span>
            <span class="emoji-btn" data-emoji="üèéÔ∏è">üèéÔ∏è</span>
            <span class="emoji-btn" data-emoji="üöú">üöú</span>
            <!-- Maquinaria y Log√≠stica -->
            <span class="emoji-btn" data-emoji="üèóÔ∏è">üèóÔ∏è</span>
            <span class="emoji-btn" data-emoji="‚öôÔ∏è">‚öôÔ∏è</span>
            <span class="emoji-btn" data-emoji="üîß">üîß</span>
            <span class="emoji-btn" data-emoji="üî©">üî©</span>
            <span class="emoji-btn" data-emoji="üõ†Ô∏è">üõ†Ô∏è</span>
            <span class="emoji-btn" data-emoji="‚õΩ">‚õΩ</span>
            <span class="emoji-btn" data-emoji="üõ¢Ô∏è">üõ¢Ô∏è</span>
            <span class="emoji-btn" data-emoji="üì¶">üì¶</span>
            <span class="emoji-btn" data-emoji="üè≠">üè≠</span>
            <span class="emoji-btn" data-emoji="üöß">üöß</span>
            <!-- Tr√°fico y Se√±ales -->
            <span class="emoji-btn" data-emoji="üö¶">üö¶</span>
            <span class="emoji-btn" data-emoji="üö•">üö•</span>
            <span class="emoji-btn" data-emoji="üõë">üõë</span>
            <span class="emoji-btn" data-emoji="‚õî">‚õî</span>
            <span class="emoji-btn" data-emoji="üö´">üö´</span>
            <span class="emoji-btn" data-emoji="üõ£Ô∏è">üõ£Ô∏è</span>
            <span class="emoji-btn" data-emoji="üõ§Ô∏è">üõ§Ô∏è</span>
            <span class="emoji-btn" data-emoji="üó∫Ô∏è">üó∫Ô∏è</span>
            <span class="emoji-btn" data-emoji="üß≠">üß≠</span>
            <span class="emoji-btn" data-emoji="üìç">üìç</span>
            <!-- Leyes y Documentos -->
            <span class="emoji-btn" data-emoji="üìã">üìã</span>
            <span class="emoji-btn" data-emoji="üìÑ">üìÑ</span>
            <span class="emoji-btn" data-emoji="üìù">üìù</span>
            <span class="emoji-btn" data-emoji="üìë">üìë</span>
            <span class="emoji-btn" data-emoji="üóÇÔ∏è">üóÇÔ∏è</span>
            <span class="emoji-btn" data-emoji="‚öñÔ∏è">‚öñÔ∏è</span>
            <span class="emoji-btn" data-emoji="üèõÔ∏è">üèõÔ∏è</span>
            <span class="emoji-btn" data-emoji="üìú">üìú</span>
            <span class="emoji-btn" data-emoji="‚úçÔ∏è">‚úçÔ∏è</span>
            <span class="emoji-btn" data-emoji="üîè">üîè</span>
            <!-- Alertas y Actualizaciones -->
            <span class="emoji-btn" data-emoji="üîî">üîî</span>
            <span class="emoji-btn" data-emoji="üì¢">üì¢</span>
            <span class="emoji-btn" data-emoji="üì£">üì£</span>
            <span class="emoji-btn" data-emoji="‚ö†Ô∏è">‚ö†Ô∏è</span>
            <span class="emoji-btn" data-emoji="üö®">üö®</span>
            <span class="emoji-btn" data-emoji="‚ùó">‚ùó</span>
            <span class="emoji-btn" data-emoji="‚ùì">‚ùì</span>
            <span class="emoji-btn" data-emoji="‚ÑπÔ∏è">‚ÑπÔ∏è</span>
            <span class="emoji-btn" data-emoji="üÜï">üÜï</span>
            <span class="emoji-btn" data-emoji="üÜô">üÜô</span>
            <!-- Dinero y Negocios -->
            <span class="emoji-btn" data-emoji="üí∞">üí∞</span>
            <span class="emoji-btn" data-emoji="üíµ">üíµ</span>
            <span class="emoji-btn" data-emoji="üí∂">üí∂</span>
            <span class="emoji-btn" data-emoji="üí≥">üí≥</span>
            <span class="emoji-btn" data-emoji="üè∑Ô∏è">üè∑Ô∏è</span>
            <span class="emoji-btn" data-emoji="ü§ù">ü§ù</span>
            <span class="emoji-btn" data-emoji="üìà">üìà</span>
            <span class="emoji-btn" data-emoji="üìâ">üìâ</span>
            <span class="emoji-btn" data-emoji="üíπ">üíπ</span>
            <span class="emoji-btn" data-emoji="üéØ">üéØ</span>
            <!-- Celebraci√≥n y Positivos -->
            <span class="emoji-btn" data-emoji="‚úÖ">‚úÖ</span>
            <span class="emoji-btn" data-emoji="‚ú®">‚ú®</span>
            <span class="emoji-btn" data-emoji="üéâ">üéâ</span>
            <span class="emoji-btn" data-emoji="üéä">üéä</span>
            <span class="emoji-btn" data-emoji="üèÜ">üèÜ</span>
            <span class="emoji-btn" data-emoji="‚≠ê">‚≠ê</span>
            <span class="emoji-btn" data-emoji="üåü">üåü</span>
            <span class="emoji-btn" data-emoji="üíØ">üíØ</span>
            <span class="emoji-btn" data-emoji="üî•">üî•</span>
            <span class="emoji-btn" data-emoji="üí™">üí™</span>
            <!-- Internacional -->
            <span class="emoji-btn" data-emoji="üåç">üåç</span>
            <span class="emoji-btn" data-emoji="üåé">üåé</span>
            <span class="emoji-btn" data-emoji="üåè">üåè</span>
            <span class="emoji-btn" data-emoji="üá™üá∏">üá™üá∏</span>
            <span class="emoji-btn" data-emoji="üá¨üáß">üá¨üáß</span>
            <span class="emoji-btn" data-emoji="üá™üá∫">üá™üá∫</span>
            <span class="emoji-btn" data-emoji="üá´üá∑">üá´üá∑</span>
            <span class="emoji-btn" data-emoji="üá©üá™">üá©üá™</span>
            <span class="emoji-btn" data-emoji="üáÆüáπ">üáÆüáπ</span>
            <span class="emoji-btn" data-emoji="üáµüáπ">üáµüáπ</span>
            <!-- Tiempo y Calendario -->
            <span class="emoji-btn" data-emoji="üìÖ">üìÖ</span>
            <span class="emoji-btn" data-emoji="üìÜ">üìÜ</span>
            <span class="emoji-btn" data-emoji="üóìÔ∏è">üóìÔ∏è</span>
            <span class="emoji-btn" data-emoji="‚è∞">‚è∞</span>
            <span class="emoji-btn" data-emoji="‚è≥">‚è≥</span>
            <span class="emoji-btn" data-emoji="üïê">üïê</span>
            <span class="emoji-btn" data-emoji="üìû">üìû</span>
            <span class="emoji-btn" data-emoji="üìß">üìß</span>
            <span class="emoji-btn" data-emoji="üí°">üí°</span>
            <span class="emoji-btn" data-emoji="üéÅ">üéÅ</span>
        </div>
    </div>
    <style>
        .emoji-picker-container {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 10001;
            width: 340px;
            max-height: 400px;
            overflow: hidden;
        }
        .emoji-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #eee;
            font-weight: 500;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            padding: 10px;
            max-height: 320px;
            overflow-y: auto;
        }
        .emoji-btn {
            font-size: 22px;
            padding: 6px;
            cursor: pointer;
            border-radius: 6px;
            text-align: center;
            transition: all 0.15s;
        }
        .emoji-btn:hover {
            background: #e0f2fe;
            transform: scale(1.15);
        }
    </style>

</body>
</html>
