name: Security Scan
# Nota: Este workflow hace análisis ESTÁTICO (SAST).
# Para análisis DINÁMICO contra producción, ver .github/workflows/dast-scan.yml
# SAST: Semgrep + npm audit (en cada PR y push a main)
# DAST: ZAP + Nuclei (semanal contra producción)
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1' # Cada lunes a las 6am

jobs:
  semgrep:
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4
      - run: semgrep scan --config auto --config p/typescript --config p/nodejs --config p/owasp-top-ten --error --json --output semgrep-results.json .
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm audit --audit-level=high

  # Snyk: Opción recomendada es conectar via web (snyk.io → GitHub integration).
  # Si prefieres CI, descomenta el job de abajo y configura SNYK_TOKEN como GitHub Secret.
  #
  # snyk:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #     - run: npm ci
  #     - uses: snyk/actions/node@master
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         args: --severity-threshold=high

  security-tests:
    runs-on: ubuntu-latest
    needs: [npm-audit]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run build
      - run: npx nuxi preview &
      - run: sleep 5
      - run: TEST_BASE_URL=http://localhost:3000 npx vitest run tests/security/
